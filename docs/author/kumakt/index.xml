<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Kumakt | Kumakt Memorandum</title>
    <link>/author/kumakt/</link>
      <atom:link href="/author/kumakt/index.xml" rel="self" type="application/rss+xml" />
    <description>Kumakt</description>
    <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator><language>en-us</language><lastBuildDate>Sun, 27 Sep 2020 15:38:38 +0900</lastBuildDate>
    <image>
      <url>/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_2.png</url>
      <title>Kumakt</title>
      <link>/author/kumakt/</link>
    </image>
    
    <item>
      <title>Tidyな医療系データ処理</title>
      <link>/post/tidy_imputation/</link>
      <pubDate>Sun, 27 Sep 2020 15:38:38 +0900</pubDate>
      <guid>/post/tidy_imputation/</guid>
      <description>
&lt;script src=&#34;../../rmarkdown-libs/htmlwidgets/htmlwidgets.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../../rmarkdown-libs/jquery/jquery.min.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../../rmarkdown-libs/datatables-css/datatables-crosstalk.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../../rmarkdown-libs/datatables-binding/datatables.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../../rmarkdown-libs/dt-core/css/jquery.dataTables.min.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;link href=&#34;../../rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../../rmarkdown-libs/dt-core/js/jquery.dataTables.min.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../../rmarkdown-libs/crosstalk/css/crosstalk.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../../rmarkdown-libs/crosstalk/js/crosstalk.min.js&#34;&gt;&lt;/script&gt;


&lt;div id=&#34;テーマ&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;テーマ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Tidyなデータ処理についてはWebに有用な情報がたくさんある。&lt;/li&gt;
&lt;li&gt;医療系のデータについて具体例がないため仮想データで解析してみる。&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div id=&#34;パッケージの読み込み&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;パッケージの読み込み&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(dplyr)
library(magrittr)
library(tidyverse)
library(broom)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データの作成&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;データの作成&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;架空データを作成：CKD患者さんにRAS阻害剤を投与した場合の１年後End_stage_CKDの有無を調べたデータ&lt;/li&gt;
&lt;li&gt;簡単のため時間は無視&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;set.seed(125) # 乱数の固定のシード
a &amp;lt;- rnorm(n = 200, mean = 140, sd = 10 )
b &amp;lt;- rnorm(n = 200, mean = 60, sd = 5 )
c &amp;lt;- rep(c(&amp;quot;A_hosp&amp;quot;,&amp;quot;B_hosp&amp;quot;),100)
d &amp;lt;- c( rep(&amp;quot;Stage4&amp;quot;,75), rep(&amp;quot;Stage3b&amp;quot;,70), rep(&amp;quot;Stage3a&amp;quot;,55))
e &amp;lt;- rbinom(200,1,0.6)
f &amp;lt;- rbinom(200,1,0.4)
g &amp;lt;- rbinom(200,1,0.25)
h &amp;lt;- rbinom(200,1,0.3)
study &amp;lt;- data.frame(a,b,c,d,e,f,g,h)
name  &amp;lt;- c(&amp;quot;SBP&amp;quot;, &amp;quot;Age&amp;quot;, &amp;quot;Hospital&amp;quot;,&amp;quot;CKD&amp;quot;,&amp;quot;Sex&amp;quot;,&amp;quot;RAS_inhibitor&amp;quot;,&amp;quot;DM&amp;quot;,&amp;quot;End_stage_CKD&amp;quot;) 
colnames(study) &amp;lt;- name&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;イメージとしては２つの病院でCKD3a以上の200人のデータを調べたデータ&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div id=&#34;data確認&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;data確認&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(study)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##       SBP             Age          Hospital        CKD          Sex       
##  Min.   :103.9   Min.   :46.52   A_hosp:100   Stage3a:55   Min.   :0.000  
##  1st Qu.:134.0   1st Qu.:55.69   B_hosp:100   Stage3b:70   1st Qu.:0.000  
##  Median :140.8   Median :59.28                Stage4 :75   Median :1.000  
##  Mean   :140.6   Mean   :59.42                             Mean   :0.645  
##  3rd Qu.:147.4   3rd Qu.:63.10                             3rd Qu.:1.000  
##  Max.   :164.8   Max.   :73.77                             Max.   :1.000  
##  RAS_inhibitor         DM       End_stage_CKD 
##  Min.   :0.000   Min.   :0.00   Min.   :0.00  
##  1st Qu.:0.000   1st Qu.:0.00   1st Qu.:0.00  
##  Median :0.000   Median :0.00   Median :0.00  
##  Mean   :0.415   Mean   :0.17   Mean   :0.24  
##  3rd Qu.:1.000   3rd Qu.:0.00   3rd Qu.:0.00  
##  Max.   :1.000   Max.   :1.00   Max.   :1.00&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;str(study)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    200 obs. of  8 variables:
##  $ SBP          : num  149 135 158 141 144 ...
##  $ Age          : num  63 64.1 56 54.4 62.7 ...
##  $ Hospital     : Factor w/ 2 levels &amp;quot;A_hosp&amp;quot;,&amp;quot;B_hosp&amp;quot;: 1 2 1 2 1 2 1 2 1 2 ...
##  $ CKD          : Factor w/ 3 levels &amp;quot;Stage3a&amp;quot;,&amp;quot;Stage3b&amp;quot;,..: 3 3 3 3 3 3 3 3 3 3 ...
##  $ Sex          : int  1 1 0 1 0 1 0 0 1 1 ...
##  $ RAS_inhibitor: int  1 1 1 0 0 1 1 1 1 1 ...
##  $ DM           : int  1 0 1 0 0 0 0 0 0 1 ...
##  $ End_stage_CKD: int  0 0 0 1 0 0 0 0 1 1 ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;おおむねイメージ通りのデータ&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;tidy-modelによる解析全体の解析&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;tidy modelによる解析:全体の解析&lt;/h1&gt;
&lt;div id=&#34;model作成&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;model作成&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;formula_ckd = c(End_stage_CKD ~ RAS_inhibitor + Age + Sex + DM + CKD) %&amp;gt;% 
  enframe(&amp;quot;model_no&amp;quot;,&amp;quot;formula&amp;quot;)
formula_ckd&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 x 2
##   model_no formula  
##      &amp;lt;int&amp;gt; &amp;lt;list&amp;gt;   
## 1        1 &amp;lt;formula&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;解析&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;解析&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;overall_result = formula_ckd %&amp;gt;% 
  mutate(model = map(formula,glm,family = binomial(link = &amp;quot;logit&amp;quot;),data=study),
         tidied = map(model,tidy),
         confint = map(model,confint_tidy),
         glanced = map(model, glance))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: Problem with `mutate()` input `confint`.
## i confint_tidy is now deprecated and will be removed from a future release of broom. Please use the applicable confint method.
## i Input `confint` is `map(model, confint_tidy)`.&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: confint_tidy is now deprecated and will be removed from a future
## release of broom. Please use the applicable confint method.&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;overall_result&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 x 6
##   model_no formula   model  tidied           confint          glanced         
##      &amp;lt;int&amp;gt; &amp;lt;list&amp;gt;    &amp;lt;list&amp;gt; &amp;lt;list&amp;gt;           &amp;lt;list&amp;gt;           &amp;lt;list&amp;gt;          
## 1        1 &amp;lt;formula&amp;gt; &amp;lt;glm&amp;gt;  &amp;lt;tibble [7 x 5]&amp;gt; &amp;lt;tibble [7 x 2]&amp;gt; &amp;lt;tibble [1 x 8]&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;結果表示全体&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;結果表示：全体&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;overall_coef = overall_result %&amp;gt;% 
  select(model_no, tidied, confint) %&amp;gt;% #係数と95%CIを含む
  unnest() %&amp;gt;% 
  mutate_if(is.double,exp) %&amp;gt;%
  mutate_if(is.double, round, digits=2) &lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: `cols` is now required when using unnest().
## Please use `cols = c(tidied, confint)`&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(DT)
datatable(overall_coef)&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;htmlwidget-1&#34; style=&#34;width:100%;height:auto;&#34; class=&#34;datatables html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-1&#34;&gt;{&#34;x&#34;:{&#34;filter&#34;:&#34;none&#34;,&#34;data&#34;:[[&#34;1&#34;,&#34;2&#34;,&#34;3&#34;,&#34;4&#34;,&#34;5&#34;,&#34;6&#34;,&#34;7&#34;],[1,1,1,1,1,1,1],[&#34;(Intercept)&#34;,&#34;RAS_inhibitor&#34;,&#34;Age&#34;,&#34;Sex&#34;,&#34;DM&#34;,&#34;CKDStage3b&#34;,&#34;CKDStage4&#34;],[2.05,1.01,0.96,1.52,0.98,2.23,1.71],[7.55,1.42,1.03,1.44,1.57,1.58,1.58],[1.43,1.02,0.26,3.12,0.95,5.73,3.26],[2.06,2.68,1.19,1.29,2.62,1.08,1.27],[0.04,0.5,0.89,0.75,0.38,0.93,0.72],[110.74,1.99,1.02,3.19,2.3,5.71,4.34]],&#34;container&#34;:&#34;&lt;table class=\&#34;display\&#34;&gt;\n  &lt;thead&gt;\n    &lt;tr&gt;\n      &lt;th&gt; &lt;\/th&gt;\n      &lt;th&gt;model_no&lt;\/th&gt;\n      &lt;th&gt;term&lt;\/th&gt;\n      &lt;th&gt;estimate&lt;\/th&gt;\n      &lt;th&gt;std.error&lt;\/th&gt;\n      &lt;th&gt;statistic&lt;\/th&gt;\n      &lt;th&gt;p.value&lt;\/th&gt;\n      &lt;th&gt;conf.low&lt;\/th&gt;\n      &lt;th&gt;conf.high&lt;\/th&gt;\n    &lt;\/tr&gt;\n  &lt;\/thead&gt;\n&lt;\/table&gt;&#34;,&#34;options&#34;:{&#34;columnDefs&#34;:[{&#34;className&#34;:&#34;dt-right&#34;,&#34;targets&#34;:[1,3,4,5,6,7,8]},{&#34;orderable&#34;:false,&#34;targets&#34;:0}],&#34;order&#34;:[],&#34;autoWidth&#34;:false,&#34;orderClasses&#34;:false}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;
&lt;p&gt;こうするとestimateとCI以外にもp値なども指数化されることに注意&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;サブグループ解析ckdstage毎&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;サブグループ解析:CKDstage毎&lt;/h2&gt;
&lt;/div&gt;
&lt;div id=&#34;解析-1&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;解析&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;sub_CKD = study %&amp;gt;%
  group_by(CKD) %&amp;gt;%
  nest() %&amp;gt;% 
  mutate(model_glm = map(data,
                         ~ glm(End_stage_CKD ~ RAS_inhibitor + Age + Sex + DM,family = binomial()
                               ,data= .)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;結果確認&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;結果確認&lt;/h2&gt;
&lt;p&gt;全体とやや方法が違うようにしている&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;## 結果
sub_CKD %&amp;lt;&amp;gt;% mutate(coefs = map(model_glm,tidy))
sub_CKD$coefs&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [[1]]
## # A tibble: 5 x 5
##   term          estimate std.error statistic p.value
##   &amp;lt;chr&amp;gt;            &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;   &amp;lt;dbl&amp;gt;
## 1 (Intercept)      4.84     3.05       1.59   0.112 
## 2 RAS_inhibitor   -0.621    0.583     -1.06   0.287 
## 3 Age             -0.106    0.0517    -2.05   0.0404
## 4 Sex              0.718    0.656      1.10   0.273 
## 5 DM               0.174    0.776      0.224  0.823 
## 
## [[2]]
## # A tibble: 5 x 5
##   term          estimate std.error statistic p.value
##   &amp;lt;chr&amp;gt;            &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;   &amp;lt;dbl&amp;gt;
## 1 (Intercept)    -2.33      3.69      -0.631   0.528
## 2 RAS_inhibitor   0.520     0.564      0.922   0.357
## 3 Age             0.0172    0.0607     0.284   0.777
## 4 Sex             0.407     0.556      0.733   0.464
## 5 DM             -0.232     0.741     -0.313   0.754
## 
## [[3]]
## # A tibble: 5 x 5
##   term          estimate std.error statistic p.value
##   &amp;lt;chr&amp;gt;            &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;   &amp;lt;dbl&amp;gt;
## 1 (Intercept)     0.658     4.61      0.143    0.887
## 2 RAS_inhibitor   0.0198    0.738     0.0268   0.979
## 3 Age            -0.0388    0.0752   -0.517    0.605
## 4 Sex            -0.125     0.795    -0.157    0.876
## 5 DM              0.415     0.907     0.458    0.647&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;## 95%CI 
sub_CKD %&amp;lt;&amp;gt;% mutate(confint = map(model_glm,confint_tidy))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: Problem with `mutate()` input `confint`.
## i confint_tidy is now deprecated and will be removed from a future release of broom. Please use the applicable confint method.
## i Input `confint` is `map(model_glm, confint_tidy)`.
## i The error occurred in group 1: CKD = &amp;quot;Stage3a&amp;quot;.&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: confint_tidy is now deprecated and will be removed from a future
## release of broom. Please use the applicable confint method.&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: Problem with `mutate()` input `confint`.
## i confint_tidy is now deprecated and will be removed from a future release of broom. Please use the applicable confint method.
## i Input `confint` is `map(model_glm, confint_tidy)`.
## i The error occurred in group 2: CKD = &amp;quot;Stage3b&amp;quot;.&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: confint_tidy is now deprecated and will be removed from a future
## release of broom. Please use the applicable confint method.&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: Problem with `mutate()` input `confint`.
## i confint_tidy is now deprecated and will be removed from a future release of broom. Please use the applicable confint method.
## i Input `confint` is `map(model_glm, confint_tidy)`.
## i The error occurred in group 3: CKD = &amp;quot;Stage4&amp;quot;.&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: confint_tidy is now deprecated and will be removed from a future
## release of broom. Please use the applicable confint method.&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;sub_CKD$confint&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [[1]]
## # A tibble: 5 x 2
##   conf.low conf.high
##      &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;
## 1   -0.992  11.1    
## 2   -1.81    0.504  
## 3   -0.214  -0.00850
## 4   -0.501   2.12   
## 5   -1.49    1.65   
## 
## [[2]]
## # A tibble: 5 x 2
##   conf.low conf.high
##      &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;
## 1   -9.73      4.90 
## 2   -0.607     1.63 
## 3   -0.103     0.138
## 4   -0.667     1.54 
## 5   -1.85      1.14 
## 
## [[3]]
## # A tibble: 5 x 2
##   conf.low conf.high
##      &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;
## 1   -8.85      9.72 
## 2   -1.49      1.48 
## 3   -0.191     0.112
## 4   -1.65      1.57 
## 5   -1.63      2.09&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;まとめて表示&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;まとめて表示&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df &amp;lt;- sub_CKD %&amp;gt;% 
  select(CKD, cols = c(coefs,confint)) %&amp;gt;%
  unnest() %&amp;gt;% 
  filter(term != &amp;quot;(Intercept)&amp;quot;) %&amp;gt;% # 切片は無視
  mutate_if(is_double,round,digits =2) %&amp;gt;%
  mutate_if(is.double,exp) #95CIと係数をexp変換したいとき&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: `cols` is now required when using unnest().
## Please use `cols = c(cols1, cols2)`&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 12 x 8
## # Groups:   CKD [3]
##    CKD     term          estimate std.error statistic p.value conf.low conf.high
##    &amp;lt;fct&amp;gt;   &amp;lt;chr&amp;gt;            &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;   &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;
##  1 Stage4  RAS_inhibitor    0.538      1.79     0.346    1.34    0.164     1.65 
##  2 Stage4  Age              0.896      1.05     0.129    1.04    0.811     0.990
##  3 Stage4  Sex              2.05       1.93     3.00     1.31    0.607     8.33 
##  4 Stage4  DM               1.19       2.18     1.25     2.27    0.225     5.21 
##  5 Stage3b RAS_inhibitor    1.68       1.75     2.51     1.43    0.543     5.10 
##  6 Stage3b Age              1.02       1.06     1.32     2.18    0.905     1.15 
##  7 Stage3b Sex              1.51       1.75     2.08     1.58    0.512     4.66 
##  8 Stage3b DM               0.795      2.10     0.733    2.12    0.157     3.13 
##  9 Stage3a RAS_inhibitor    1.02       2.10     1.03     2.66    0.225     4.39 
## 10 Stage3a Age              0.961      1.08     0.595    1.84    0.827     1.12 
## 11 Stage3a Sex              0.887      2.23     0.852    2.41    0.192     4.81 
## 12 Stage3a DM               1.51       2.48     1.58     1.92    0.196     8.08&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;datatable(df)&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;htmlwidget-2&#34; style=&#34;width:100%;height:auto;&#34; class=&#34;datatables html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-2&#34;&gt;{&#34;x&#34;:{&#34;filter&#34;:&#34;none&#34;,&#34;data&#34;:[[&#34;1&#34;,&#34;2&#34;,&#34;3&#34;,&#34;4&#34;,&#34;5&#34;,&#34;6&#34;,&#34;7&#34;,&#34;8&#34;,&#34;9&#34;,&#34;10&#34;,&#34;11&#34;,&#34;12&#34;],[&#34;Stage4&#34;,&#34;Stage4&#34;,&#34;Stage4&#34;,&#34;Stage4&#34;,&#34;Stage3b&#34;,&#34;Stage3b&#34;,&#34;Stage3b&#34;,&#34;Stage3b&#34;,&#34;Stage3a&#34;,&#34;Stage3a&#34;,&#34;Stage3a&#34;,&#34;Stage3a&#34;],[&#34;RAS_inhibitor&#34;,&#34;Age&#34;,&#34;Sex&#34;,&#34;DM&#34;,&#34;RAS_inhibitor&#34;,&#34;Age&#34;,&#34;Sex&#34;,&#34;DM&#34;,&#34;RAS_inhibitor&#34;,&#34;Age&#34;,&#34;Sex&#34;,&#34;DM&#34;],[0.537944437594674,0.895834135296528,2.05443321064389,1.18530485132037,1.68202764969889,1.02020134002676,1.50681778511285,0.794533602503334,1.02020134002676,0.960789439152323,0.886920436717157,1.50681778511285],[1.78603843075007,1.05127109637602,1.93479233440203,2.1814722654982,1.7506725002961,1.06183654654536,1.7506725002961,2.09593551449436,2.09593551449436,1.08328706767496,2.22554092849247,2.48432253338482],[0.346455810330057,0.128734903587804,3.00416602394643,1.24607673058738,2.5092903899363,1.32312981233744,2.07508060767412,0.733446956224289,1.03045453395352,0.594520547970194,0.852143788966211,1.58407398499448],[1.33642748802547,1.04081077419239,1.30996445073325,2.27049983753241,1.43332941456034,2.1814722654982,1.58407398499448,2.11700001661267,2.66445624192942,1.84043139878164,2.41089970641721,1.9155408290139],[0.163654136802704,0.810584245970187,0.606530659712633,0.225372655539439,0.5433508690745,0.90483741803596,0.511708577786542,0.157237166313628,0.225372655539439,0.826959133943362,0.192049908620754,0.195929574126909],[1.64872127070013,0.990049833749168,8.33113748768769,5.20697982717985,5.10387471853673,1.15027379885723,4.66459027098813,3.12676836518616,4.39294568091876,1.11627807045887,4.80664819377518,8.08491516430506]],&#34;container&#34;:&#34;&lt;table class=\&#34;display\&#34;&gt;\n  &lt;thead&gt;\n    &lt;tr&gt;\n      &lt;th&gt; &lt;\/th&gt;\n      &lt;th&gt;CKD&lt;\/th&gt;\n      &lt;th&gt;term&lt;\/th&gt;\n      &lt;th&gt;estimate&lt;\/th&gt;\n      &lt;th&gt;std.error&lt;\/th&gt;\n      &lt;th&gt;statistic&lt;\/th&gt;\n      &lt;th&gt;p.value&lt;\/th&gt;\n      &lt;th&gt;conf.low&lt;\/th&gt;\n      &lt;th&gt;conf.high&lt;\/th&gt;\n    &lt;\/tr&gt;\n  &lt;\/thead&gt;\n&lt;\/table&gt;&#34;,&#34;options&#34;:{&#34;columnDefs&#34;:[{&#34;className&#34;:&#34;dt-right&#34;,&#34;targets&#34;:[3,4,5,6,7,8]},{&#34;orderable&#34;:false,&#34;targets&#34;:0}],&#34;order&#34;:[],&#34;autoWidth&#34;:false,&#34;orderClasses&#34;:false}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;
&lt;p&gt;今回もestimateとCI以外にも指数化されていることに注意&lt;/p&gt;
&lt;p&gt;この方法の良い点はいろいろあるがサブグループ解析をする際になどに可読性がよくなる点である。&lt;/p&gt;
&lt;p&gt;今回もデータをグループ毎に分割して解析すると、その分だけスクリプトが長くなり可読性が低下する。&lt;/p&gt;
&lt;p&gt;それを防ぐことができる。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Rによる傾向スコア分析の実装２</title>
      <link>/post/propensity_score_multi/</link>
      <pubDate>Tue, 28 Jul 2020 17:13:22 +0900</pubDate>
      <guid>/post/propensity_score_multi/</guid>
      <description>


&lt;div id=&#34;テーマ&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;テーマ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;マルチレベルデータに対する生存時間解析&lt;/li&gt;
&lt;li&gt;マルチレベルデータに対する傾向スコアを用いた生存時間解析&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;前回用いたシミュレーションデータでは、マルチレベルデータを用いた傾向スコア法でも
結果が変わらなかった。
おそらくシミュレーションデータのためであろう。&lt;/p&gt;
&lt;p&gt;今回はオープンアクセスデータを用いた実装を行う。&lt;/p&gt;
&lt;p&gt;データは以下から引用した。&lt;/p&gt;
&lt;p&gt;Citation
Shiroshita, Akihiro (2020), Effectiveness of steroid therapy on pneumonic chronic obstructive pulmonary disease exacerbation: a multi-centred retrospective cohort study, v3, Dryad, Dataset, &lt;a href=&#34;https://doi.org/10.5061/dryad.m63xsj3zd&#34; class=&#34;uri&#34;&gt;https://doi.org/10.5061/dryad.m63xsj3zd&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;データの読み込み&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;データの読み込み&lt;/h2&gt;
&lt;p&gt;実際には上記のサイトより引用&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;データの確認&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;データの確認&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(copd)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##        id            age             gender         steroid      
##  Min.   :   1   Min.   : 47.00   Min.   :1.000   Min.   :0.0000  
##  1st Qu.: 310   1st Qu.: 74.00   1st Qu.:1.000   1st Qu.:0.0000  
##  Median : 619   Median : 80.00   Median :1.000   Median :1.0000  
##  Mean   : 619   Mean   : 79.27   Mean   :1.099   Mean   :0.5319  
##  3rd Qu.: 928   3rd Qu.: 85.00   3rd Qu.:1.000   3rd Qu.:1.0000  
##  Max.   :1237   Max.   :105.00   Max.   :2.000   Max.   :1.0000  
##                                                                  
##     hospital          adl             wheeze            bun        
##  Min.   :1.000   Min.   :0.0000   Min.   :0.0000   Min.   :  1.00  
##  1st Qu.:1.000   1st Qu.:1.0000   1st Qu.:0.0000   1st Qu.: 14.00  
##  Median :2.000   Median :1.0000   Median :0.0000   Median : 18.00  
##  Mean   :2.032   Mean   :0.8529   Mean   :0.3112   Mean   : 21.39  
##  3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.:1.0000   3rd Qu.: 25.00  
##  Max.   :5.000   Max.   :1.0000   Max.   :1.0000   Max.   :152.00  
##                                                    NA&amp;#39;s   :11      
##        rr           ams              hr             hot        
##  24     :225   Min.   :0.000   Min.   : 30.0   Min.   :0.0000  
##  20     :151   1st Qu.:0.000   1st Qu.: 88.0   1st Qu.:0.0000  
##  30     :106   Median :0.000   Median :101.0   Median :0.0000  
##  28     : 80   Mean   :0.159   Mean   :101.3   Mean   :0.2328  
##  18     : 66   3rd Qu.:0.000   3rd Qu.:114.0   3rd Qu.:0.0000  
##  (Other):504   Max.   :1.000   Max.   :200.0   Max.   :1.0000  
##  NA&amp;#39;s   :105   NA&amp;#39;s   :4       NA&amp;#39;s   :14                      
##    stability      time_to_stability     death        non_informative_cencoring
##  Min.   :0.0000   Min.   : 0.000    Min.   :0.0000   Min.   :0                
##  1st Qu.:1.0000   1st Qu.: 1.000    1st Qu.:0.0000   1st Qu.:0                
##  Median :1.0000   Median : 3.000    Median :0.0000   Median :0                
##  Mean   :0.8351   Mean   : 3.882    Mean   :0.0671   Mean   :0                
##  3rd Qu.:1.0000   3rd Qu.: 5.000    3rd Qu.:0.0000   3rd Qu.:0                
##  Max.   :1.0000   Max.   :39.000    Max.   :1.0000   Max.   :0                
##                                                                               
##    discharge        intubation       hospitalization 
##  Min.   :0.0000   Min.   :0.000000   Min.   :  1.00  
##  1st Qu.:1.0000   1st Qu.:0.000000   1st Qu.:  8.00  
##  Median :1.0000   Median :0.000000   Median : 12.00  
##  Mean   :0.9289   Mean   :0.007282   Mean   : 16.97  
##  3rd Qu.:1.0000   3rd Qu.:0.000000   3rd Qu.: 19.00  
##  Max.   :1.0000   Max.   :1.000000   Max.   :200.00  
##                   NA&amp;#39;s   :1&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;str(copd)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    1237 obs. of  19 variables:
##  $ id                       : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ age                      : int  69 68 75 62 76 76 86 78 84 77 ...
##  $ gender                   : int  1 1 1 1 1 1 1 1 1 2 ...
##  $ steroid                  : int  1 1 1 1 1 1 1 0 1 0 ...
##  $ hospital                 : int  5 5 5 5 5 5 5 5 5 5 ...
##  $ adl                      : int  1 1 1 1 1 1 1 1 1 1 ...
##  $ wheeze                   : int  1 0 0 1 1 1 1 0 0 1 ...
##  $ bun                      : num  6.9 24.8 18.2 17.7 15.1 9.4 46.2 84.9 15.8 13.3 ...
##  $ rr                       : Factor w/ 38 levels &amp;quot;&amp;quot;,&amp;quot;0&amp;quot;,&amp;quot;11&amp;quot;,&amp;quot;12&amp;quot;,..: NA 23 18 26 23 7 11 19 15 19 ...
##  $ ams                      : int  0 0 0 0 0 0 1 0 0 0 ...
##  $ hr                       : int  105 160 120 90 104 126 93 101 110 64 ...
##  $ hot                      : int  1 1 0 0 1 1 1 1 1 0 ...
##  $ stability                : int  1 1 0 1 0 1 0 0 1 1 ...
##  $ time_to_stability        : int  3 6 0 10 0 1 0 0 4 19 ...
##  $ death                    : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ non_informative_cencoring: int  0 0 0 0 0 0 0 0 0 0 ...
##  $ discharge                : int  1 1 1 1 1 1 1 1 1 1 ...
##  $ intubation               : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ hospitalization          : int  9 23 22 12 18 21 8 2 10 30 ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データ整形&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;データ整形&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;rrは離散値をとる数値型のはずが、因子型になっている。&lt;/li&gt;
&lt;li&gt;のちのためにも変換が必要&lt;/li&gt;
&lt;li&gt;同じく従属変数も数値型へ変換&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;copd$rr &amp;lt;- as.numeric(copd$rr)
str(copd$rr)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  num [1:1237] NA 23 18 26 23 7 11 19 15 19 ...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 従属変数の変換
copd$stability &amp;lt;- as.numeric(copd$stability)
str(copd$stability)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  num [1:1237] 1 1 0 1 0 1 0 0 1 1 ...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 時間変数も数値型へ変換
copd$time_to_stability &amp;lt;- as.numeric(copd$time_to_stability)
str(copd$time_to_stability)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  num [1:1237] 3 6 0 10 0 1 0 0 4 19 ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;数値型になったことを確認できた。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;データの概要&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;データの概要&lt;/h2&gt;
&lt;p&gt;元論文より引用&lt;/p&gt;
&lt;p&gt;日本のデータで５施設からの多施設後ろ向きコホート研究&lt;/p&gt;
&lt;p&gt;ステロイド投与が慢性閉塞性肺疾患に与える影響を調べた1237人のデータ,19変数&lt;/p&gt;
&lt;p&gt;＜変数名＞
id: anonimized patients’ ID,&lt;/p&gt;
&lt;p&gt;age: patients’ age on hospitalization,&lt;/p&gt;
&lt;p&gt;gender: 1=male, 2=female,&lt;/p&gt;
&lt;p&gt;steroid: steroid use (0=not, 1=steroid use),&lt;/p&gt;
&lt;p&gt;hospital: categorized hospital name (1-5まで病院コード),&lt;/p&gt;
&lt;p&gt;adl: activity daily living before hospitalization (0: full support, 1: not full support),&lt;/p&gt;
&lt;p&gt;wheeze: wheezing lung sound on admission (0:not, 1:wheezing lung sound),&lt;/p&gt;
&lt;p&gt;bun: blood urea nitrogen (mg/dL),&lt;/p&gt;
&lt;p&gt;rr: respiratory rate (/minute),&lt;/p&gt;
&lt;p&gt;ams: altered mental status (0=not, 1=altered mental status),&lt;/p&gt;
&lt;p&gt;hr: heart rate (/minute),&lt;/p&gt;
&lt;p&gt;hot: home oxygen therapy use before hospitalization (0=not, 1=users),&lt;/p&gt;
&lt;p&gt;insulin: new insuline users during hospitalization (0=not, 1=new users),&lt;/p&gt;
&lt;p&gt;delirium: clinical diagnosis of delirium during hospitalization (0=not, 1=delirium),&lt;/p&gt;
&lt;p&gt;stability: reaching the clinical stability (0=not, 1=reached clinical stability),&lt;/p&gt;
&lt;p&gt;time_to_stability: time to clinical stability (days),&lt;/p&gt;
&lt;p&gt;death:in-hospital death,&lt;/p&gt;
&lt;p&gt;non-informative_censoring: non-informative censoring (0=not, 1=noninformative
censoring),&lt;/p&gt;
&lt;p&gt;discharge (0=not, 1=discharged patients),&lt;/p&gt;
&lt;p&gt;intubation: tracheal&lt;/p&gt;
&lt;p&gt;intubation during hospitalization (0=not, 1=intubated),&lt;/p&gt;
&lt;p&gt;hospitalization=length of stay (days)&lt;/p&gt;
&lt;p&gt;＜アウトカム＞
stability：臨床的安定の達成&lt;/p&gt;
&lt;p&gt;＜曝露＞
steroid:ステロイド使用の有無&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;今回考え得るモデル&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;今回考え得るモデル&lt;/h2&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Complete case analysis + 多変量生存時間解析 with/without マルチレベル分析&lt;br&gt;&lt;/li&gt;
&lt;li&gt;Complete case analysis + 傾向スコア + 生存時間解析 with/without マルチレベル分析&lt;br&gt;&lt;/li&gt;
&lt;li&gt;多重代入による欠損値処理 + 傾向スコア + 生存時間解析 with/without マルチレベル分析&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div id=&#34;complete-case-analysisその1&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Complete case analysis:その1&lt;/h2&gt;
&lt;p&gt;欠損値への対処がやっかいなのでまずはcomplete case analysisを行う。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# na.omitは欠損値を除く関数
copd_ca &amp;lt;- na.omit(copd)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データの概要-1&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;データの概要&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(copd_ca)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##        id              age             gender         steroid      
##  Min.   :   2.0   Min.   : 47.00   Min.   :1.000   Min.   :0.0000  
##  1st Qu.: 340.5   1st Qu.: 74.00   1st Qu.:1.000   1st Qu.:0.0000  
##  Median : 640.0   Median : 80.00   Median :1.000   Median :1.0000  
##  Mean   : 634.2   Mean   : 79.44   Mean   :1.097   Mean   :0.5487  
##  3rd Qu.: 940.5   3rd Qu.: 85.00   3rd Qu.:1.000   3rd Qu.:1.0000  
##  Max.   :1237.0   Max.   :105.00   Max.   :2.000   Max.   :1.0000  
##     hospital          adl             wheeze            bun        
##  Min.   :1.000   Min.   :0.0000   Min.   :0.0000   Min.   :  1.00  
##  1st Qu.:1.000   1st Qu.:1.0000   1st Qu.:0.0000   1st Qu.: 14.00  
##  Median :2.000   Median :1.0000   Median :0.0000   Median : 18.00  
##  Mean   :1.974   Mean   :0.8517   Mean   :0.3208   Mean   : 21.37  
##  3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.:1.0000   3rd Qu.: 25.00  
##  Max.   :5.000   Max.   :1.0000   Max.   :1.0000   Max.   :152.00  
##        rr             ams               hr             hot        
##  Min.   : 1.00   Min.   :0.0000   Min.   : 30.0   Min.   :0.0000  
##  1st Qu.:11.00   1st Qu.:0.0000   1st Qu.: 88.5   1st Qu.:0.0000  
##  Median :15.00   Median :0.0000   Median :101.0   Median :0.0000  
##  Mean   :15.42   Mean   :0.1609   Mean   :101.4   Mean   :0.2315  
##  3rd Qu.:19.00   3rd Qu.:0.0000   3rd Qu.:114.0   3rd Qu.:0.0000  
##  Max.   :38.00   Max.   :1.0000   Max.   :200.0   Max.   :1.0000  
##    stability      time_to_stability     death         non_informative_cencoring
##  Min.   :0.0000   Min.   : 0.00     Min.   :0.00000   Min.   :0                
##  1st Qu.:1.0000   1st Qu.: 1.00     1st Qu.:0.00000   1st Qu.:0                
##  Median :1.0000   Median : 3.00     Median :0.00000   Median :0                
##  Mean   :0.8329   Mean   : 3.86     Mean   :0.06702   Mean   :0                
##  3rd Qu.:1.0000   3rd Qu.: 5.00     3rd Qu.:0.00000   3rd Qu.:0                
##  Max.   :1.0000   Max.   :39.00     Max.   :1.00000   Max.   :0                
##    discharge        intubation       hospitalization 
##  Min.   :0.0000   Min.   :0.000000   Min.   :  1.00  
##  1st Qu.:1.0000   1st Qu.:0.000000   1st Qu.:  8.00  
##  Median :1.0000   Median :0.000000   Median : 12.00  
##  Mean   :0.9285   Mean   :0.007149   Mean   : 16.96  
##  3rd Qu.:1.0000   3rd Qu.:0.000000   3rd Qu.: 19.00  
##  Max.   :1.0000   Max.   :1.000000   Max.   :200.00&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;nrow(copd_ca)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] 1119&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;欠損値はすべてなくなり、1119例となっていることが分かる。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;式の作成&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;式の作成&lt;/h2&gt;
&lt;p&gt;共変量設定&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;covariateNames_ca &amp;lt;-  
  c(&amp;quot;gender&amp;quot;,#性別
    &amp;quot;age&amp;quot;,#年齢
    &amp;quot;hot&amp;quot;, #在宅酸素療法の有無
    &amp;quot;adl&amp;quot;,#ADL
    &amp;quot;rr&amp;quot;, #呼吸数
    &amp;quot;ams&amp;quot;, # 意識状態
    &amp;quot;hr&amp;quot;, #心拍数
    &amp;quot;bun&amp;quot; #BUN
    #著者らは先行研究に基づいて決定
    )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;生存時間解析&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;生存時間解析&lt;/h2&gt;
&lt;div id=&#34;カプランマイヤー法で評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;カプランマイヤー法で評価&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(survival)
library(survminer)
library(ggplot2)&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;sv_result &amp;lt;- survfit(Surv(copd_ca$time_to_stability,copd_ca$stability) ~ copd_ca$steroid)&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggsurvplot(sv_result, data = copd_ca, censor.shape = &amp;quot;|&amp;quot;,risk.table = TRUE,risk.table.col = &amp;quot;strata&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: Vectorized input to `element_text()` is not officially supported.
## Results may be unexpected or may change in future versions of ggplot2.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/propensity_score_multi_files/figure-html/unnamed-chunk-9-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;比例ハザード性は判断が難しい。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;ログランク検定&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;ログランク検定&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;survdiff(Surv(copd_ca$time_to_stability,copd_ca$stability) ~ copd_ca$steroid)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Call:
## survdiff(formula = Surv(copd_ca$time_to_stability, copd_ca$stability) ~ 
##     copd_ca$steroid)
## 
##                     N Observed Expected (O-E)^2/E (O-E)^2/V
## copd_ca$steroid=0 505      428      401      1.76      3.99
## copd_ca$steroid=1 614      504      531      1.33      3.99
## 
##  Chisq= 4  on 1 degrees of freedom, p= 0.05&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;結果はp value = 0.05 とこちらも微妙…&lt;/p&gt;
&lt;p&gt;そもそもとしてCoxの比例ハザードモデルを考えてよいかが問題となってくる。&lt;/p&gt;
&lt;p&gt;元論文では競合リスクを考慮した解析を行っている。&lt;/p&gt;
&lt;p&gt;一応ここでは通常のCox比例ハザードモデルを行う。&lt;/p&gt;
&lt;p&gt;ここからモデル作成を行う&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;モデル1-1random効果を無視した生存時間解析通常の多変量比例ハザードモデル&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;モデル1-1:random効果を無視した生存時間解析(通常の多変量比例ハザードモデル)&lt;/h2&gt;
&lt;p&gt;ここから解析を行う.&lt;/p&gt;
&lt;p&gt;ここでのステロイドの治療は施設ごとでも差がないとの仮定に基づいている。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(survival)
model_ca_nm &amp;lt;- coxph(data = copd_ca, Surv(time_to_stability,stability) ~　steroid + age + gender + hot + adl + ams + rr + hr + bun)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;係数の確認&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(model_ca_nm)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Call:
## coxph(formula = Surv(time_to_stability, stability) ~ steroid + 
##     age + gender + hot + adl + ams + rr + hr + bun, data = copd_ca)
## 
##   n= 1119, number of events= 932 
## 
##               coef  exp(coef)   se(coef)      z Pr(&amp;gt;|z|)   
## steroid -0.1205477  0.8864348  0.0667505 -1.806  0.07093 . 
## age      0.0143903  1.0144943  0.0044923  3.203  0.00136 **
## gender  -0.2421026  0.7849756  0.1143233 -2.118  0.03420 * 
## hot      0.2456815  1.2784923  0.0801850  3.064  0.00218 **
## adl     -0.0329088  0.9676268  0.1013175 -0.325  0.74533   
## ams     -0.0594581  0.9422750  0.0995337 -0.597  0.55026   
## rr      -0.0171500  0.9829962  0.0060550 -2.832  0.00462 **
## hr      -0.0004657  0.9995344  0.0018423 -0.253  0.80043   
## bun     -0.0071899  0.9928359  0.0034794 -2.066  0.03879 * 
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
##         exp(coef) exp(-coef) lower .95 upper .95
## steroid    0.8864     1.1281    0.7777    1.0103
## age        1.0145     0.9857    1.0056    1.0235
## gender     0.7850     1.2739    0.6274    0.9821
## hot        1.2785     0.7822    1.0926    1.4961
## adl        0.9676     1.0335    0.7934    1.1802
## ams        0.9423     1.0613    0.7753    1.1453
## rr         0.9830     1.0173    0.9714    0.9947
## hr         0.9995     1.0005    0.9959    1.0032
## bun        0.9928     1.0072    0.9861    0.9996
## 
## Concordance= 0.581  (se = 0.012 )
## Likelihood ratio test= 41.23  on 9 df,   p=5e-06
## Wald test            = 40.77  on 9 df,   p=6e-06
## Score (logrank) test = 40.88  on 9 df,   p=5e-06&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;round(exp(confint(model_ca_nm)),3)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##         2.5 % 97.5 %
## steroid 0.778  1.010
## age     1.006  1.023
## gender  0.627  0.982
## hot     1.093  1.496
## adl     0.793  1.180
## ams     0.775  1.145
## rr      0.971  0.995
## hr      0.996  1.003
## bun     0.986  1.000&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;round(exp(coefficients(model_ca_nm)),3)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## steroid     age  gender     hot     adl     ams      rr      hr     bun 
##   0.886   1.014   0.785   1.278   0.968   0.942   0.983   1.000   0.993&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ステロイドの使用はHR 0.886 (95%CI 0.778 - 1.010)&lt;br&gt;
状態安定に影響を与えるとは言えない結果であった。&lt;br&gt;
(イベントが状態がよい=1のためHRが1を超えると状態を安定させる方向)&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;モデル1-2random効果を考慮したモデル&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;モデル1-2:random効果を考慮したモデル&lt;/h2&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# GLMMで扱うパッケージ
library(lme4)
model_ca_ri &amp;lt;- coxme::coxme(data = copd_ca, Surv(time_to_stability,stability) ~　steroid + age + gender + hot + adl + ams + rr + hr + bun + (1|hospital))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;最後の(1|hospital)が施設ごとに切片が違うことを表している。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 結果の確認
summary(model_ca_ri)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Cox mixed-effects model fit by maximum likelihood
##   Data: copd_ca
##   events, n = 932, 1119
##   Iterations= 5 23 
##                     NULL Integrated    Fitted
## Log-likelihood -5446.863   -5416.35 -5410.778
## 
##                   Chisq    df          p   AIC    BIC
## Integrated loglik 61.03 10.00 2.3152e-09 41.03  -7.35
##  Penalized loglik 72.17 12.29 1.6582e-10 47.58 -11.89
## 
## Model:  Surv(time_to_stability, stability) ~ steroid + age + gender +      hot + adl + ams + rr + hr + bun + (1 | hospital) 
## Fixed coefficients
##                  coef exp(coef)    se(coef)     z      p
## steroid -0.1891431726 0.8276680 0.069411572 -2.72 0.0064
## age      0.0114649558 1.0115309 0.004530116  2.53 0.0110
## gender  -0.2397071791 0.7868582 0.114585337 -2.09 0.0360
## hot      0.2924630311 1.3397232 0.080883780  3.62 0.0003
## adl      0.0318516716 1.0323644 0.102796189  0.31 0.7600
## ams     -0.0956917165 0.9087441 0.101592480 -0.94 0.3500
## rr      -0.0174388264 0.9827123 0.006113988 -2.85 0.0043
## hr      -0.0002423059 0.9997577 0.001846803 -0.13 0.9000
## bun     -0.0075758979 0.9924527 0.003531128 -2.15 0.0320
## 
## Random effects
##  Group    Variable  Std Dev    Variance  
##  hospital Intercept 0.23398785 0.05475031&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;round(exp(confint(model_ca_ri)),3)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##         2.5 % 97.5 %
## steroid 0.722  0.948
## age     1.003  1.021
## gender  0.629  0.985
## hot     1.143  1.570
## adl     0.844  1.263
## ams     0.745  1.109
## rr      0.971  0.995
## hr      0.996  1.003
## bun     0.986  0.999&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;round(exp(coefficients(model_ca_ri)),3)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## steroid     age  gender     hot     adl     ams      rr      hr     bun 
##   0.828   1.012   0.787   1.340   1.032   0.909   0.983   1.000   0.992&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ランダム切片モデルで考えると＜曝露＞ステロイドの使用は有意であった。&lt;br&gt;
今回は臨床的な病態安定の達成をイベントとして1とカウントしている。&lt;br&gt;
HR 0.83ということはむしろ安定させない方向に働くと考えられる。&lt;/p&gt;
&lt;div id=&#34;モデル1-2切片のチェック&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデル1-2:切片のチェック&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(lme4)
ranef(model_ca_ri)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## $hospital
##           1           2           3           4           5 
##  0.02903655  0.29990271 -0.01872156 -0.01416696 -0.29605075&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;病院別のランダム切片の値を確認するとそれぞればらつきがあることが分かる。&lt;br&gt;
病院1,2の方が基本イベント達成しやすい傾向があるようだ。&lt;br&gt;
この辺りは病院による何らかの特性の違いを反映していると考えられる。&lt;/p&gt;
&lt;p&gt;しかし、そもそもageや在宅酸素が正の値をとっていることから&lt;br&gt;
年齢が高くなる、在宅酸素をしていると病態が安定するという結果になる。&lt;/p&gt;
&lt;p&gt;臨床的な感覚からすると矛盾であり、データの妥当性やモデルの妥当性を含めて検証が必要かもしれない。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;model2-1傾向スコア-ランダム効果を無視&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;model2-1:傾向スコア + ランダム効果を無視&lt;/h2&gt;
&lt;p&gt;まずクラスター効果を無視した傾向スコアを算出する。&lt;/p&gt;
&lt;div id=&#34;治療指標の作成&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;治療指標の作成&lt;/h3&gt;
&lt;p&gt;今後の便利のためsteroidとは別に治療指標という変数を作成する、治療指標は因子型としておく&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;copd_ca$treated &amp;lt;- as.factor(copd_ca$steroid)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;連続予測子の標準化&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;連続予測子の標準化&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#標準化された連続予測子
for (var in covariateNames_ca) {
  if (class(copd_ca[,var])!=&amp;quot;factor&amp;quot;) { copd_ca[,var] = (copd_ca[,var]-mean(copd_ca[,var]))/sd(copd_ca[,var]) } }&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;傾向スコアの推定&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;傾向スコアの推定&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#ロジスティック回帰モデルの式の作成
ps.formula0 &amp;lt;- paste(covariateNames_ca, collapse=&amp;quot;+&amp;quot;) 
ps.formula0 &amp;lt;- formula(paste(&amp;quot;treated~&amp;quot;,ps.formula0))
print(ps.formula0)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## treated ~ gender + age + hot + adl + rr + ams + hr + bun&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#クラスタリングを無視した傾向スコアの推定
ps.model0 &amp;lt;- glm(ps.formula0, data = copd_ca, family=binomial)

#クラスタリングを無視した傾向スコアを得る
copd_ca$ps0 &amp;lt;- fitted(ps.model0)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;共通指示の評価傾向スコアの分布にばらつきがないか&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;共通指示の評価(傾向スコアの分布にばらつきがないか)&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;hist(copd_ca$ps0[copd_ca$treated==0], density = 10, angle = 45, main=&amp;quot;Propensity Scores&amp;quot;,
     breaks=seq(0,1,by=0.01),
     xlim=c(0,1), ylim=c(0,60), xlab=&amp;quot;Shaded = Untreated | Gray = Steroid&amp;quot;)
hist(copd_ca$ps0[copd_ca$treated==1], col=gray(0.4,0.25), breaks=seq(0,1,by=0.01),
     xlim=c(0,1), ylim=c(0,60),add=T) &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/propensity_score_multi_files/figure-html/unnamed-chunk-20-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;傾向スコアの分布は同じくらいであることが分かる。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;ateの推定&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;ATEの推定&lt;/h3&gt;
&lt;p&gt;今回の興味は試験に参加した全集団にステロイド使用した場合の平均因果効果である。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 重みの計算
copd_ca$psw0 &amp;lt;- with(copd_ca, ifelse(treated==1, 1/ps0, 1/(1-ps0)))
#重みの正規化
copd_ca$psw0 &amp;lt;- copd_ca$psw0/mean(copd_ca$psw0)
# 統合
with(copd_ca, by(psw0, steroid, summary))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## steroid: 0
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.8188  1.0006  1.0756  1.1079  1.1847  1.7251 
## ------------------------------------------------------------ 
## steroid: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.6717  0.8418  0.9100  0.9112  0.9720  1.1853&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;両群のバランス評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;両群のバランス評価&lt;/h3&gt;
&lt;p&gt;傾向スコアで調整するにあたり、曝露群と非曝露群でバランスがとれているかの評価が必要&lt;/p&gt;
&lt;p&gt;まずはベースラインでの評価を行う&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;require(twang)

baseline.balance0 &amp;lt;- bal.stat(data=copd_ca,#dataset
                          var=covariateNames_ca,#list of the variables to be included in the balance check
                          treat.var=&amp;quot;treated&amp;quot;,#treatment assignment variable
                          w.all=1,#define weights equal to 1 (no weighting)
                          sampw=1,#define the sampling weights (no weighting)
                          get.means=T, #compute means and variances
                          get.ks=F,#overwrite the default for obtaining KS statistic
                          estimand=&amp;quot;ATE&amp;quot;,#specify the estimand of interest
                          multinom=F)#underline that multinomial ps are not used
baseline.balance.es &amp;lt;- baseline.balance0$results

summary(abs(baseline.balance.es$std.eff.sz))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## 0.02125 0.03662 0.04553 0.07668 0.12321 0.18266&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;標準化効果量は最大で0.18266とバランスがとれていない項目があることが分かる。&lt;/p&gt;
&lt;p&gt;続いて傾向スコアで重みづけした後のバランス評価を行う。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;psw.balance0 &amp;lt;- bal.stat(data=copd_ca,#dataset
                          var=covariateNames_ca,#list of the variables to be included in the balance check
                          treat.var=&amp;quot;treated&amp;quot;,#treatment assignment variable
                          w.all=copd_ca$psw0,#define the overall weights
                          sampw=1,#define the sampling weights
                          get.means=T, #compute means and variances
                          get.ks=F,#overwrite the default for obtaining KS statistic
                          estimand=&amp;quot;ATE&amp;quot;,#specify the estimand of interest
                          multinom=F)#underline that multinomial ps are not used


psw.balance.table0 &amp;lt;- psw.balance0$results

summary(abs(psw.balance.table0$std.eff.sz))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
## 0.0001159 0.0008443 0.0025712 0.0019355 0.0027109 0.0033863&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;標準効果量の最大値は0.0033863であり両群でバランスがとれていることが分かる。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;生存時間解析-1&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;生存時間解析&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(hrIPW)

model_ca_ps &amp;lt;- coxph(data = copd_ca, Surv(time_to_stability,stability) ~　treated, weights = psw0, robust = TRUE)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;結果確認&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(model_ca_ps)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Call:
## coxph(formula = Surv(time_to_stability, stability) ~ treated, 
##     data = copd_ca, weights = psw0, robust = TRUE)
## 
##   n= 1119, number of events= 932 
## 
##              coef exp(coef) se(coef) robust se      z Pr(&amp;gt;|z|)  
## treated1 -0.11933   0.88752  0.06591   0.06498 -1.836   0.0663 .
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
##          exp(coef) exp(-coef) lower .95 upper .95
## treated1    0.8875      1.127    0.7814     1.008
## 
## Concordance= 0.509  (se = 0.011 )
## Likelihood ratio test= 3.28  on 1 df,   p=0.07
## Wald test            = 3.37  on 1 df,   p=0.07
## Score (logrank) test = 3.28  on 1 df,   p=0.07,   Robust = 3.44  p=0.06
## 
##   (Note: the likelihood ratio and score tests assume independence of
##      observations within a cluster, the Wald and robust score tests do not).&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;round(exp(confint(model_ca_ps)),3)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##          2.5 % 97.5 %
## treated1 0.781  1.008&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;round(exp(coefficients(model_ca_ps)),3)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## treated1 
##    0.888&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ロバスト推定した場合：HR 0.888、95%CI: 0.781 - 1.008で有意にはならなかった。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;model2-2傾向スコア-ランダム効果を含む&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;model2-2:傾向スコア + ランダム効果を含む&lt;/h2&gt;
&lt;div id=&#34;マルチレベルロジスティック回帰モデル式の作成&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;2-1.マルチレベルロジスティック回帰モデル式の作成&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ps.formula &amp;lt;- paste(covariateNames_ca, collapse=&amp;quot;+&amp;quot;) 
# 今回はクラスター効果を示す変数がはいっている
ps.formula &amp;lt;- formula(paste(&amp;quot;steroid~&amp;quot;,ps.formula,&amp;quot;+ (1|hospital)&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;ランダム切片によるマルチレベルロジスティック回帰&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;2-2.ランダム切片によるマルチレベルロジスティック回帰&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#ランダム切片によるマルチレベルモデル             
ps.model &amp;lt;- glmer(formula = ps.formula, family = binomial, data = copd_ca, 
                 #it was necessary to use the &amp;quot;control&amp;quot; argument to obtain convergence
                 #by chaing the optimizer and increasing the number of iterations
                  control=glmerControl(optimizer=&amp;quot;bobyqa&amp;quot;,optCtrl=list(maxfun=2e5))) 
#使用する非線形オプティマイザや非線形オプティマイザに渡すパラメータなどの制御パラメータを含むリスト&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;傾向スコアを得る&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;2-3. 傾向スコアを得る&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#傾向スコアを得
copd_ca$ps=fitted(ps.model) ##extract the model estimated propensity scores

with(copd_ca, by(ps, treated, summary))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## treated: 0
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.1112  0.4352  0.5142  0.5025  0.6093  0.8183 
## ------------------------------------------------------------ 
## treated: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.1520  0.5002  0.5943  0.5867  0.6771  0.8920&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;共通支持を評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;2-4. 共通支持を評価&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;hist(copd_ca$ps[copd_ca$treated==0], density = 10, angle = 45, main=&amp;quot;Propensity Scores&amp;quot;,
     breaks=seq(0,1,by=0.01),
     xlim=c(0,1), ylim=c(0,40), xlab=&amp;quot;Shaded = Untreated | Gray = Treated&amp;quot;)

hist(copd_ca$ps[copd_ca$treated==1], col=gray(0.4,0.25), breaks=seq(0,1,by=0.01),
     xlim=c(0,1), ylim=c(0,40),add=T) &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/propensity_score_multi_files/figure-html/unnamed-chunk-29-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;傾向スコアのばらつきはあるが重なりは同じくらいであることが分かる&lt;/p&gt;
&lt;p&gt;傾向スコアのカーネル密度推定&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;densityplot( ~ ps, groups=steroid, plot.points=F, xlim=c(0,1), 
             data = copd_ca,  ylab = &amp;quot;Propensity Scores&amp;quot;, xlab = &amp;quot;Treatment&amp;quot;,auto.key = TRUE)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/propensity_score_multi_files/figure-html/unnamed-chunk-30-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;ateの推定-1&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;2-5. ATEの推定&lt;/h3&gt;
&lt;p&gt;今回も興味は試験に参加した全集団でのステロイドの因果効果である。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 重みの計算
copd_ca$psw &amp;lt;- with(copd_ca, ifelse(treated==1, 1/ps, 1/(1-ps)))
#重みの正規化
copd_ca$psw &amp;lt;- copd_ca$psw/mean(copd_ca$psw)
# 統合
with(copd_ca, by(psw, steroid, summary))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## steroid: 0
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.5665  0.8914  1.0364  1.1085  1.2888  2.7716 
## ------------------------------------------------------------ 
## steroid: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.5645  0.7436  0.8472  0.9108  1.0067  3.3119&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;psw.balance &amp;lt;- bal.stat(data=copd_ca,#dataset
                          var=covariateNames_ca,#list of the variables to be included in the balance check
                          treat.var=&amp;quot;treated&amp;quot;,#treatment assignment variable
                          w.all=copd_ca$psw,#define the overall weights
                          sampw=1,#define the sampling weights
                          get.means=T, #compute means and variances
                          get.ks=F,#overwrite the default for obtaining KS statistic
                          estimand=&amp;quot;ATE&amp;quot;,#specify the estimand of interest
                          multinom=F)#underline that multinomial ps are not used


psw.balance.table &amp;lt;- psw.balance$results

summary(abs(psw.balance.table$std.eff.sz))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## 0.001953 0.004157 0.006546 0.006607 0.008396 0.011965&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;最大でも標準効果量が0.1未満であり両群のバランスは保たれている。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;model_ca_psw &amp;lt;- coxph(data = copd_ca, Surv(time_to_stability,stability) ~　treated, weights = psw, robust = TRUE)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;結果確認&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(model_ca_psw)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Call:
## coxph(formula = Surv(time_to_stability, stability) ~ treated, 
##     data = copd_ca, weights = psw, robust = TRUE)
## 
##   n= 1119, number of events= 932 
## 
##              coef exp(coef) se(coef) robust se      z Pr(&amp;gt;|z|)   
## treated1 -0.18572   0.83051  0.06618   0.06887 -2.697    0.007 **
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
##          exp(coef) exp(-coef) lower .95 upper .95
## treated1    0.8305      1.204    0.7256    0.9505
## 
## Concordance= 0.521  (se = 0.011 )
## Likelihood ratio test= 7.87  on 1 df,   p=0.005
## Wald test            = 7.27  on 1 df,   p=0.007
## Score (logrank) test = 7.9  on 1 df,   p=0.005,   Robust = 7.45  p=0.006
## 
##   (Note: the likelihood ratio and score tests assume independence of
##      observations within a cluster, the Wald and robust score tests do not).&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;round(exp(confint(model_ca_psw)),3)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##          2.5 % 97.5 %
## treated1 0.726  0.951&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;round(exp(coefficients(model_ca_psw)),3)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## treated1 
##    0.831&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;HR 0.831, 95%CI:0.726 - 0.951&lt;/p&gt;
&lt;p&gt;施設のランダム効果を考慮して傾向スコアを算出し、ATEを推定して生存時間解析を行うと結果は有意であった。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;結果のまとめ&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;結果のまとめ&lt;/h2&gt;
&lt;p&gt;今回の結果では、クラスター効果を無視した解析を行うと興味のある曝露の効果は有意とはならず、&lt;br&gt;
クラスター効果を考慮した解析を行うと有意になった。&lt;/p&gt;
&lt;p&gt;傾向スコアを推定した場合としていない場合とでは点推定値および信頼区間には大きな差はなかった。&lt;/p&gt;
&lt;p&gt;##【reference】&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Citation
Shiroshita, Akihiro (2020), Effectiveness of steroid therapy on pneumonic chronic obstructive pulmonary disease exacerbation: a multi-centred retrospective cohort study, v3, Dryad, Dataset, &lt;a href=&#34;https://doi.org/10.5061/dryad.m63xsj3zd&#34; class=&#34;uri&#34;&gt;https://doi.org/10.5061/dryad.m63xsj3zd&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Fan Li, Alan M Zaslavsky, Mary Beth Landrum
Propensity socre weighing with multilevel data. Stat Med. 2013.30;32(19):3373 - 87.&lt;/p&gt;
&lt;p&gt;P.Austin
Variance estimation when using inverse probability of treatment weighting with survival analysis.
Stat Med. 2016.35(30):5642 - 55.&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Stataによる線形回帰モデルの実装</title>
      <link>/post/linear_regression/</link>
      <pubDate>Sun, 26 Jul 2020 18:40:12 +0900</pubDate>
      <guid>/post/linear_regression/</guid>
      <description>&lt;h1 id=&#34;stataによる線形回帰モデル&#34;&gt;Stataによる線形回帰モデル&lt;/h1&gt;
&lt;p&gt;Stataによる線形回帰モデルを実装する。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;# dataの読み込み

use https://www.stata-press.com/data/r16/lbw
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;Unknown #command
(Hosmer &amp;amp; Lemeshow data)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;公式サイトのデータより読み込み&lt;/p&gt;
&lt;p&gt;189人の出生児の体重に関する研究のデータ&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;describe
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;Contains data from https://www.stata-press.com/data/r16/lbw.dta
  obs:           189                          Hosmer &amp;amp; Lemeshow data
 vars:            11                          15 Jan 2018 05:01
--------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
--------------------------------------------------------------------------------
id              int     %8.0g                 identification code
low             byte    %8.0g                 birthweight&amp;lt;2500g
age             byte    %8.0g                 age of mother
lwt             int     %8.0g                 weight at last menstrual period
race            byte    %8.0g      race       race
smoke           byte    %9.0g      smoke      smoked during pregnancy
ptl             byte    %8.0g                 premature labor history (count)
ht              byte    %8.0g                 has history of hypertension
ui              byte    %8.0g                 presence, uterine irritability
ftv             byte    %8.0g                 number of visits to physician
                                                during 1st trimester
bwt             int     %8.0g                 birthweight (grams)
--------------------------------------------------------------------------------
Sorted by: 
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;データの分析&#34;&gt;データの分析&lt;/h2&gt;
&lt;p&gt;まずデータの分析を行う。&lt;/p&gt;
&lt;p&gt;目的変数は出生時の体重である。&lt;/p&gt;
&lt;p&gt;母体の年齢や喫煙などが関与していることが予想される。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;su age bwt smoke, detail
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;                        age of mother
-------------------------------------------------------------
      Percentiles      Smallest
 1%           14             14
 5%           16             14
10%           17             14       Obs                 189
25%           19             15       Sum of Wgt.         189

50%           23                      Mean            23.2381
                        Largest       Std. Dev.      5.298678
75%           26             35
90%           31             36       Variance       28.07599
95%           32             36       Skewness       .7164391
99%           36             45       Kurtosis       3.568442

                     birthweight (grams)
-------------------------------------------------------------
      Percentiles      Smallest
 1%         1021            709
 5%         1790           1021
10%         1970           1135       Obs                 189
25%         2414           1330       Sum of Wgt.         189

50%         2977                      Mean           2944.286
                        Largest       Std. Dev.       729.016
75%         3475           4174
90%         3884           4238       Variance       531464.4
95%         3997           4593       Skewness      -.2069782
99%         4593           4990       Kurtosis       2.888821

                   smoked during pregnancy
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%            0              0       Obs                 189
25%            0              0       Sum of Wgt.         189

50%            0                      Mean           .3915344
                        Largest       Std. Dev.      .4893898
75%            1              1
90%            1              1       Variance       .2395024
95%            1              1       Skewness       .4444461
99%            1              1       Kurtosis       1.197532
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;tabulate low smoke, chi2 column
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;+-------------------+
| Key               |
|-------------------|
|     frequency     |
| column percentage |
+-------------------+

           |     smoked during
birthweigh |       pregnancy
   t&amp;lt;2500g | nonsmoker     smoker |     Total
-----------+----------------------+----------
         0 |        86         44 |       130 
           |     74.78      59.46 |     68.78 
-----------+----------------------+----------
         1 |        29         30 |        59 
           |     25.22      40.54 |     31.22 
-----------+----------------------+----------
     Total |       115         74 |       189 
           |    100.00     100.00 |    100.00 

          Pearson chi2(1) =   4.9237   Pr = 0.026
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;低体重と母体の喫煙歴の関係を見ると、明らかに喫煙歴のある母体の方が低体重出生児が多い。&lt;/p&gt;
&lt;p&gt;$$\chi^2$$検定でも有意に喫煙歴がある方が低体重出生児が多いという結果であった。&lt;/p&gt;
&lt;h3 id=&#34;グラフで可視化する&#34;&gt;グラフで可視化する&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;# ヒストグラム作成

hist bwt, bin(25)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;./output_10_1.pdf&#34; alt=&#34;pdf&#34;&gt;&lt;/p&gt;
&lt;p&gt;次は散布図を作成する&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;# 散布図を作成

scatter bwt age
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;./output_11_1.pdf&#34; alt=&#34;pdf&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;線形回帰モデルの作成&#34;&gt;線形回帰モデルの作成&lt;/h2&gt;
&lt;p&gt;出生時の体重と母体の年齢が線形であると仮定すると、&lt;/p&gt;
&lt;p&gt;$$Y_{i(bwt)} = \beta_0 + \beta*x_{i(age)} + \epsilon$$&lt;/p&gt;
&lt;p&gt;と表すことができる。&lt;/p&gt;
&lt;p&gt;$$\epsilon$$は残差である。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;regress bwt age
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;      Source |       SS           df       MS      Number of obs   =       189
-------------+----------------------------------   F(1, 187)       =      1.51
       Model |  800428.169         1  800428.169   Prob &amp;gt; F        =    0.2207
    Residual |  99114870.4       187  530026.045   R-squared       =    0.0080
-------------+----------------------------------   Adj R-squared   =    0.0027
       Total |  99915298.6       188  531464.354   Root MSE        =    728.03

------------------------------------------------------------------------------
         bwt |      Coef.   Std. Err.      t    P&amp;gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         age |   12.31444   10.02079     1.23   0.221     -7.45389    32.08277
       _cons |   2658.122   238.8097    11.13   0.000     2187.014    3129.229
------------------------------------------------------------------------------
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;回帰式のモデルの結果は、&lt;/p&gt;
&lt;p&gt;$$Y_{i(bwt)} = 12.31*x_{i(age)} + 2658.122$$&lt;/p&gt;
&lt;p&gt;である。&lt;/p&gt;
&lt;p&gt;つまり母体の年齢が1歳増えるごとに12.31gずつ体重が増えることになる。&lt;/p&gt;
&lt;p&gt;しかし、そもそも母体の年齢と体重には線形の関係がはっきりはなさそうである。&lt;/p&gt;
&lt;p&gt;今回のモデルの決定係数も0.0027と非常に低い。&lt;/p&gt;
&lt;p&gt;むしろ他のモデルを考えた方が良さそうである。&lt;/p&gt;
&lt;h2 id=&#34;重回帰モデル&#34;&gt;重回帰モデル&lt;/h2&gt;
&lt;p&gt;先のモデルでは、年齢と低体重出生児との関係はあまりなさそうであった。&lt;/p&gt;
&lt;p&gt;むしろモデルには喫煙歴などを含めた方がよいモデルができる可能性が高い。&lt;/p&gt;
&lt;p&gt;今度は母体の喫煙歴、年齢、人種で調整したモデルの作成を行う。&lt;/p&gt;
&lt;p&gt;$$Y_{i(bwt)} = \beta_0 + \beta_1*x_{i(smoke)} + \beta_2*x_{i(age)} + \beta_3*x_{i(race)} + \epsilon$$&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;regress bwt smoke age i.race
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;      Source |       SS           df       MS      Number of obs   =       189
-------------+----------------------------------   F(4, 184)       =      6.50
       Model |  12366825.4         4  3091706.34   Prob &amp;gt; F        =    0.0001
    Residual |  87548473.2       184   475806.92   R-squared       =    0.1238
-------------+----------------------------------   Adj R-squared   =    0.1047
       Total |  99915298.6       188  531464.354   Root MSE        =    689.79

------------------------------------------------------------------------------
         bwt |      Coef.   Std. Err.      t    P&amp;gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       smoke |  -425.5563   109.9505    -3.87   0.000    -642.4822   -208.6304
         age |   1.998899   9.767361     0.20   0.838    -17.27152    21.26932
             |
        race |
      black  |  -444.6489   156.1404    -2.85   0.005    -752.7047   -136.5931
      other  |   -449.481   118.9765    -3.78   0.000    -684.2147   -214.7474
             |
       _cons |   3284.964   260.5749    12.61   0.000     2770.865    3799.062
------------------------------------------------------------------------------
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;今回のモデルではProb &amp;gt; Fを見ると、このモデルは有意であり、調整決定係数も最初のモデルより改善している。&lt;/p&gt;
&lt;p&gt;それでも係数は低く、あまりこのモデルでは説明できていないことになる。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;estat esize
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;Effect sizes for linear models

-----------------------------------------------------------------
             Source | Eta-Squared     df     [95% Conf. Interval]
--------------------+--------------------------------------------
              Model |   .1237731       4     .0358881    .1997528
                    |
              smoke |   .0752852       1     .0183756    .1560631
                age |   .0002276       1            .    .0199652
               race |   .0847912       2     .0197304    .1627342
-----------------------------------------------------------------
Note: Eta-Squared values for individual model terms are partial.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;このコマンドをすることでこのモデル式の全体での効果サイズが分かる。&lt;/p&gt;
&lt;p&gt;全体では0.124であり、修正前の決定係数と同じ値である。&lt;/p&gt;
&lt;p&gt;つまり修正前の決定係数によれば、bwtの変化の約12.4%がこのモデルによって説明されることを示している。&lt;/p&gt;
&lt;p&gt;下の数値は各変数の効果サイズで、smokeは他のすべての項で説明されている変化を除いて約7.7%bwtの変化を説明
できることを意味する。&lt;/p&gt;
&lt;h2 id=&#34;モデルの評価&#34;&gt;モデルの評価&lt;/h2&gt;
&lt;p&gt;線形回帰モデルでは残差の正規性と等分散性が前提となっている。&lt;/p&gt;
&lt;p&gt;そのため、それを確認する必要がある。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;# 推定値を求める

regress bwt smoke age i.race
predict re, residuals
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;Unknown #command

      Source |       SS           df       MS      Number of obs   =       189
-------------+----------------------------------   F(4, 184)       =      6.50
       Model |  12366825.4         4  3091706.34   Prob &amp;gt; F        =    0.0001
    Residual |  87548473.2       184   475806.92   R-squared       =    0.1238
-------------+----------------------------------   Adj R-squared   =    0.1047
       Total |  99915298.6       188  531464.354   Root MSE        =    689.79

------------------------------------------------------------------------------
         bwt |      Coef.   Std. Err.      t    P&amp;gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       smoke |  -425.5563   109.9505    -3.87   0.000    -642.4822   -208.6304
         age |   1.998899   9.767361     0.20   0.838    -17.27152    21.26932
             |
        race |
      black  |  -444.6489   156.1404    -2.85   0.005    -752.7047   -136.5931
      other  |   -449.481   118.9765    -3.78   0.000    -684.2147   -214.7474
             |
       _cons |   3284.964   260.5749    12.61   0.000     2770.865    3799.062
------------------------------------------------------------------------------
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;### 残差の正規性の確認

hist re, normal
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;./output_22_1.pdf&#34; alt=&#34;pdf&#34;&gt;&lt;/p&gt;
&lt;p&gt;正規性は保たれているようである。&lt;/p&gt;
&lt;h4 id=&#34;qq-plot&#34;&gt;QQ plot&lt;/h4&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;
qnorm re
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;./output_23_1.pdf&#34; alt=&#34;pdf&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;統計学的検定&#34;&gt;統計学的検定&lt;/h4&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;
sktest re
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;Skewness and kurtosis tests for normality
                                                         ----- Joint test -----
    Variable |       Obs   Pr(skewness)   Pr(kurtosis)   Adj chi2(2)  Prob&amp;gt;chi2
-------------+-----------------------------------------------------------------
          re |       189         0.0555         0.9848          3.71     0.1564
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;帰無仮説は「残差に正規性がある」である。&lt;/p&gt;
&lt;p&gt;棄却されると正規性がないことになる。&lt;/p&gt;
&lt;h3 id=&#34;等分散性の確認&#34;&gt;等分散性の確認&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;rvfplot, yline(0)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;./output_27_0.pdf&#34; alt=&#34;pdf&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;統計学的検定-1&#34;&gt;統計学的検定&lt;/h4&gt;
&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;

hettest
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;Breusch-Pagan / Cook-Weisberg test for heteroskedasticity 
         Ho: Constant variance
         Variables: fitted values of bwt

         chi2(1)      =     0.00
         Prob &amp;gt; chi2  =   0.9961
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;棄却されないので、等分散性は少なくとも否定はされないことになる。&lt;/p&gt;
&lt;h4 id=&#34;参考文献&#34;&gt;参考文献&lt;/h4&gt;
&lt;p&gt;Stata公式資料&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.stata-press.com&#34;&gt;https://www.stata-press.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;講義プリント&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Rによるマルチレベル分析の実装</title>
      <link>/post/multilevel/</link>
      <pubDate>Sat, 25 Jul 2020 18:40:12 +0900</pubDate>
      <guid>/post/multilevel/</guid>
      <description>


&lt;div id=&#34;サンプルデータを作成する&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;サンプルデータを作成する&lt;/h3&gt;
&lt;p&gt;以前の「Rによる傾向スコアの実装」で使用したデータと同じ仮想データを用いる。&lt;/p&gt;
&lt;p&gt;適当なデータがないため、仮想データを作成する。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Effect of Targeted Polymyxin B Hemoperfusion on 28-Day Mortality in Patients With Septic Shock and Elevated Endotoxin Level&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The EUPHRATES Randomized Clinical Trialより&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;元ネタは敗血症性ショックに対するエンドトキシン吸着療法の多施設共同RCT(60施設)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;PMX療法(透析)対シャム療法(偽透析：透析している振り)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;サンプル数:450名のRCT&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Age, Sex, 平均血圧(Arterial pressure mean:MAP)、重症度スコア(APACHEⅡ)、人工呼吸器の有無(Mechanical&lt;br /&gt;
ventilation)、菌血症の有無(Bacteremia)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;介入:エンドトキシン吸着療法(PMX)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;アウトカム:28日後死亡(twentyeight_day_mortality)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;今回は多施設観察研究と想定し施設数も作成して、10施設とする&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;JAMA&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://jamanetwork.com/journals/jama/fullarticle/2706139&#34; class=&#34;uri&#34;&gt;https://jamanetwork.com/journals/jama/fullarticle/2706139&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;パッケージの読み込み&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;パッケージの読み込み&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(dplyr)
# パイプを使うため
library(magrittr)
# シミュレーションデータを作るため
library(simstudy)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;仮想データの実装&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;仮想データの実装&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;set.seed(123) # seedを設定することで必ず同じデータが毎回できるので再現性の固定
# まず施設IDの作成
b &amp;lt;- defData(varname = &amp;quot;institution_id&amp;quot;, dist = &amp;quot;noZeroPoisson&amp;quot;, formula = 3)
c &amp;lt;- genData(450, b)

# 各変数の作成
a &amp;lt;- data.frame(rnorm(450,59,8),rbinom(450,1,prob=0.6),rnorm(450,72,5),rnorm(450,28,5),rbinom(450,1,0.94)
               ,rbinom(450,1,0.30),rbinom(450,1,0.5),rbinom(450,1,0.34))

colnames(a) &amp;lt;- c(&amp;#39;Age&amp;#39;,&amp;#39;Sex&amp;#39;,&amp;#39;MAP&amp;#39;,&amp;#39;APACHEⅡ&amp;#39;,&amp;#39;Mechanical_ventilation&amp;#39;,&amp;#39;Bacteremia&amp;#39;,&amp;#39;PMX&amp;#39;,&amp;#39;twentyeight_day_mortality&amp;#39;)
# 列の名前を付ける 
# sex 1=male, Mechanical_ventilation yes=1, Bacteremia yes=1, PMX yes=1, 28day_mortality yes=1 &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;両者を結合する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;pmx &amp;lt;- cbind.data.frame(c,a)

pmx &amp;lt;- as.data.frame(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;作成したデータの確認&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;作成したデータの確認&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##        id        institution_id        Age             Sex        
##  Min.   :  1.0   Min.   : 1.000   Min.   :36.52   Min.   :0.0000  
##  1st Qu.:113.2   1st Qu.: 2.000   1st Qu.:54.19   1st Qu.:0.0000  
##  Median :225.5   Median : 3.000   Median :59.33   Median :1.0000  
##  Mean   :225.5   Mean   : 3.142   Mean   :59.11   Mean   :0.5822  
##  3rd Qu.:337.8   3rd Qu.: 4.000   3rd Qu.:64.59   3rd Qu.:1.0000  
##  Max.   :450.0   Max.   :10.000   Max.   :79.57   Max.   :1.0000  
##       MAP           APACHEⅡ      Mechanical_ventilation   Bacteremia    
##  Min.   :59.25   Min.   :12.76   Min.   :0.0000         Min.   :0.0000  
##  1st Qu.:68.47   1st Qu.:25.05   1st Qu.:1.0000         1st Qu.:0.0000  
##  Median :71.81   Median :28.54   Median :1.0000         Median :0.0000  
##  Mean   :72.00   Mean   :28.30   Mean   :0.9267         Mean   :0.2689  
##  3rd Qu.:75.03   3rd Qu.:31.90   3rd Qu.:1.0000         3rd Qu.:1.0000  
##  Max.   :88.95   Max.   :44.45   Max.   :1.0000         Max.   :1.0000  
##       PMX         twentyeight_day_mortality
##  Min.   :0.0000   Min.   :0.0000           
##  1st Qu.:0.0000   1st Qu.:0.0000           
##  Median :0.0000   Median :0.0000           
##  Mean   :0.4889   Mean   :0.3467           
##  3rd Qu.:1.0000   3rd Qu.:1.0000           
##  Max.   :1.0000   Max.   :1.0000&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;str(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    450 obs. of  10 variables:
##  $ id                       : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ institution_id           : num  2 4 3 5 6 1 3 5 3 3 ...
##  $ Age                      : num  59.5 53.4 53.3 66.1 50.9 ...
##  $ Sex                      : int  1 1 1 1 1 1 1 0 1 1 ...
##  $ MAP                      : num  66.9 68 73.5 80.2 77.4 ...
##  $ APACHEⅡ                  : num  27.3 20.8 24 32.4 32.5 ...
##  $ Mechanical_ventilation   : int  1 1 1 1 1 1 1 1 0 1 ...
##  $ Bacteremia               : int  0 0 0 0 0 1 1 0 0 0 ...
##  $ PMX                      : int  0 0 0 1 0 0 0 0 1 1 ...
##  $ twentyeight_day_mortality: int  1 0 0 0 0 1 0 0 1 0 ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;おおむね狙い通りのデータになっていることが分かる。&lt;/p&gt;
&lt;p&gt;今回は２つの解析を行う。&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;p&gt;マルチレベルロジスティック回帰モデルを実装する。&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;前回と違い施設というクラスターを含めて傾向スコアを用いて解析を実装する。&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;まずは1のマルチレベルロジスティック回帰について実装する。&lt;/p&gt;
&lt;p&gt;モデルを２つ作成する。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;モデル1:クラスター効果を無視した多変量ロジスティック回帰&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;モデル2:クラスター効果を加えたマルチレベルロジスティック回帰&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div id=&#34;モデル1-多変量ロジスティック回帰&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデル1 多変量ロジスティック回帰&lt;/h3&gt;
&lt;p&gt;最初に通常のロジスティック回帰を行う。&lt;/p&gt;
&lt;p&gt;このモデルではクラスター効果を無視してモデルを作る。&lt;/p&gt;
&lt;p&gt;つまり結果には施設間の差は影響しないという仮定である。&lt;/p&gt;
&lt;p&gt;そのため個人レベルでの変数のみが影響するとしてモデルを作成する。&lt;/p&gt;
&lt;p&gt;被検者iの死亡する確率を&lt;span class=&#34;math inline&#34;&gt;\(p_i\)&lt;/span&gt;とすると、(すなわち死亡という場合の条件付き確率)&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(logit(p_i) = log odds = log(\frac{p_i}{1-p_i}) = M + e_i\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;と表すことができる。&lt;/p&gt;
&lt;p&gt;ここで、Mはロジスティック尺度で表された集団全体の平均確率、&lt;span class=&#34;math inline&#34;&gt;\(e_i\)&lt;/span&gt;はiの残差である。&lt;/p&gt;
&lt;p&gt;モデル1では各個人レベルの変数が死亡する確率に影響を与えていると考える。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(logit(p_i) = M + \beta_1*PMX_i + \beta_2*Age_i + \beta_3*Sex_i + \beta_4*APACH_i + \beta_5*Ven_i + e_i\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;として表すことができる。&lt;/p&gt;
&lt;div id=&#34;共変量の設定&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;共変量の設定&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;covariateName_nc &amp;lt;- c(
  &amp;quot;PMX&amp;quot;,&amp;quot;Age&amp;quot;,&amp;quot;Sex&amp;quot;,&amp;quot;MAP&amp;quot;, &amp;quot;APACHEⅡ&amp;quot;, &amp;quot;Mechanical_ventilation&amp;quot;
  )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;式の作成&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;式の作成&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;nc.formula &amp;lt;- paste(covariateName_nc, collapse=&amp;quot;+&amp;quot;) 
nc.formula &amp;lt;- formula(paste(&amp;quot;twentyeight_day_mortality~&amp;quot;,nc.formula))
print(nc.formula)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## twentyeight_day_mortality ~ PMX + Age + Sex + MAP + APACHEⅡ + 
##     Mechanical_ventilation&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;ロジスティック回帰&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;ロジスティック回帰&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;model_nc &amp;lt;- pmx %&amp;gt;% glm(nc.formula, data = ., family = binomial(link = &amp;quot;logit&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;結果の確認&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;結果の確認&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(model_nc)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## glm(formula = nc.formula, family = binomial(link = &amp;quot;logit&amp;quot;), 
##     data = .)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.4461  -0.9199  -0.8317   1.3800   1.7795  
## 
## Coefficients:
##                         Estimate Std. Error z value Pr(&amp;gt;|z|)  
## (Intercept)            -0.457777   1.768631  -0.259   0.7958  
## PMX                     0.145555   0.200801   0.725   0.4685  
## Age                    -0.013387   0.012768  -1.048   0.2944  
## Sex                     0.191703   0.205746   0.932   0.3515  
## MAP                     0.005604   0.020071   0.279   0.7801  
## APACHEⅡ                 0.029188   0.020369   1.433   0.1519  
## Mechanical_ventilation -0.873933   0.367343  -2.379   0.0174 *
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 580.82  on 449  degrees of freedom
## Residual deviance: 570.18  on 443  degrees of freedom
## AIC: 584.18
## 
## Number of Fisher Scoring iterations: 4&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;オッズ比へ変換する&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# オッズ比と95%信頼区間の確認
nc_odds &amp;lt;- as.data.frame(cbind(exp(summary(model_nc)$coefficient[,1]),exp(confint(model_nc))
                                    ,summary(model_nc)$coefficient[,4]))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Waiting for profiling to be done...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# result_oddsというデータフレームの列名を名付ける
names(nc_odds) &amp;lt;- c(&amp;quot;Odds ratio&amp;quot;,&amp;quot;lower 95%CI&amp;quot;,&amp;quot;upper 95%CI&amp;quot;,&amp;quot;P value&amp;quot;)
# 小数点２桁で結果を表示
round(nc_odds,2)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##                        Odds ratio lower 95%CI upper 95%CI P value
## (Intercept)                  0.63        0.02       20.42    0.80
## PMX                          1.16        0.78        1.72    0.47
## Age                          0.99        0.96        1.01    0.29
## Sex                          1.21        0.81        1.82    0.35
## MAP                          1.01        0.97        1.05    0.78
## APACHEⅡ                      1.03        0.99        1.07    0.15
## Mechanical_ventilation       0.42        0.20        0.86    0.02&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(pROC)

ROC_nc &amp;lt;- roc(response = pmx$twentyeight_day_mortality, predictor = model_nc$fitted.values)
ROC_nc&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## roc.default(response = pmx$twentyeight_day_mortality, predictor = model_nc$fitted.values)
## 
## Data: model_nc$fitted.values in 294 controls (pmx$twentyeight_day_mortality 0) &amp;lt; 156 cases (pmx$twentyeight_day_mortality 1).
## Area under the curve: 0.598&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;AUC 0.598でモデルの精度は良くないことが分かる。&lt;/p&gt;
&lt;p&gt;結果としては、PMXはOR 1.16 (95%CI:0.78 - 1.72)で死亡を減らす関係は認めなかった。&lt;/p&gt;
&lt;p&gt;むしろ点推定値と信頼区間を考慮すると若干死亡を高める方向に働いている可能性もある。&lt;/p&gt;
&lt;p&gt;しかしAUCが低いことから、そもそもこのモデルの精度が良くないため共変量などについて再考する必要がありそう。&lt;/p&gt;
&lt;p&gt;＊人工呼吸器の使用で死亡が減る方向になっている結果は、シミュレーションデータなので今回は無視する。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;モデル2マルチレベルロジスティック回帰&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデル2:マルチレベルロジスティック回帰&lt;/h3&gt;
&lt;p&gt;このモデルではクラスター効果を考慮してモデルを作る。&lt;/p&gt;
&lt;p&gt;回帰モデルでは観測値の独立性が前提となっている。&lt;/p&gt;
&lt;p&gt;しかし各施設内では同じような治療がなされ治療成績が似通っている可能性がある。&lt;/p&gt;
&lt;p&gt;逆に言えば施設間でPMXの適応や手技の成熟度、集中治療のレベルなどが違う可能性があり、&lt;/p&gt;
&lt;p&gt;個人レベルでの変数のみではなく施設も影響するとしてモデルを作成する必要がある。&lt;/p&gt;
&lt;p&gt;施設という階層があり、その下に個人レベルの変数があるという形である。&lt;/p&gt;
&lt;p&gt;施設jに所属の個人iの死亡する確率&lt;span class=&#34;math inline&#34;&gt;\(p_{ij}\)&lt;/span&gt;は、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;レベル1(個人レベル): &lt;span class=&#34;math inline&#34;&gt;\(logit(p_{ij}) = M_{0j} + e_{ij}\)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;レベル2(集団レベル): &lt;span class=&#34;math inline&#34;&gt;\(M_{oj} = \gamma_{00} + u_{0j}\)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;として表すことができる。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(M_{0j}\)&lt;/span&gt;は集団jの死亡する平均確率、&lt;span class=&#34;math inline&#34;&gt;\(e_{ij}\)&lt;/span&gt;は集団jでの個人間の残差を表している。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(\gamma_{00}\)&lt;/span&gt;は集団全体の死亡する平均確率、&lt;span class=&#34;math inline&#34;&gt;\(u_{0j}\)&lt;/span&gt;は集団間の変動を表す。&lt;/p&gt;
&lt;p&gt;マルチレベルモデルでは集団によって変動しない値を固定効果(fixed effect)、
&lt;span class=&#34;math inline&#34;&gt;\(u_{oj}\)&lt;/span&gt;のように変動する値を変量効果(random effedt)と呼ぶ。&lt;/p&gt;
&lt;p&gt;それぞれが従う分布は平均0、個人レベルの分散&lt;span class=&#34;math inline&#34;&gt;\(V_I\)&lt;/span&gt;、集団レベルの分散&lt;span class=&#34;math inline&#34;&gt;\(V_C\)&lt;/span&gt;として、&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(e_{ij}\)&lt;/span&gt; ~ &lt;span class=&#34;math inline&#34;&gt;\(N(0,V_I)\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(u_{0j}\)&lt;/span&gt; ~ &lt;span class=&#34;math inline&#34;&gt;\(N(0,V_C)\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;の正規分布に従うことが仮定される。&lt;/p&gt;
&lt;p&gt;最終的にモデル2は、&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(logit(p_ij) = \gamma_{00} + u_{0j} + \beta_1*PMX_{ij} + \beta_2*Age_{ij} + \beta_3*Sex_{ij} + \beta_4*APACH_{ij} + \beta_5*Ven_{ij} + e_{ij}\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;として表すことができる。&lt;/p&gt;
&lt;div id=&#34;共変量の設定-1&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;共変量の設定&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;covariateName_c &amp;lt;- c(
  &amp;quot;PMX&amp;quot;,&amp;quot;Age&amp;quot;,&amp;quot;Sex&amp;quot;,&amp;quot;MAP&amp;quot;, &amp;quot;APACHEⅡ&amp;quot;, &amp;quot;Mechanical_ventilation&amp;quot;
  )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;式の作成-1&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;式の作成&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;c.formula &amp;lt;- paste(covariateName_c, collapse=&amp;quot;+&amp;quot;) 
c.formula &amp;lt;- formula(paste(&amp;quot;twentyeight_day_mortality~&amp;quot;,c.formula,&amp;quot;+(1|institution_id)&amp;quot;))
print(c.formula)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## twentyeight_day_mortality ~ PMX + Age + Sex + MAP + APACHEⅡ + 
##     Mechanical_ventilation + (1 | institution_id)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;マルチレベルロジスティック回帰&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;マルチレベルロジスティック回帰&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(lme4)
model_c &amp;lt;- pmx %&amp;gt;% glmer(c.formula, data = ., family = binomial(link = &amp;quot;logit&amp;quot;), control = glmerControl(optimizer = &amp;quot;bobyqa&amp;quot;),
    nAGQ = 10)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;結果の確認-1&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;結果の確認&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;print(model_c, corr = FALSE)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Generalized linear mixed model fit by maximum likelihood (Adaptive
##   Gauss-Hermite Quadrature, nAGQ = 10) [glmerMod]
##  Family: binomial  ( logit )
## Formula: twentyeight_day_mortality ~ PMX + Age + Sex + MAP + APACHEⅡ +  
##     Mechanical_ventilation + (1 | institution_id)
##    Data: .
##       AIC       BIC    logLik  deviance  df.resid 
##  586.1784  619.0524 -285.0892  570.1784       442 
## Random effects:
##  Groups         Name        Std.Dev.
##  institution_id (Intercept) 0       
## Number of obs: 450, groups:  institution_id, 10
## Fixed Effects:
##            (Intercept)                     PMX                     Age  
##              -0.457777                0.145555               -0.013387  
##                    Sex                     MAP                 APACHEⅡ  
##               0.191703                0.005604                0.029188  
## Mechanical_ventilation  
##              -0.873933  
## convergence code 0; 0 optimizer warnings; 1 lme4 warnings&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;95%信頼区間を求める&lt;/p&gt;
&lt;p&gt;通常の方法では出せないので注意&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;se &amp;lt;- sqrt(diag(vcov(model_c)))
# table of estimates with 95% CI
(tab &amp;lt;- cbind(Est = fixef(model_c), LL = fixef(model_c) - 1.96 * se, UL = fixef(model_c) + 1.96 *
    se))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##                                 Est          LL          UL
## (Intercept)            -0.457777126 -3.92314409  3.00758984
## PMX                     0.145554945 -0.24801464  0.53912453
## Age                    -0.013386704 -0.03840952  0.01163611
## Sex                     0.191702790 -0.21155879  0.59496437
## MAP                     0.005604172 -0.03371708  0.04492542
## APACHEⅡ                 0.029187831 -0.01073457  0.06911023
## Mechanical_ventilation -0.873933310 -1.59392402 -0.15394260&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;オッズ比を求める&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;round(exp(tab),2)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##                         Est   LL    UL
## (Intercept)            0.63 0.02 20.24
## PMX                    1.16 0.78  1.71
## Age                    0.99 0.96  1.01
## Sex                    1.21 0.81  1.81
## MAP                    1.01 0.97  1.05
## APACHEⅡ                1.03 0.99  1.07
## Mechanical_ventilation 0.42 0.20  0.86&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;今回の結果は、ランダム効果の分散は0であり、目的変数には集団による違いはないことになる。&lt;/p&gt;
&lt;p&gt;実際、モデル1とモデル2では結果はほぼ同じである。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;級内相関係数&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;級内相関係数&lt;/h4&gt;
&lt;p&gt;病院などの集団内でデータがどの程度類似しているかを検討するための指標として、級内相関係数(ICC)がある。&lt;/p&gt;
&lt;p&gt;ICCが大きいほど観測値の独立性の仮定からの逸脱が大きいことを意味する。&lt;/p&gt;
&lt;p&gt;線形回帰モデルと違いロジスティック回帰モデルでは解釈が難しい。&lt;/p&gt;
&lt;p&gt;なぜなら、集団内での分散はロジスティック尺度上にあり、個人レベルの分散は確率であるからである。
(二項分布の分散Vはp(1-p)である。)&lt;/p&gt;
&lt;p&gt;いくつか計算する方法はあるが今回は分散が0のためICCは計算できない。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;tau2 &amp;lt;- lme4::VarCorr(model_c)
tau2&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  Groups         Name        Std.Dev.
##  institution_id (Intercept) 0&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;参考文献&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;参考文献&lt;/h3&gt;
&lt;p&gt;Peter C Austin, Juan Merlo. Intermediate and advanced topics in multilevel logistic regression analysis.
Stat Med. 2017. 10;36(20):3257 - 3277.
&lt;a href=&#34;PMID:28543517&#34; class=&#34;uri&#34;&gt;PMID:28543517&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Juan Merlo, Basile Chais, et.al. A brief conceptual tutorial of multilevel analysis in social epidemiology: using measures of clustering in multilevel logistic regression to investigate contextual phenomena. J Epidemiol Community Health 2006;60:290–297.
&lt;a href=&#34;PMID:15911637&#34; class=&#34;uri&#34;&gt;PMID:15911637&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Three methods for computing the intra-class correlation in multilevel logistic regression&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.barelysignificant.com/post/icc/&#34; class=&#34;uri&#34;&gt;https://www.barelysignificant.com/post/icc/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;MIXED EFFECTS LOGISTIC REGRESSION | R DATA ANALYSIS EXAMPLES&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/&#34; class=&#34;uri&#34;&gt;https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Rによる傾向スコアの実装</title>
      <link>/post/propensity_score/</link>
      <pubDate>Wed, 22 Jul 2020 22:16:38 +0900</pubDate>
      <guid>/post/propensity_score/</guid>
      <description>


&lt;div id=&#34;サンプルデータを作成する&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;サンプルデータを作成する&lt;/h3&gt;
&lt;p&gt;適当なパッケージがないため、仮想データを作成する。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Effect of Targeted Polymyxin B Hemoperfusion on 28-Day Mortality in Patients With Septic Shock and Elevated Endotoxin Level&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The EUPHRATES Randomized Clinical Trialより&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;元ネタは敗血症性ショックに対するエンドトキシン吸着療法の多施設共同RCT(60施設)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;PMX療法(透析)対シャム療法(偽透析：透析している振り)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;サンプル数:450名のRCT&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Age, Sex, 平均血圧(Arterial pressure mean:MAP)、重症度スコア(APACHEⅡ)、人工呼吸器の有無(Mechanical&lt;br /&gt;
ventilation)、菌血症の有無(Bacteremia)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;介入:エンドトキシン吸着療法(PMX)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;アウトカム:28日後死亡(twentyeight_day_mortality)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;今回は多施設観察研究と想定し施設数も作成して、10施設とする&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;JAMA&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://jamanetwork.com/journals/jama/fullarticle/2706139&#34; class=&#34;uri&#34;&gt;https://jamanetwork.com/journals/jama/fullarticle/2706139&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;パッケージの読み込み&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;パッケージの読み込み&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(dplyr)
# パイプを使うため
library(magrittr)
# シミュレーションデータを作るため
library(simstudy)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;仮想データの実装&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;仮想データの実装&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;set.seed(123) # seedを設定することで必ず同じデータが毎回できるので再現性の固定
# まず施設IDの作成
b &amp;lt;- defData(varname = &amp;quot;institution_id&amp;quot;, dist = &amp;quot;noZeroPoisson&amp;quot;, formula = 3)
c &amp;lt;- genData(450, b)

# 各変数の作成
a &amp;lt;- data.frame(rnorm(450,59,8),rbinom(450,1,prob=0.6),rnorm(450,72,5),rnorm(450,28,5),rbinom(450,1,0.94)
               ,rbinom(450,1,0.30),rbinom(450,1,0.5),rbinom(450,1,0.34))

colnames(a) &amp;lt;- c(&amp;#39;Age&amp;#39;,&amp;#39;Sex&amp;#39;,&amp;#39;MAP&amp;#39;,&amp;#39;APACHEⅡ&amp;#39;,&amp;#39;Mechanical_ventilation&amp;#39;,&amp;#39;Bacteremia&amp;#39;,&amp;#39;PMX&amp;#39;,&amp;#39;twentyeight_day_mortality&amp;#39;)
# 列の名前を付ける 
# sex 1=male, Mechanical_ventilation yes=1, Bacteremia yes=1, PMX yes=1, 28day_mortality yes=1 &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;両者を結合する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;pmx &amp;lt;- cbind.data.frame(c,a)

pmx &amp;lt;- as.data.frame(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;作成したデータの確認&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;作成したデータの確認&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##        id        institution_id        Age             Sex        
##  Min.   :  1.0   Min.   : 1.000   Min.   :36.52   Min.   :0.0000  
##  1st Qu.:113.2   1st Qu.: 2.000   1st Qu.:54.19   1st Qu.:0.0000  
##  Median :225.5   Median : 3.000   Median :59.33   Median :1.0000  
##  Mean   :225.5   Mean   : 3.142   Mean   :59.11   Mean   :0.5822  
##  3rd Qu.:337.8   3rd Qu.: 4.000   3rd Qu.:64.59   3rd Qu.:1.0000  
##  Max.   :450.0   Max.   :10.000   Max.   :79.57   Max.   :1.0000  
##       MAP           APACHEⅡ      Mechanical_ventilation   Bacteremia    
##  Min.   :59.25   Min.   :12.76   Min.   :0.0000         Min.   :0.0000  
##  1st Qu.:68.47   1st Qu.:25.05   1st Qu.:1.0000         1st Qu.:0.0000  
##  Median :71.81   Median :28.54   Median :1.0000         Median :0.0000  
##  Mean   :72.00   Mean   :28.30   Mean   :0.9267         Mean   :0.2689  
##  3rd Qu.:75.03   3rd Qu.:31.90   3rd Qu.:1.0000         3rd Qu.:1.0000  
##  Max.   :88.95   Max.   :44.45   Max.   :1.0000         Max.   :1.0000  
##       PMX         twentyeight_day_mortality
##  Min.   :0.0000   Min.   :0.0000           
##  1st Qu.:0.0000   1st Qu.:0.0000           
##  Median :0.0000   Median :0.0000           
##  Mean   :0.4889   Mean   :0.3467           
##  3rd Qu.:1.0000   3rd Qu.:1.0000           
##  Max.   :1.0000   Max.   :1.0000&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;str(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    450 obs. of  10 variables:
##  $ id                       : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ institution_id           : num  2 4 3 5 6 1 3 5 3 3 ...
##  $ Age                      : num  59.5 53.4 53.3 66.1 50.9 ...
##  $ Sex                      : int  1 1 1 1 1 1 1 0 1 1 ...
##  $ MAP                      : num  66.9 68 73.5 80.2 77.4 ...
##  $ APACHEⅡ                  : num  27.3 20.8 24 32.4 32.5 ...
##  $ Mechanical_ventilation   : int  1 1 1 1 1 1 1 1 0 1 ...
##  $ Bacteremia               : int  0 0 0 0 0 1 1 0 0 0 ...
##  $ PMX                      : int  0 0 0 1 0 0 0 0 1 1 ...
##  $ twentyeight_day_mortality: int  1 0 0 0 0 1 0 0 1 0 ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;おおむね狙い通りのデータになっていることが分かる。&lt;/p&gt;
&lt;p&gt;今回は施設というクラスターは無視して傾向スコアを用いて解析を実装する。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;傾向スコアの作成&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;傾向スコアの作成&lt;/h3&gt;
&lt;p&gt;実際の論文ではRCTのため傾向スコアや多変量解析は行われていない。&lt;/p&gt;
&lt;p&gt;今回は観察研究という設定で計算する。&lt;/p&gt;
&lt;p&gt;PMXを行うか否かについて関係する共変量を設定する。&lt;/p&gt;
&lt;p&gt;まず共変量をオブジェクトに格納する。&lt;/p&gt;
&lt;p&gt;こうすることの利点はモデルを作る際に見やすくなることである。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;covariateNames &amp;lt;- c(
  &amp;quot;Age&amp;quot;,
  &amp;quot;Sex&amp;quot;,
  &amp;quot;MAP&amp;quot;,
  &amp;quot;APACHEⅡ&amp;quot;,
  &amp;quot;Mechanical_ventilation&amp;quot;
)&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;治療指標の作成&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;治療指標の作成&lt;/h4&gt;
&lt;p&gt;便利のために、pmxとは別に治療指標の変数を作成する。治療指標は因子型としておく。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;pmx$treat &amp;lt;- as.factor(pmx$PMX)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;####　連続予測子の標準化&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#標準化された連続予測子
for (var in covariateNames) {
  if (class(pmx[,var])!=&amp;quot;factor&amp;quot;) { pmx[,var] = (pmx[,var]-mean(pmx[,var]))/sd(pmx[,var]) }
  }&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;傾向スコアの推定&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;傾向スコアの推定&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#ロジスティック回帰モデルの式の作成準備
ps.formula &amp;lt;- paste(covariateNames, collapse=&amp;quot;+&amp;quot;) 
ps.formula &amp;lt;- formula(paste(&amp;quot;treat~&amp;quot;,ps.formula))
print(ps.formula)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## treat ~ Age + Sex + MAP + APACHEⅡ + Mechanical_ventilation&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#クラスタリングを無視した傾向スコアの推定
#ps.model &amp;lt;- glm(ps.formula, data = pmx, family=binomial)

ps.model &amp;lt;- pmx %&amp;gt;% glm(ps.formula, data = ., family=binomial(link = &amp;quot;logit&amp;quot;))

#クラスタリングを無視した傾向スコアを得る
pmx$ps &amp;lt;- fitted(ps.model)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;傾向スコアの評価&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;傾向スコアの評価&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(pROC)

ROC &amp;lt;- pmx %&amp;gt;% roc(treat ~ ps, data = ., ci = TRUE)
ROC&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## roc.formula(formula = treat ~ ps, data = ., ci = TRUE)
## 
## Data: ps in 230 controls (treat 0) &amp;lt; 220 cases (treat 1).
## Area under the curve: 0.5255
## 95% CI: 0.472-0.579 (DeLong)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;今回はAUC 0.5255と低い値であり、モデルの精度として良くないようである。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;common-supportの評価&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Common supportの評価&lt;/h4&gt;
&lt;p&gt;傾向スコアにばらつきがないかを評価する&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;hist(pmx$ps[pmx$treat==0], density = 10, angle = 45, main=&amp;quot;Propensity Scores&amp;quot;,
     breaks=seq(0,1,by=0.01),
     xlim=c(0,1), ylim=c(0,50), xlab=&amp;quot;Shaded = Untreated | Gray = PMX&amp;quot;)
hist(pmx$ps[pmx$treat==1], col=gray(0.4,0.25), breaks=seq(0,1,by=0.01),
     xlim=c(0,1), ylim=c(0,50),add=T) &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/Propensity_score_files/figure-html/unnamed-chunk-12-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;PMX群とコントロール群では傾向スコアの分布は同じくらいであることが分かる。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;ateの推定&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;ATEの推定&lt;/h3&gt;
&lt;p&gt;今回は、試験の対象集団全体におけるPMXの効果を知りたいのであるからAverage treatment effect(ATE)を
推定することとする。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 重みの計算
pmx$psw &amp;lt;- with(pmx, ifelse(treat==1, 1/ps, 1/(1-ps)))

summary(pmx$psw)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.745   1.929   1.995   2.000   2.056   2.301&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;今回は傾向スコアに極端なweightはないが、もしある場合は対処を考える必要がある。&lt;/p&gt;
&lt;p&gt;方法として、&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;p&gt;極端なweightがモデルの仕様の誤りによるものかどうかをチェックするために、傾向スコアモデルを再指定する&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;傾向スコア法を変更する&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;weight打切りを行う&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;安定化weightを使用する。&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;3については99%タイルでweightを切り捨てるという方法がある。&lt;/p&gt;
&lt;p&gt;4についてはweightを加重平均などで安定化する方法である。&lt;/p&gt;
&lt;p&gt;今回は不要だが、参考までにweightの安定化を行う。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#重みの正規化
pmx$psw &amp;lt;- pmx$psw/mean(pmx$psw)
# 統合
with(pmx, by(psw, PMX, summary))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## PMX: 0
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.8724  0.9464  0.9803  0.9782  1.0087  1.1163 
## ------------------------------------------------------------ 
## PMX: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.9079  0.9842  1.0158  1.0228  1.0559  1.1506&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;安定化する前と比べてもほとんど変化はないことが分かる。&lt;/p&gt;
&lt;p&gt;今回は仮想データであるため、元々傾向スコアの分布が比較的均一であったため、安定化や切り捨ては不要で&lt;br&gt;
ある。&lt;/p&gt;
&lt;p&gt;実際のデータでは極端なweightを取ることがあるため、対処が必要になることがある。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;両群のバランス評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;両群のバランス評価&lt;/h3&gt;
&lt;p&gt;介入群とコントロール群でバランスがとれているか確認が必要である。&lt;/p&gt;
&lt;p&gt;そのためにtwangパッケージを用いる。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;require(twang)

baseline.balance &amp;lt;- bal.stat(data=pmx,#データセット
                          var=covariateNames,#バランスチェックの確認に含む変数のリスト
                          treat.var=&amp;quot;treat&amp;quot;,#介入・曝露の変数
                          w.all=1,#傾向スコアのweightなどがある場合、デフォルトは1 (no weighting)
                          sampw=1,#サンプリングウェイト (no weighting)
                          get.means=T, #平均と分散を計算するかどうか
                          get.ks=F,#コルモゴロフ・スミルノフ統計量を計算するかどうか
                          estimand=&amp;quot;ATE&amp;quot;,#ATEとATTどちらか
                          multinom=F)#多項傾向スコアを用いるかどうか

baseline.balance.es &amp;lt;- baseline.balance$results

summary(abs(baseline.balance.es$std.eff.sz))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## 0.008427 0.022860 0.029534 0.035160 0.044532 0.070447&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;標準化効果量は最大で0.070447とバランスはとれているようである。&lt;/p&gt;
&lt;p&gt;続いて傾向スコアで重みづけした後のバランス評価を行う。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;psw.balance &amp;lt;- bal.stat(data=pmx,#データセット
                          var=covariateNames,#バランスチェックの確認に含む変数のリスト
                          treat.var=&amp;quot;treat&amp;quot;,#介入・曝露の変数
                          w.all=pmx$psw,#傾向スコアのweightなどがある場合
                          sampw=1,#サンプリングウェイト (no weighting)
                          get.means=T, #平均と分散を計算するかどうか
                          get.ks=F,#コルモゴロフ・スミルノフ統計量を計算するかどうか
                          estimand=&amp;quot;ATE&amp;quot;,#ATEとATTどちらか
                          multinom=F)#多項傾向スコアを用いるかどうか


psw.balance.table &amp;lt;- psw.balance$results

summary(abs(psw.balance.table$std.eff.sz))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
## 5.949e-05 9.701e-05 1.924e-04 2.899e-04 5.454e-04 5.550e-04&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;標準効果量はかなり小さく、今回のデータでは重みづけする前後でもバランスはとれていた。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;治療効果の評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;治療効果の評価&lt;/h3&gt;
&lt;p&gt;今回はデータ作成の都合上、簡単のために生存までの時間は無視してロジスティック回帰モデルで評価する。&lt;/p&gt;
&lt;p&gt;そのために変数を論理型に変更しておく。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;pmx$twentyeight_day_mortality &amp;lt;- as.logical(pmx$twentyeight_day_mortality)
pmx$PMX &amp;lt;- as.logical(pmx$PMX)

str(pmx$twentyeight_day_mortality)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  logi [1:450] TRUE FALSE FALSE FALSE FALSE TRUE ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;論理型に変換できたことを確認&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;final.model &amp;lt;- pmx %&amp;gt;%
  glm(twentyeight_day_mortality ~ PMX, family = binomial(link = &amp;quot;logit&amp;quot;), weights = psw, data = .)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning in eval(family$initialize): non-integer #successes in a binomial glm!&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ここでの警告はstack.flowを見る限り問題はなさそう。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://stackoverflow.com/questions/12953045/warning-non-integer-successes-in-a-binomial-glm-survey-packages&#34; class=&#34;uri&#34;&gt;https://stackoverflow.com/questions/12953045/warning-non-integer-successes-in-a-binomial-glm-survey-packages&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;二重にロバストな推定&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(lmtest)
library(sandwich)
result &amp;lt;- coeftest(final.model, vcov = sandwich)&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(result)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##     Estimate          Std. Error        z value           Pr(&amp;gt;|z|)        
##  Min.   :-0.69787   Min.   :0.1403   Min.   :-4.9734   Min.   :0.0000007  
##  1st Qu.:-0.48800   1st Qu.:0.1549   1st Qu.:-3.5517   1st Qu.:0.1188765  
##  Median :-0.27813   Median :0.1694   Median :-2.1299   Median :0.2377523  
##  Mean   :-0.27813   Mean   :0.1694   Mean   :-2.1299   Mean   :0.2377523  
##  3rd Qu.:-0.06826   3rd Qu.:0.1839   3rd Qu.:-0.7082   3rd Qu.:0.3566282  
##  Max.   : 0.14161   Max.   :0.1985   Max.   : 0.7136   Max.   :0.4755040&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;exp(result[2])&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] 1.152124&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;exp(-1.96*result[4])&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.6777543&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;exp(1.96*result[4])&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] 1.475461&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;PMXのオッズ比は1.15 (95%CI 0.68 - 1.48)であった。&lt;/p&gt;
&lt;p&gt;RRに変換すると、1.068となる。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://clincalc.com/Stats/ConvertOR.aspx#1&#34; class=&#34;uri&#34;&gt;https://clincalc.com/Stats/ConvertOR.aspx#1&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これは元論文の1.09と近いが、そもそも介入と非介入の割合が50%なので、リスク比に変換するのは正しくないであろう。&lt;/p&gt;
&lt;div id=&#34;参考文献&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;【参考文献】&lt;/h4&gt;
&lt;p&gt;Practical Propensity Score Methods Using R SAGE Publications, Inc&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Rによる生存時間解析の実装</title>
      <link>/post/survival/</link>
      <pubDate>Wed, 15 Jul 2020 22:16:38 +0900</pubDate>
      <guid>/post/survival/</guid>
      <description>


&lt;div id=&#34;パッケージの読み込み&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;パッケージの読み込み&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;まずパッケージを読み込む&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# パッケージの読み込み
library(survival)
library(magrittr)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データの確認&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;データの確認&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;summary関数とstr関数を用いる。&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;必要に応じてグラフなどを書いてデータの分布を調べる。&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;head(myeloid, n = 5)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##   id trt sex futime death txtime crtime rltime
## 1  1   B   f    235     1     NA     44    113
## 2  2   A   m    286     1    200     NA     NA
## 3  3   A   f   1983     0     NA     38     NA
## 4  4   B   f   2137     0    245     25     NA
## 5  5   B   f    326     1    112     56    200&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;先頭5行の表示&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(myeloid)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##        id            trt            sex         futime           death       
##  Min.   :  1.0   Length:646         f:361   Min.   :   4.0   Min.   :0.0000  
##  1st Qu.:162.2   Class :character   m:285   1st Qu.: 286.5   1st Qu.:0.0000  
##  Median :323.5   Mode  :character           Median : 817.0   Median :0.0000  
##  Mean   :323.5                              Mean   :1010.1   Mean   :0.4954  
##  3rd Qu.:484.8                              3rd Qu.:1733.2   3rd Qu.:1.0000  
##  Max.   :646.0                              Max.   :2419.0   Max.   :1.0000  
##                                                                              
##      txtime           crtime          rltime      
##  Min.   :  24.0   Min.   : 21.0   Min.   :  26.0  
##  1st Qu.: 105.0   1st Qu.: 32.0   1st Qu.: 181.5  
##  Median : 147.0   Median : 39.0   Median : 283.0  
##  Mean   : 229.3   Mean   : 50.1   Mean   : 363.3  
##  3rd Qu.: 244.2   3rd Qu.: 57.0   3rd Qu.: 470.0  
##  Max.   :1526.0   Max.   :554.0   Max.   :1905.0  
##  NA&amp;#39;s   :282      NA&amp;#39;s   :192     NA&amp;#39;s   :420&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# データの型確認
str(myeloid)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    646 obs. of  8 variables:
##  $ id    : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ trt   : chr  &amp;quot;B&amp;quot; &amp;quot;A&amp;quot; &amp;quot;A&amp;quot; &amp;quot;B&amp;quot; ...
##  $ sex   : Factor w/ 2 levels &amp;quot;f&amp;quot;,&amp;quot;m&amp;quot;: 1 2 1 1 1 1 2 1 1 1 ...
##  $ futime: num  235 286 1983 2137 326 ...
##  $ death : num  1 1 0 0 1 0 1 1 0 0 ...
##  $ txtime: num  NA 200 NA 245 112 102 NA 205 NA 106 ...
##  $ crtime: num  44 NA 38 25 56 NA NA 34 28 NA ...
##  $ rltime: num  113 NA NA NA 200 NA NA 382 NA NA ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ここで使うデータは、パッケージに付属のデータ：白血病患者に対する治療のA/Bでの効果を調べるデータ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;id: subject identifier, 1-646,&lt;/li&gt;
&lt;li&gt;trt: treatment arm A or B,&lt;br /&gt;
&lt;/li&gt;
&lt;li&gt;sex: f=female, m=male,&lt;br /&gt;
&lt;/li&gt;
&lt;li&gt;futime: time to death or last follow-up,&lt;br /&gt;
&lt;/li&gt;
&lt;li&gt;death: 1 if futime is a death, 0 for censoring,&lt;br /&gt;
&lt;/li&gt;
&lt;li&gt;txtime: time to hematropetic stem cell transplant&lt;/li&gt;
&lt;li&gt;crtime: time to complete response, rltime: time to relapse of disease&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;今回は治療A/Bと死亡までの差をみる&lt;/p&gt;
&lt;p&gt;欠損値が存在しているが、今回の解析には影響を与えない。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;生存時間解析の準備&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;生存時間解析の準備&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ge.surv &amp;lt;- Surv(myeloid$futime, myeloid$death)
head(ge.surv, n = 10)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  [1]  235   286  1983+ 2137+  326  2041+   63   446  1695+ 1669+&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;+はイベント打ち切り、無印はイベントがなかったことを示す&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#myeloid %&amp;gt;% 
  Surv(myeloid$futime, myeloid$death)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##   [1]  235   286  1983+ 2137+  326  2041+   63   446  1695+ 1669+   66+ 1364+
##  [13]   17+  209   261  2380+  431   372   838  2086+ 1480+  188   963   318 
##  [25]  373  1657+  213  1421+  337   565   286  1823+   17+  201   321+  529 
##  [37]  266  1305  1460+ 1832  1859+ 1864+ 1880+  368  1391+  762   332   376+
##  [49] 1740+ 2241+  582   284   823  2186+ 2198+ 1737+ 2315+ 2006+  185  2367+
##  [61] 1893+ 1734+ 2042+ 2162+ 1176+ 2148+ 2247+ 1991+  180  1956+ 1976+   13 
##  [73] 1913+  110   116   245  2194+  531  1782+  548    46  2052+  411  1034 
##  [85]  293  2250+  235   267  2136+ 1465+  439   295   286  1251+ 1360+ 1783+
##  [97] 1866+  892  1525+  461   322  1323+  651   241+ 2300+ 2192+  191    18+
## [109] 1621    50    15+   27   574   917   609  1774+  206   297    77    52 
## [121] 1429+  278  1393+  232   106   397   140  2038+ 1911+   13  1990+  424 
## [133] 2063+ 1721+  955+ 1731+ 1499+  281   310  1999+  408  1361+  337    15+
## [145] 1530+  234  1681+  518   800  1806+ 1192+ 2304+ 1687+ 1785+ 1912+ 2335+
## [157]   31+  485   432+ 1409  1464+   18   462   408  1423+ 1431+  248  1459+
## [169] 2148+ 2188+ 1725+  218  1999+ 1254  1420+ 1521+ 1921+ 1648+ 1555+  614 
## [181]   50    86   588+  874    33   156   563   231  1020  1390+  572  1877+
## [193] 2122+  322   511   288   368   480  2224+ 1708+  561  1578+  834  1583+
## [205]    7+  513  1426+ 2040+ 1796+ 1627+  360  1280+ 2371+ 1479+  260  2219+
## [217]   20   269   381   163  1287+ 1092+  154   771  1972+ 1658+ 2283  1827+
## [229]    4+ 2210+ 1379   516  1007  1757+ 2134+   99  1369+  121  2361+  423 
## [241]  322  1423+  369   603    25  1809+  131   602   692  1444+  601+  305 
## [253]  518  2118+  972   524  1881+   74  2345+  403    14+ 2053+ 2254+   76 
## [265]   22+ 2154+  779   167    16+  191   707   103   283   293  1442+ 1350+
## [277] 1710+   19+ 1384+  263  1947+  230   248   216  1717+ 1718+  707   303 
## [289]   89  1545+ 1283   388  2023+ 1990+  140   759  2145+  168+ 1843+ 2188+
## [301] 1960+  874    34   438   396   867  1885+  148  1522+ 2233+ 1795+   13 
## [313] 1467+ 1682+ 2063+ 1302+   56  1666+ 1708+ 1384+  644   239  2095+ 2065+
## [325]  588   432   308  1779+  197  2183+ 1368+  193  2239+ 1479+ 1414+  599 
## [337] 1834+ 1290+ 1968+ 2123+  385   698+ 2255+ 1319+ 1465+ 1552  1883+  409 
## [349]  144   157  1370+  193+  128   671   670  1960+ 1320+  679  1815+ 2149+
## [361]  748  1901+ 2229+  964  1379+  146   179     6+ 1755+ 2043+  258   460 
## [373]  575   364  2344+ 1953+  386  1164   374  1683+ 1704+   86+  262   187 
## [385]   65   355    36+ 1727+ 1855+  215   319  1861+   21+  497  1385+    9 
## [397]  418  2028+  476  1744+ 1952+  344   464  1742+  355  2222+  226   356 
## [409] 1405+  210   907  2276+  104   565   727   385    20   333   578  1988+
## [421] 1349+ 2007+  255   522   539    23  1714+ 2056+  341   258  2237+ 1102 
## [433] 1729+ 2318+    9+  411    59+  805  2058+  697  2048+ 2034+  696   411 
## [445] 2083+  388   342  1544+   44   326  2200+   28  1360+  658   621   307 
## [457]  248  1652+ 1623+  540   166   246   458   329  2017+ 1129  1720+ 1703+
## [469]  167  1584+    9+ 1021   465  1308+ 1681+ 1846+ 1241  1602+ 1813+ 1742+
## [481] 1459+   95  1559+   24   465  1333+  419  1924+   85  1537   246  1774+
## [493] 1999+ 2233+ 1367+  267  1085  2052+  742   516+  499  1907+  400  1792+
## [505] 1698+  774   833  2253+ 1383+ 1039+  148   447   476   736  1485+  567+
## [517]   27  1745+  313  1739+ 2043+ 1760+   45   145  1989+  242  1099+  506 
## [529] 2044+ 1497+  156   456  1695+ 2299+ 1281+ 1990+   24   495   743  2419+
## [541] 1764+  170  1331+  112   295   359    32    27  1374+  120+  365   144 
## [553]  168  1901+  275   826  1704+  432+ 1780+   49+ 1313+   24+ 2126+  609 
## [565]  203  1245   436+ 1825+ 1915  2150+ 1710+ 2125+ 1594+ 1414+ 1455+ 1799+
## [577] 1728+ 1688+ 1113+  185    10+  811  1480+  515   122  2179+  420   248 
## [589]   24   906+  486   273  1220    40   443   383   829   160+  275   400 
## [601]  768  1347+ 1374+  375  1456+   27    93+ 1943+ 2041+  517   252   293 
## [613] 1417+  752  1322+ 2070+   16  2191+  334  1370  2369+ 1401+  664   259 
## [625] 2308+ 2335+  120  2055+ 1730+ 1373+  563  1480+  884  1386+ 1845+ 1313+
## [637]  410   697   253    21    22+  237  2394+   17+  181    25+&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;kaplan-meier法&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Kaplan-Meier法&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ノンパラメトリック法による生存時間を当てはめる関数 survfit&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;デフォルトはカプラン・マイヤー推定法&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div id=&#34;生存曲線を描く&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;生存曲線を描く&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;plot(ge.model,lty=1:2,xlab = &amp;quot;Survival time&amp;quot;, ylab = &amp;quot;Overall survival&amp;quot;, col = 1:2) %&amp;gt;% legend(locator(1),c(&amp;quot;A&amp;quot;,&amp;quot;B&amp;quot;), lty=c(1,2))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/survival_files/figure-html/unnamed-chunk-7-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;## 実際に描くときはlegendを併記するとグラフに追記できる&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;うまくlegendが追加できない。ggplot2を使って記載する方法もある。&lt;/p&gt;
&lt;p&gt;ggplotを用いてカプランマイヤー曲線を描く。&lt;/p&gt;
&lt;p&gt;ggplotはdata.frame型を使わなければならないので、fortifyを定義してやる必要がある。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;fortify.survfit &amp;lt;- function(survfit.data) {
  data.frame(time = survfit.data$time,
             n.risk = survfit.data$n.risk,
             n.event = survfit.data$n.event,
             n.censor = survfit.data$n.censor,
             surv = survfit.data$surv,
             std.err = survfit.data$std.err,
             upper = survfit.data$upper,
             lower = survfit.data$lower,
             strata = rep(names(survfit.data$strata), survfit.data$strata))
}

head(ggplot2::fortify(ge.model))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##   time n.risk n.event n.censor      surv     std.err upper     lower strata
## 1    6    317       0        1 1.0000000 0.000000000     1 1.0000000  trt=A
## 2    9    316       0        2 1.0000000 0.000000000     1 1.0000000  trt=A
## 3   13    314       1        0 0.9968153 0.003189797     1 0.9906028  trt=A
## 4   14    313       0        1 0.9968153 0.003189797     1 0.9906028  trt=A
## 5   15    312       0        1 0.9968153 0.003189797     1 0.9906028  trt=A
## 6   16    311       1        1 0.9936101 0.004532899     1 0.9848216  trt=A&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(ggplot2)

ge.model %&amp;gt;% ggplot() + geom_line(aes_string(x = &amp;#39;time&amp;#39;, y = &amp;#39;surv&amp;#39;, colour = &amp;#39;strata&amp;#39;)) + 
  geom_ribbon(aes_string(x = &amp;#39;time&amp;#39;, ymin = &amp;#39;lower&amp;#39;, ymax = &amp;#39;upper&amp;#39;, fill = &amp;#39;strata&amp;#39;), alpha = 0.5) + 
  ylim(0,1) +
  xlab(&amp;quot;survival time&amp;quot;) + ylab(&amp;quot;survival rate&amp;quot;) + ggtitle(&amp;quot;Kaplan-Meier曲線&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/survival_files/figure-html/unnamed-chunk-9-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#+ scale_y_continuous(labels = scales::percent)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;打ち切りも表したいときは、&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ge.censor &amp;lt;- ggplot2::fortify(ge.model)  &lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ge.censor %&amp;gt;% ggplot() + geom_line(aes_string(x = &amp;#39;time&amp;#39;, y = &amp;#39;surv&amp;#39;, colour = &amp;#39;strata&amp;#39;)) + 
  geom_ribbon(aes_string(x = &amp;#39;time&amp;#39;, ymin = &amp;#39;lower&amp;#39;, ymax = &amp;#39;upper&amp;#39;, fill = &amp;#39;strata&amp;#39;), alpha = 0.5) + 
  geom_point(data = ge.censor[ge.censor$n.censor &amp;gt; 0,],
             aes_string(x = &amp;#39;time&amp;#39;, y = &amp;#39;surv&amp;#39;), shape = &amp;#39;+&amp;#39;, size = 2) +
  ylim(0,1) +
  xlab(&amp;quot;survival time&amp;quot;) + ylab(&amp;quot;survival rate&amp;quot;) + ggtitle(&amp;quot;Kaplan-Meier曲線&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/survival_files/figure-html/unnamed-chunk-11-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Kaplan-Meier曲線を見る限り、比例ハザード性は保たれているようである。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;ログランク検定&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;ログランク検定&lt;/h4&gt;
&lt;p&gt;AとBによる生存曲線を比較する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;survdiff(Surv(myeloid$futime, myeloid$death) ~ myeloid$trt)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Call:
## survdiff(formula = Surv(myeloid$futime, myeloid$death) ~ myeloid$trt)
## 
##                 N Observed Expected (O-E)^2/E (O-E)^2/V
## myeloid$trt=A 317      171      143      5.28      9.59
## myeloid$trt=B 329      149      177      4.29      9.59
## 
##  Chisq= 9.6  on 1 degrees of freedom, p= 0.002&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;帰無仮説は「両群の生存曲線に差がない」である。&lt;/p&gt;
&lt;p&gt;今回の結果はp値=0.002であり生存曲線に差があるという結果になる。&lt;/p&gt;
&lt;p&gt;ただし、ログランク検定では患者の背景因子などは調整されていない。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;cox比例ハザード&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Cox比例ハザード&lt;/h4&gt;
&lt;p&gt;先に描いた生存曲線から比例ハザード性は保たれていると考えられる。&lt;/p&gt;
&lt;p&gt;今回は性別くらいしか調整する変数はないが、それを加えて解析を行う。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;model.cox &amp;lt;- coxph(Surv(futime, death) ~ trt + sex, data = myeloid)
summary(model.cox)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Call:
## coxph(formula = Surv(futime, death) ~ trt + sex, data = myeloid)
## 
##   n= 646, number of events= 320 
## 
##         coef exp(coef) se(coef)      z Pr(&amp;gt;|z|)   
## trtB -0.3582    0.6989   0.1129 -3.174  0.00151 **
## sexm  0.1150    1.1219   0.1128  1.020  0.30782   
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
##      exp(coef) exp(-coef) lower .95 upper .95
## trtB    0.6989     1.4307    0.5602     0.872
## sexm    1.1219     0.8913    0.8994     1.399
## 
## Concordance= 0.549  (se = 0.016 )
## Likelihood ratio test= 10.56  on 2 df,   p=0.005
## Wald test            = 10.53  on 2 df,   p=0.005
## Score (logrank) test = 10.62  on 2 df,   p=0.005&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;性別による生存率に違いはない。&lt;/p&gt;
&lt;p&gt;治療BについてはHR 0.699 (95%CI 0.560 - 0.872)という結果で、治療B群の方が死亡率を有意に低下させる。&lt;/p&gt;
&lt;p&gt;【参考文献】&lt;/p&gt;
&lt;p&gt;ggplotでカプランマイヤー曲線を描く際に、こちらのサイトを参考にさせていただいた。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;http://sinhrks.hatenablog.com/entry/2014/10/04/195825&#34; class=&#34;uri&#34;&gt;http://sinhrks.hatenablog.com/entry/2014/10/04/195825&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>線形回帰モデルの基礎</title>
      <link>/post/linear/</link>
      <pubDate>Tue, 14 Jul 2020 22:57:37 +0900</pubDate>
      <guid>/post/linear/</guid>
      <description>


&lt;div id=&#34;一般事項&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;一般事項&lt;/h3&gt;
&lt;p&gt;ある変数と別の変数の関係を数式で表したものを回帰モデルと呼ぶ。&lt;/p&gt;
&lt;p&gt;両者の関係が線形で与えられると仮定したものが線形回帰モデルである。&lt;/p&gt;
&lt;p&gt;式で表すと、&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[y = \beta_0 + \beta_1x\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;である。&lt;/p&gt;
&lt;p&gt;実際のデータでこのモデルを考える際には、観測値と仮定したモデルとの間には誤差が生じるため&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(y_i = \beta_0 + \beta_1x_i + \epsilon_i\)&lt;/span&gt;となる。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(i = 1,2,3...n\)&lt;/span&gt;である。&lt;/p&gt;
&lt;p&gt;このモデルがデータに良くあてはまるためには誤差&lt;span class=&#34;math inline&#34;&gt;\(\epsilon_i\)&lt;/span&gt;の総和が小さくなるようなパラメータを求めればよい。&lt;/p&gt;
&lt;p&gt;ただし、線形回帰モデルと観測値の差は負の値になることもあるため、そのまま総和をとるわけでなく、2乗して&lt;/p&gt;
&lt;p&gt;総和をとる。これが&lt;strong&gt;最小二乗法&lt;/strong&gt;である。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;架空データの作成&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;架空データの作成&lt;/h3&gt;
&lt;p&gt;ここでは収縮期血圧と年齢の関係をみる単純なモデルを考える。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 乱数発生で毎回同じ値になるようにseedを設定する
set.seed(123)
# ある程度線形モデルにフィットするようにするため相関を指定
rho &amp;lt;- 0.65
# 正規分布に従う乱数の設定(サンプルサイズ、平均、標準偏差は自由に設定可能)
y &amp;lt;- rnorm(n = 50, mean = 140, sd = 10)
x &amp;lt;- rnorm(n = 50, mean = 65,  sd = 10)
z &amp;lt;- rnorm(n = 50, mean = 0,   sd = 10)
# 相関をもった現実味のある値にするため、それぞれbpとageに格納
# sqrtは平方根という意味
bp  &amp;lt;- sqrt(rho)*z + sqrt(1 - rho)*y + 30
age &amp;lt;- sqrt(rho)*z + sqrt(1 - rho)*x + 30
# データフレームという形式でbpとageをdataというオブジェクトに格納
data &amp;lt;- data.frame(age,bp)
# 列に名前を付ける
name &amp;lt;- c(&amp;quot;age&amp;quot;,&amp;quot;SBP&amp;quot;)
colnames(data) &amp;lt;- name
# これで収縮期血圧と年齢の関係を示すデータが完成&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データの確認を行う&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;データの確認を行う&lt;/h3&gt;
&lt;p&gt;次は実際にどんなデータであるか確認を行う。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 外れ値や欠損値など
# summaryはデータの平均などを示す関数、headは先頭から指定の行を表示
summary(data)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##       age             SBP        
##  Min.   :47.15   Min.   : 91.89  
##  1st Qu.:62.03   1st Qu.:103.05  
##  Median :66.83   Median :111.74  
##  Mean   :67.27   Mean   :110.98  
##  3rd Qu.:72.59   3rd Qu.:118.22  
##  Max.   :83.99   Max.   :134.37&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;head(data, n = 3)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##        age      SBP
## 1 64.22569 103.7818
## 2 70.35670 113.5344
## 3 66.21200 120.0577&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# strは各変数の形式を示す、実際の解析ではどの形式なのか数値型なのか因子型なのかといった形の確認が重要
str(data)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    50 obs. of  2 variables:
##  $ age: num  64.2 70.4 66.2 73.7 59.4 ...
##  $ SBP: num  104 114 120 110 106 ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;図示&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;図示&lt;/h3&gt;
&lt;p&gt;データの分布を散布図を描いて確認を行う。&lt;/p&gt;
&lt;p&gt;plot関数でも描くことができるが今回はggplot2を用いる。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(ggplot2)
ggplot(data = data,
       aes(x = age, y = SBP)) +
  geom_point() +
  theme_bw()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/linear_files/figure-html/unnamed-chunk-3-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;散布図をみる限り、年齢と収縮期血圧には線形の関係がありそうに見える。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;モデルを作成する&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデルを作成する&lt;/h3&gt;
&lt;p&gt;ここでは２変量の単純なモデルを作成する。&lt;/p&gt;
&lt;p&gt;lm関数は線形回帰モデルを作成する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;model &amp;lt;- lm(data = data, bp ~ age)
summary(model)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## lm(formula = bp ~ age, data = data)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -14.833  -4.858   0.504   6.091  13.138 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&amp;gt;|t|)    
## (Intercept)  62.2829     8.1559   7.637 7.83e-10 ***
## age           0.7239     0.1202   6.022 2.32e-07 ***
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
## Residual standard error: 7.478 on 48 degrees of freedom
## Multiple R-squared:  0.4304, Adjusted R-squared:  0.4185 
## F-statistic: 36.26 on 1 and 48 DF,  p-value: 2.322e-07&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Residualsは残差のことで誤差の予測値とみなすことができる。&lt;/p&gt;
&lt;p&gt;Coefficientsは係数の結果である。切片と係数に該当する。&lt;/p&gt;
&lt;p&gt;今回のモデルは、&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(y_i = 62.283 + 0.724x_i\)&lt;/span&gt;と表すことができる。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;モデルの評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデルの評価&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(ggfortify)
autoplot(model, smooth.colour = NA)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: `arrange_()` is deprecated as of dplyr 0.7.0.
## Please use `arrange()` instead.
## See vignette(&amp;#39;programming&amp;#39;) for more help
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_warnings()` to see where this warning was generated.&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: Removed 50 row(s) containing missing values (geom_path).

## Warning: Removed 50 row(s) containing missing values (geom_path).

## Warning: Removed 50 row(s) containing missing values (geom_path).&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/linear_files/figure-html/unnamed-chunk-5-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;右上のQQplotはおおむね問題なさそうであり、残差は正規分布していそうである。&lt;/p&gt;
&lt;p&gt;また左下の図をみても分散に明らかな偏りはなさそうであり、等分散性が保たれていると思われる。
(ばらつきは比較的ありそうである)&lt;/p&gt;
&lt;p&gt;また先のsummaryの結果をみるとR-squaredという項目があるが、これが&lt;em&gt;決定係数&lt;/em&gt;である。&lt;/p&gt;
&lt;p&gt;予測値を&lt;span class=&#34;math inline&#34;&gt;\(\hat{y_i}\)&lt;/span&gt;、平均値を&lt;span class=&#34;math inline&#34;&gt;\(\bar{y}\)&lt;/span&gt;と表すと、&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[R^2 =1 - \frac{\sum_{i=1}^n(y_i - \hat{y_i})^2}{\sum_{i=1}^n(y_i - \bar{y})^2}\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;となる。決定係数は1に近いほど当てはまりがよいのであるから、この分数の部分が0に近ければよい。&lt;/p&gt;
&lt;p&gt;分子が小さくなる、つまり予測値と観測値が近いほど0に近づく、決定係数が1に近づくということになる。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;最後に散布図に線形回帰直線をひいてみる&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;最後に散布図に線形回帰直線をひいてみる&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(data = data,
       aes(x = age, y = SBP)) +
  geom_point() +
  stat_smooth(method = &amp;quot;lm&amp;quot;, se = TRUE, size = 1) +
  theme_bw()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## `geom_smooth()` using formula &amp;#39;y ~ x&amp;#39;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/linear_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;結果&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;結果&lt;/h3&gt;
&lt;p&gt;今回の年齢と収縮期血圧の関係では、年齢が高くなるほど線形に収縮期血圧が高くなると予想し、モデルを作成した。&lt;/p&gt;
&lt;p&gt;モデルの前提は満たされているようであり、係数も有意な結果であった。&lt;/p&gt;
&lt;p&gt;しかし決定係数は修正&lt;span class=&#34;math inline&#34;&gt;\(R^2\)&lt;/span&gt;および&lt;span class=&#34;math inline&#34;&gt;\(R^2\)&lt;/span&gt;ともに良いとは言えず、収縮期血圧について年齢だけのモデルでは、
十分に説明できていないことになる。&lt;/p&gt;
&lt;p&gt;実際の臨床でも血圧を予測するうえで他に、家族歴など様々な要因が重要であることは当然であり、年齢だけで
十分に説明できないということは妥当であるといえる。&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Logistic回帰の実装</title>
      <link>/post/logi/</link>
      <pubDate>Tue, 14 Jul 2020 22:46:04 +0900</pubDate>
      <guid>/post/logi/</guid>
      <description>


&lt;div id=&#34;パッケージの読み込み&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;パッケージの読み込み&lt;/h3&gt;
&lt;p&gt;今回はパッケージに付属のデータを用いる。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 必要なパッケージの読み込み
library(ggplot2)
library(dplyr)
library(ggfortify)
library(DAAG)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データの確認&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;データの確認&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# データの確認
data(&amp;quot;head.injury&amp;quot;)
summary(head.injury)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##      age.65      amnesia.before   basal.skull.fracture  GCS.decrease    
##  Min.   :0.000   Min.   :0.0000   Min.   :0.00000      Min.   :0.00000  
##  1st Qu.:0.000   1st Qu.:0.0000   1st Qu.:0.00000      1st Qu.:0.00000  
##  Median :0.000   Median :0.0000   Median :0.00000      Median :0.00000  
##  Mean   :0.116   Mean   :0.2047   Mean   :0.06985      Mean   :0.02275  
##  3rd Qu.:0.000   3rd Qu.:0.0000   3rd Qu.:0.00000      3rd Qu.:0.00000  
##  Max.   :1.000   Max.   :1.0000   Max.   :1.00000      Max.   :1.00000  
##      GCS.13        GCS.15.2hours      high.risk      loss.of.consciousness
##  Min.   :0.00000   Min.   :0.0000   Min.   :0.0000   Min.   :0.0000       
##  1st Qu.:0.00000   1st Qu.:0.0000   1st Qu.:0.0000   1st Qu.:0.0000       
##  Median :0.00000   Median :0.0000   Median :0.0000   Median :0.0000       
##  Mean   :0.03749   Mean   :0.1266   Mean   :0.2429   Mean   :0.1118       
##  3rd Qu.:0.00000   3rd Qu.:0.0000   3rd Qu.:0.0000   3rd Qu.:0.0000       
##  Max.   :1.00000   Max.   :1.0000   Max.   :1.0000   Max.   :1.0000       
##  open.skull.fracture    vomiting       clinically.important.brain.injury
##  Min.   :0.00000     Min.   :0.00000   Min.   :0.0000                   
##  1st Qu.:0.00000     1st Qu.:0.00000   1st Qu.:0.0000                   
##  Median :0.00000     Median :0.00000   Median :0.0000                   
##  Mean   :0.03685     Mean   :0.09869   Mean   :0.0801                   
##  3rd Qu.:0.00000     3rd Qu.:0.00000   3rd Qu.:0.0000                   
##  Max.   :1.00000     Max.   :1.00000   Max.   :1.0000&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;str(head.injury)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    3121 obs. of  11 variables:
##  $ age.65                           : num  0 0 0 0 0 0 0 0 1 0 ...
##  $ amnesia.before                   : num  1 0 0 0 0 1 0 0 0 1 ...
##  $ basal.skull.fracture             : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ GCS.decrease                     : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ GCS.13                           : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ GCS.15.2hours                    : num  0 0 0 1 1 0 0 0 0 0 ...
##  $ high.risk                        : num  0 0 0 0 0 0 0 0 1 0 ...
##  $ loss.of.consciousness            : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ open.skull.fracture              : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ vomiting                         : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ clinically.important.brain.injury: num  0 0 0 0 0 0 0 0 0 0 ...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;## 分布や欠損、各変数の型を確認しておく&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;DAAGパッケージに付属のデータセット&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;軽度の頭部外傷のデータセット&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;3121名、11列をもつ。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以下、変数名&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;age.65：0 = under 65, 1 = over 65&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;amnesia.before : 受傷前についての健忘(記憶があるか)
amnesia before impact (less than 30 minutes = 0, more than 30 minutes =1).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;basal.skull.fracture : 頭蓋亭骨折(0 = no fracture, 1 = fracture).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;GCS.decrease : 意識レベル低下
Glasgow Coma Scale decrease (0 = no deterioration, 1 = deterioration).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;GCS.13 : 最初の意識レベル initial Glasgow Coma Scale (0 = not ‘13’, 1 = ‘13’).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;GCS.15.2hours : けがをして2時間後の意識レベル
Glasgow Coma Scale after 2 hours (0 = not ‘15’, 1 = ‘15’).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;high.risk : 神経学的な介入が必要かどうか医師による判断
assessed by clinician as high risk for neurological intervention (0 = not high risk, 1 = high risk).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;loss.of.consciousness : 意識消失の有無(0 = conscious, 1 = loss of consciousness).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;open.skull.fracture : 開放性頭蓋骨骨折(0 = no fracture, 1 = fracture)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;vomiting : 嘔吐の有無(0 = no vomiting, 1 = vomiting)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;clinically.important.brain.injury : CTで臨床的に重要な急性期の脳所見があるかどうか
any acute brain finding revealed on CT (0 = not present, 1 = present).&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;References&gt;&lt;/p&gt;
&lt;p&gt;Stiell, I.G., Wells, G.A., Vandemheen, K., Clement, C., Lesiuk, H., Laupacis, A., McKnight, R.D., Verbee, R., Brison, R., Cass, D., Eisenhauer, M., Greenberg, G.H., and Worthington, J. (2001) The Canadian CT Head Rule for Patients with Minor Head Injury, The Lancet. 357: 1391-1396.&lt;/p&gt;
&lt;p&gt;＜今回のモデル＞&lt;/p&gt;
&lt;p&gt;目的変数：CT所見に何か異常があるか&lt;/p&gt;
&lt;p&gt;興味のある説明変数：健忘の有無&lt;/p&gt;
&lt;p&gt;として多変量ロジスティック回帰モデルを作成する。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;モデルの作成&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデルの作成&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# モデルの作成
# glm関数は一般化線形モデルに用いる関数で、familyで自分が使いたい分布を指定する。
#今回は二値変数がアウトカムなので二項分布に従い、リンク関数はlogitなので以下のようになる

model &amp;lt;- glm(clinically.important.brain.injury ~ amnesia.before  + age.65 + GCS.decrease + GCS.15.2hours + GCS.13 + high.risk + loss.of.consciousness + vomiting,family = binomial(link = &amp;quot;logit&amp;quot;),data = head.injury)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;結果の確認&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;結果の確認&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# モデルの結果確認
summary(model)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## glm(formula = clinically.important.brain.injury ~ amnesia.before + 
##     age.65 + GCS.decrease + GCS.15.2hours + GCS.13 + high.risk + 
##     loss.of.consciousness + vomiting, family = binomial(link = &amp;quot;logit&amp;quot;), 
##     data = head.injury)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.6149  -0.3355  -0.2339  -0.1734   2.9001  
## 
## Coefficients:
##                       Estimate Std. Error z value Pr(&amp;gt;|z|)    
## (Intercept)            -4.1904     0.1485 -28.211  &amp;lt; 2e-16 ***
## amnesia.before          0.6055     0.1656   3.656 0.000256 ***
## age.65                  1.3412     0.1761   7.617 2.60e-14 ***
## GCS.decrease            0.3901     0.3573   1.092 0.274954    
## GCS.15.2hours           1.9435     0.1598  12.164  &amp;lt; 2e-16 ***
## GCS.13                  1.2985     0.2663   4.876 1.09e-06 ***
## high.risk               1.1237     0.1527   7.360 1.84e-13 ***
## loss.of.consciousness   0.8733     0.1926   4.534 5.78e-06 ***
## vomiting                1.2541     0.1865   6.724 1.77e-11 ***
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1741.6  on 3120  degrees of freedom
## Residual deviance: 1287.0  on 3112  degrees of freedom
## AIC: 1305
## 
## Number of Fisher Scoring iterations: 6&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;各変数の係数を確認する。&lt;/p&gt;
&lt;p&gt;値をオッズ比へ変換する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# オッズ比と95%信頼区間の確認
result_odds &amp;lt;- as.data.frame(cbind(exp(summary(model)$coefficient[,1]),exp(confint(model))
                                    ,summary(model)$coefficient[,4]))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Waiting for profiling to be done...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# result_oddsというデータフレームの列名を名付ける
names(result_odds) &amp;lt;- c(&amp;quot;Odds ratio&amp;quot;,&amp;quot;lower 95%CI&amp;quot;,&amp;quot;upper 95%CI&amp;quot;,&amp;quot;P value&amp;quot;)
# 小数点２桁で結果を表示
round(result_odds,2)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##                       Odds ratio lower 95%CI upper 95%CI P value
## (Intercept)                 0.02        0.01        0.02    0.00
## amnesia.before              1.83        1.32        2.53    0.00
## age.65                      3.82        2.70        5.39    0.00
## GCS.decrease                1.48        0.71        2.91    0.27
## GCS.15.2hours               6.98        5.10        9.56    0.00
## GCS.13                      3.66        2.15        6.12    0.00
## high.risk                   3.08        2.28        4.15    0.00
## loss.of.consciousness       2.39        1.63        3.47    0.00
## vomiting                    3.50        2.42        5.03    0.00&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;モデルの評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデルの評価&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(pROC)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Type &amp;#39;citation(&amp;quot;pROC&amp;quot;)&amp;#39; for a citation.&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
##  次のパッケージを付け加えます: &amp;#39;pROC&amp;#39;&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  以下のオブジェクトは &amp;#39;package:stats&amp;#39; からマスクされています: 
## 
##      cov, smooth, var&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ROC &amp;lt;- roc(response=head.injury$clinically.important.brain.injury, predictor=model$fitted.values)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Setting levels: control = 0, case = 1&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Setting direction: controls &amp;lt; cases&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ROC&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## roc.default(response = head.injury$clinically.important.brain.injury,     predictor = model$fitted.values)
## 
## Data: model$fitted.values in 2871 controls (head.injury$clinically.important.brain.injury 0) &amp;lt; 250 cases (head.injury$clinically.important.brain.injury 1).
## Area under the curve: 0.8387&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;plot(ROC)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/logi_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;ROC(C統計量)は0.837くらいで今回のモデルの当てはまりはよさそうである。&lt;/p&gt;
&lt;p&gt;「怪我の前の記憶喪失(健忘)」と「CT所見に何かしら異常が見つかるか」の関係をみることが今回の目的であり、&lt;br&gt;
最終結果はオッズ比 1.83, 95%CI 1.32 - 2.53となり、受傷時の健忘はCTの異常所見の発見に影響があると言える。&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Rによるグラフ基礎</title>
      <link>/post/2015-07-23-r-rmarkdown/</link>
      <pubDate>Mon, 13 Jul 2020 21:13:14 -0500</pubDate>
      <guid>/post/2015-07-23-r-rmarkdown/</guid>
      <description>


&lt;div id=&#34;一般事項&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;一般事項&lt;/h3&gt;
&lt;p&gt;Rにはグラフを書く上でおもに２つの方法がある。&lt;/p&gt;
&lt;p&gt;デフォルトのgraphicsで扱うplot関数などとggplot2パッケージによる方法である。&lt;/p&gt;
&lt;p&gt;ここでは医学系でよく扱うグラフをggplot2を実装する。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;データの準備&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;データの準備&lt;/h3&gt;
&lt;p&gt;あるA市とB市で収縮期血圧を調査した設定で架空データを作成する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;set.seed(125) # 乱数の固定のシード
a &amp;lt;- rnorm(n = 100, mean = 140, sd = 10)
b &amp;lt;- rnorm(n = 100, mean = 60, sd = 5 )
c &amp;lt;- rep(c(&amp;quot;A_city&amp;quot;,&amp;quot;B_city&amp;quot;),50)
d &amp;lt;- rbinom(n = 100, size = 1, prob = 0.6)  # ここでは男性の割合を0.6として二項分布によるランダム値の作成
study &amp;lt;- data.frame(a,b,c,d)
name  &amp;lt;- c(&amp;quot;SBP&amp;quot;, &amp;quot;Age&amp;quot;, &amp;quot;City&amp;quot;, &amp;quot;Sex&amp;quot;) 
colnames(study) &amp;lt;- name
# 性別は二値なのでデータ型を変換する
study$Sex &amp;lt;- as.factor(study$Sex)
study$Sex &amp;lt;- factor(study$Sex,levels = c(1,0),
                  labels = c(&amp;quot;Male&amp;quot;,&amp;quot;Female&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データの確認&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;データの確認&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(study)
##       SBP             Age            City        Sex    
##  Min.   :103.9   Min.   :46.80   A_city:50   Male  :63  
##  1st Qu.:134.6   1st Qu.:56.90   B_city:50   Female:37  
##  Median :141.7   Median :59.93                          
##  Mean   :141.0   Mean   :60.09                          
##  3rd Qu.:147.9   3rd Qu.:63.14                          
##  Max.   :164.0   Max.   :72.41&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;散布図&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;散布図&lt;/h3&gt;
&lt;p&gt;ggplotでは要素を追記していく形が基本となる。&lt;/p&gt;
&lt;p&gt;散布図で連続変数同士の関係をみる。&lt;/p&gt;
&lt;p&gt;例えば年齢と収縮期血圧の関係を見たい場合&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(ggplot2)
ggplot(data = study, aes(x = Age, y = SBP, colour = City)) +   
# ここがベースで、使用するデータ、軸、およびcolourを指定することでカテゴリーごとに色分けできる
  geom_point(size = 4) +   # 散布図にするという指定
  xlab(&amp;quot;Age&amp;quot;) +    # x軸ラベルの命名
  ylab(&amp;quot;SBP&amp;quot;) +    # y軸ラベルの命名
  ggtitle(&amp;quot;SBP調査&amp;quot;) +  # グラフタイトルの命名
  theme_bw()  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/2015-07-23-r-rmarkdown_files/figure-html/unnamed-chunk-3-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;A市もB市も同じくらいばらついていそうである。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;箱ひげ図&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;箱ひげ図&lt;/h3&gt;
&lt;p&gt;離散型の変数と連続型の変数の関係をみるために使う。&lt;/p&gt;
&lt;p&gt;箱ひげ図により統計量(平均値、標準偏差)も一緒に図示できる。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(data = study, aes(x = City, y = SBP, colour = City)) +
  geom_boxplot() +   # ここがboxplotに変わっただけ
  geom_jitter() +    # 各点のばらつきを追加する
#  geom_point(size = 3, alpha = 0.5) +
  xlab(&amp;quot;Age&amp;quot;) + 
  ylab(&amp;quot;SBP&amp;quot;) + 
  ggtitle(&amp;quot;SBP調査&amp;quot;) + 
  theme_bw()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/2015-07-23-r-rmarkdown_files/figure-html/unnamed-chunk-4-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;バイオリンプロット&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;バイオリンプロット&lt;/h3&gt;
&lt;p&gt;バイオリンプロットによりデータの分布の密度も可視化することができる。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# バイオリンプロットも描くことができる
ggplot(data = study, aes(x = City, y = SBP, colour = City)) +
  geom_violin() +
  xlab(&amp;quot;Age&amp;quot;) + 
  ylab(&amp;quot;SBP&amp;quot;) + 
  ggtitle(&amp;quot;SBP調査&amp;quot;) + 
  theme_bw()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/2015-07-23-r-rmarkdown_files/figure-html/unnamed-chunk-5-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;ヒストグラム&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;ヒストグラム&lt;/h3&gt;
&lt;p&gt;連続変数などの分布をみる。&lt;/p&gt;
&lt;p&gt;ここでは両方の都市での年齢の分布を示している。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# ヒストグラム
ggplot(data = study, aes(x = Age)) +
  geom_histogram(binwidth = 2) + # ヒストグラム描きます、階級値は2にしますという宣言
  facet_wrap(~City)  # 群別の図を書くことができる&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/2015-07-23-r-rmarkdown_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;棒グラフ&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;棒グラフ&lt;/h3&gt;
&lt;p&gt;今回のデータでは必要性が乏しいが&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(data = study, aes(x = City, y = SBP, fill = Sex)) +
  geom_bar(stat = &amp;quot;identity&amp;quot;, position = &amp;quot;dodge&amp;quot;) +
  xlab(&amp;quot;Sex&amp;quot;) +
  ylab(&amp;quot;SBP&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/2015-07-23-r-rmarkdown_files/figure-html/unnamed-chunk-7-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>
