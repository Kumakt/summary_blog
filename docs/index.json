[{"authors":["admin"],"categories":null,"content":"自分が勉強したことを記録する備忘録\n＊記事内容は個人の意見であり、所属組織・部門の見解ではありません。\n","date":1549324800,"expirydate":-62135596800,"kind":"term","lang":"en","lastmod":1567641600,"objectID":"2525497d367e79493fd32b198b28f040","permalink":"/author/kumakt/","publishdate":"0001-01-01T00:00:00Z","relpermalink":"/author/kumakt/","section":"authors","summary":"自分が勉強したことを記録する備忘録 ＊記事内容は個人の意見であり、所属組織・部門の見解ではありません。","tags":null,"title":"Kumakt","type":"authors"},{"authors":["吳恩達"],"categories":null,"content":"吳恩達 is a professor of artificial intelligence at the Stanford AI Lab. His research interests include distributed robotics, mobile computing and programmable matter. He leads the Robotic Neurobiology group, which develops self-reconfiguring robots, systems of self-organizing robots, and mobile sensor networks.\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Sed neque elit, tristique placerat feugiat ac, facilisis vitae arcu. Proin eget egestas augue. Praesent ut sem nec arcu pellentesque aliquet. Duis dapibus diam vel metus tempus vulputate.\n","date":-62135596800,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":-62135596800,"objectID":"704f87b982c35398f63c73390b73c8f5","permalink":"/author/%E5%90%B3%E6%81%A9%E9%81%94/","publishdate":"0001-01-01T00:00:00Z","relpermalink":"/author/%E5%90%B3%E6%81%A9%E9%81%94/","section":"authors","summary":"吳恩達 is a professor of artificial intelligence at the Stanford AI Lab. His research interests include distributed robotics, mobile computing and programmable matter. He leads the Robotic Neurobiology group, which develops self-reconfiguring robots, systems of self-organizing robots, and mobile sensor networks. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed neque elit, tristique placerat feugiat ac, facilisis vitae arcu. Proin eget egestas augue. Praesent ut sem nec arcu pellentesque aliquet. Duis dapibus diam vel metus tempus vulputate.","tags":null,"title":"吳恩達","type":"authors"},{"authors":["Kumakt"],"categories":["R"],"content":"\rテーマ\r\rマルチレベルデータに対する生存時間解析\rマルチレベルデータに対する傾向スコアを用いた生存時間解析\r\r前回用いたシミュレーションデータでは、マルチレベルデータを用いた傾向スコア法でも\r結果が変わらなかった。\rおそらくシミュレーションデータのためであろう。\n今回はオープンアクセスデータを用いた実装を行う。\nデータは以下から引用した。\nCitation\rShiroshita, Akihiro (2020), Effectiveness of steroid therapy on pneumonic chronic obstructive pulmonary disease exacerbation: a multi-centred retrospective cohort study, v3, Dryad, Dataset, https://doi.org/10.5061/dryad.m63xsj3zd\n\rデータの読み込み\r\rデータの確認\rsummary(copd)\r## id age gender steroid ## Min. : 1 Min. : 47.00 Min. :1.000 Min. :0.0000 ## 1st Qu.: 310 1st Qu.: 74.00 1st Qu.:1.000 1st Qu.:0.0000 ## Median : 619 Median : 80.00 Median :1.000 Median :1.0000 ## Mean : 619 Mean : 79.27 Mean :1.099 Mean :0.5319 ## 3rd Qu.: 928 3rd Qu.: 85.00 3rd Qu.:1.000 3rd Qu.:1.0000 ## Max. :1237 Max. :105.00 Max. :2.000 Max. :1.0000 ## ## hospital adl wheeze bun ## Min. :1.000 Min. :0.0000 Min. :0.0000 Min. : 1.00 ## 1st Qu.:1.000 1st Qu.:1.0000 1st Qu.:0.0000 1st Qu.: 14.00 ## Median :2.000 Median :1.0000 Median :0.0000 Median : 18.00 ## Mean :2.032 Mean :0.8529 Mean :0.3112 Mean : 21.39 ## 3rd Qu.:2.000 3rd Qu.:1.0000 3rd Qu.:1.0000 3rd Qu.: 25.00 ## Max. :5.000 Max. :1.0000 Max. :1.0000 Max. :152.00 ## NA\u0026#39;s :11 ## rr ams hr hot ## 24 :225 Min. :0.000 Min. : 30.0 Min. :0.0000 ## 20 :151 1st Qu.:0.000 1st Qu.: 88.0 1st Qu.:0.0000 ## 30 :106 Median :0.000 Median :101.0 Median :0.0000 ## 28 : 80 Mean :0.159 Mean :101.3 Mean :0.2328 ## 18 : 66 3rd Qu.:0.000 3rd Qu.:114.0 3rd Qu.:0.0000 ## (Other):504 Max. :1.000 Max. :200.0 Max. :1.0000 ## NA\u0026#39;s :105 NA\u0026#39;s :4 NA\u0026#39;s :14 ## stability time_to_stability death non_informative_cencoring\r## Min. :0.0000 Min. : 0.000 Min. :0.0000 Min. :0 ## 1st Qu.:1.0000 1st Qu.: 1.000 1st Qu.:0.0000 1st Qu.:0 ## Median :1.0000 Median : 3.000 Median :0.0000 Median :0 ## Mean :0.8351 Mean : 3.882 Mean :0.0671 Mean :0 ## 3rd Qu.:1.0000 3rd Qu.: 5.000 3rd Qu.:0.0000 3rd Qu.:0 ## Max. :1.0000 Max. :39.000 Max. :1.0000 Max. :0 ## ## discharge intubation hospitalization ## Min. :0.0000 Min. :0.000000 Min. : 1.00 ## 1st Qu.:1.0000 1st Qu.:0.000000 1st Qu.: 8.00 ## Median :1.0000 Median :0.000000 Median : 12.00 ## Mean :0.9289 Mean :0.007282 Mean : 16.97 ## 3rd Qu.:1.0000 3rd Qu.:0.000000 3rd Qu.: 19.00 ## Max. :1.0000 Max. :1.000000 Max. :200.00 ## NA\u0026#39;s :1\rstr(copd)\r## \u0026#39;data.frame\u0026#39;: 1237 obs. of 19 variables:\r## $ id : int 1 2 3 4 5 6 7 8 9 10 ...\r## $ age : int 69 68 75 62 76 76 86 78 84 77 ...\r## $ gender : int 1 1 1 1 1 1 1 1 1 2 ...\r## $ steroid : int 1 1 1 1 1 1 1 0 1 0 ...\r## $ hospital : int 5 5 5 5 5 5 5 5 5 5 ...\r## $ adl : int 1 1 1 1 1 1 1 1 1 1 ...\r## $ wheeze : int 1 0 0 1 1 1 1 0 0 1 ...\r## $ bun : num 6.9 24.8 18.2 17.7 15.1 9.4 46.2 84.9 15.8 13.3 ...\r## $ rr : Factor w/ 38 levels \u0026quot;\u0026quot;,\u0026quot;0\u0026quot;,\u0026quot;11\u0026quot;,\u0026quot;12\u0026quot;,..: NA 23 18 26 23 7 11 19 15 19 ...\r## $ ams : int 0 0 0 0 0 0 1 0 0 0 ...\r## $ hr : int 105 160 120 90 104 126 93 101 110 64 ...\r## $ hot : int 1 1 0 0 1 1 1 1 1 0 ...\r## $ stability : int 1 1 0 1 0 1 0 0 1 1 ...\r## $ time_to_stability : int 3 6 0 10 0 1 0 0 4 19 ...\r## $ death : int 0 0 0 0 0 0 0 0 0 0 ...\r## $ non_informative_cencoring: int 0 0 0 0 0 0 0 0 0 0 ...\r## $ discharge : int 1 1 1 1 1 1 1 1 1 1 ...\r## $ intubation : int 0 0 0 0 0 0 0 0 0 0 ...\r## $ hospitalization : int 9 23 22 12 18 21 8 2 10 30 ...\r\rデータ整形\r\rrrは離散値をとる数値型のはずが、因子型になっている。\rのちのためにも変換が必要\r同じく従属変数も数値型へ変換\r\rcopd$rr \u0026lt;- as.numeric(copd$rr)\rstr(copd$rr)\r## num [1:1237] NA 23 18 26 23 7 11 19 15 19 ...\r# 従属変数の変換\rcopd$stability \u0026lt;- as.numeric(copd$stability)\rstr(copd$stability)\r## num [1:1237] 1 1 0 1 0 1 0 0 1 1 ...\r# 時間変数も数値型へ変換\rcopd$time_to_stability \u0026lt;- as.numeric(copd$time_to_stability)\rstr(copd$time_to_stability)\r## num [1:1237] 3 6 0 10 0 1 0 0 4 19 ...\r数値型になったことを確認できた。\n\rデータの概要\r元論文より引用\n日本のデータで５施設からの多施設後ろ向きコホート研究\nステロイド投与が慢性閉塞性肺疾患に与える影響を調べた1237人のデータ,19変数\n＜変数名＞\rid: anonimized patients’ ID,\nage: patients’ age on hospitalization,\ngender: 1=male, 2=female,\nsteroid: steroid use (0=not, 1=steroid use),\nhospital: categorized hospital name (1-5まで病院コード),\nadl: activity daily living before hospitalization (0: full support, 1: not full support),\nwheeze: wheezing lung sound on admission (0:not, 1:wheezing lung sound),\nbun: blood urea nitrogen (mg/dL),\nrr: respiratory rate (/minute),\nams: altered mental status (0=not, 1=altered mental status),\nhr: heart rate (/minute),\nhot: home oxygen therapy use before hospitalization (0=not, 1=users),\ninsulin: new insuline users during hospitalization (0=not, 1=new users),\ndelirium: clinical diagnosis of delirium during hospitalization (0=not, 1=delirium),\nstability: reaching the clinical stability (0=not, 1=reached clinical stability),\ntime_to_stability: time to clinical stability (days),\ndeath:in-hospital death,\nnon-informative_censoring: non-informative censoring (0=not, 1=noninformative\rcensoring),\ndischarge (0=not, 1=discharged patients),\nintubation: tracheal\nintubation during hospitalization (0=not, 1=intubated),\nhospitalization=length of stay (days)\n＜アウトカム＞\rstability：臨床的安定の達成\n＜曝露＞\rsteroid:ステロイド使用の有無\n\r今回考え得るモデル\rComplete case analysis + 多変量生存時間解析 with/without マルチレベル分析\n\rComplete case analysis + 傾向スコア + 生存時間解析 with/without マルチレベル分析\n\r多重代入による欠損値処理 + 傾向スコア + 生存時間解析 with/without マルチレベル分析\r\r\rComplete case analysis:その1\r欠損値への対処がやっかいなのでまずはcomplete case analysisを行う。\n# na.omitは欠損値を除く関数\rcopd_ca \u0026lt;- na.omit(copd)\r\rデータの概要\rsummary(copd_ca)\r## id age gender steroid ## Min. : 2.0 Min. : 47.00 Min. :1.000 Min. :0.0000 ## 1st Qu.: 340.5 1st Qu.: 74.00 1st Qu.:1.000 1st Qu.:0.0000 ## Median : 640.0 Median : 80.00 Median :1.000 Median :1.0000 ## Mean : 634.2 Mean : 79.44 Mean :1.097 Mean :0.5487 ## 3rd Qu.: 940.5 3rd Qu.: 85.00 3rd Qu.:1.000 3rd Qu.:1.0000 ## Max. :1237.0 Max. :105.00 Max. :2.000 Max. :1.0000 ## hospital adl wheeze bun ## Min. :1.000 Min. :0.0000 Min. :0.0000 Min. : 1.00 ## 1st Qu.:1.000 1st Qu.:1.0000 1st Qu.:0.0000 1st Qu.: 14.00 ## Median :2.000 Median :1.0000 Median :0.0000 Median : 18.00 ## Mean :1.974 Mean :0.8517 Mean :0.3208 Mean : 21.37 ## 3rd Qu.:2.000 3rd Qu.:1.0000 3rd Qu.:1.0000 3rd Qu.: 25.00 ## Max. :5.000 Max. :1.0000 Max. :1.0000 Max. :152.00 ## rr ams hr hot ## Min. : 1.00 Min. :0.0000 Min. : 30.0 Min. :0.0000 ## 1st Qu.:11.00 1st Qu.:0.0000 1st Qu.: 88.5 1st Qu.:0.0000 ## Median :15.00 Median :0.0000 Median :101.0 Median :0.0000 ## Mean :15.42 Mean :0.1609 Mean :101.4 Mean :0.2315 ## 3rd Qu.:19.00 3rd Qu.:0.0000 3rd Qu.:114.0 3rd Qu.:0.0000 ## Max. :38.00 Max. :1.0000 Max. :200.0 Max. :1.0000 ## stability time_to_stability death non_informative_cencoring\r## Min. :0.0000 Min. : 0.00 Min. :0.00000 Min. :0 ## 1st Qu.:1.0000 1st Qu.: 1.00 1st Qu.:0.00000 1st Qu.:0 ## Median :1.0000 Median : 3.00 Median :0.00000 Median :0 ## Mean :0.8329 Mean : 3.86 Mean :0.06702 Mean :0 ## 3rd Qu.:1.0000 3rd Qu.: 5.00 3rd Qu.:0.00000 3rd Qu.:0 ## Max. :1.0000 Max. :39.00 Max. :1.00000 Max. :0 ## discharge intubation hospitalization ## Min. :0.0000 Min. :0.000000 Min. : 1.00 ## 1st Qu.:1.0000 1st Qu.:0.000000 1st Qu.: 8.00 ## Median :1.0000 Median :0.000000 Median : 12.00 ## Mean :0.9285 Mean :0.007149 Mean : 16.96 ## 3rd Qu.:1.0000 3rd Qu.:0.000000 3rd Qu.: 19.00 ## Max. :1.0000 Max. :1.000000 Max. :200.00\rnrow(copd_ca)\r## [1] 1119\r欠損値はすべてなくなり、1119例となっていることが分かる。\n\r式の作成\r共変量設定\ncovariateNames_ca \u0026lt;- c(\u0026quot;gender\u0026quot;,#性別\r\u0026quot;age\u0026quot;,#年齢\r\u0026quot;hot\u0026quot;, #在宅酸素療法の有無\r\u0026quot;adl\u0026quot;,#ADL\r\u0026quot;rr\u0026quot;, #呼吸数\r\u0026quot;ams\u0026quot;, # 意識状態\r\u0026quot;hr\u0026quot;, #心拍数\r\u0026quot;bun\u0026quot; #BUN\r#著者らは先行研究に基づいて決定\r)\r\r生存時間解析\rカプランマイヤー法で評価\rlibrary(survival)\rlibrary(survminer)\rlibrary(ggplot2)\rsv_result \u0026lt;- survfit(Surv(copd_ca$time_to_stability,copd_ca$stability) ~ copd_ca$steroid)\rggsurvplot(sv_result, data = copd_ca, censor.shape = \u0026quot;|\u0026quot;,risk.table = TRUE,risk.table.col = \u0026quot;strata\u0026quot;)\r## Warning: Vectorized input to `element_text()` is not officially supported.\r## Results may be unexpected or may change in future versions of ggplot2.\r比例ハザード性は判断が難しい。\n\r\rログランク検定\rsurvdiff(Surv(copd_ca$time_to_stability,copd_ca$stability) ~ copd_ca$steroid)\r## Call:\r## survdiff(formula = Surv(copd_ca$time_to_stability, copd_ca$stability) ~ ## copd_ca$steroid)\r## ## N Observed Expected (O-E)^2/E (O-E)^2/V\r## copd_ca$steroid=0 505 428 401 1.76 3.99\r## copd_ca$steroid=1 614 504 531 1.33 3.99\r## ## Chisq= 4 on 1 degrees of freedom, p= 0.05\r結果はp value = 0.05 とこちらも微妙…\nそもそもとしてCoxの比例ハザードモデルを考えてよいかが問題となってくる。\n元論文では競合リスクを考慮した解析を行っている。\n一応ここでは通常のCox比例ハザードモデルを行う。\nここからモデル作成を行う\n\rモデル1-1:random効果を無視した生存時間解析(通常の多変量比例ハザードモデル)\rここから解析を行う.\nここでのステロイドの治療は施設ごとでも差がないとの仮定に基づいている。\nlibrary(survival)\rmodel_ca_nm \u0026lt;- coxph(data = copd_ca, Surv(time_to_stability,stability) ~　steroid + age + gender + hot + adl + ams + rr + hr + bun)\r係数の確認\nsummary(model_ca_nm)\r## Call:\r## coxph(formula = Surv(time_to_stability, stability) ~ steroid + ## age + gender + hot + adl + ams + rr + hr + bun, data = copd_ca)\r## ## n= 1119, number of events= 932 ## ## coef exp(coef) se(coef) z Pr(\u0026gt;|z|) ## steroid -0.1205477 0.8864348 0.0667505 -1.806 0.07093 . ## age 0.0143903 1.0144943 0.0044923 3.203 0.00136 **\r## gender -0.2421026 0.7849756 0.1143233 -2.118 0.03420 * ## hot 0.2456815 1.2784923 0.0801850 3.064 0.00218 **\r## adl -0.0329088 0.9676268 0.1013175 -0.325 0.74533 ## ams -0.0594581 0.9422750 0.0995337 -0.597 0.55026 ## rr -0.0171500 0.9829962 0.0060550 -2.832 0.00462 **\r## hr -0.0004657 0.9995344 0.0018423 -0.253 0.80043 ## bun -0.0071899 0.9928359 0.0034794 -2.066 0.03879 * ## ---\r## Signif. codes: 0 \u0026#39;***\u0026#39; 0.001 \u0026#39;**\u0026#39; 0.01 \u0026#39;*\u0026#39; 0.05 \u0026#39;.\u0026#39; 0.1 \u0026#39; \u0026#39; 1\r## ## exp(coef) exp(-coef) lower .95 upper .95\r## steroid 0.8864 1.1281 0.7777 1.0103\r## age 1.0145 0.9857 1.0056 1.0235\r## gender 0.7850 1.2739 0.6274 0.9821\r## hot 1.2785 0.7822 1.0926 1.4961\r## adl 0.9676 1.0335 0.7934 1.1802\r## ams 0.9423 1.0613 0.7753 1.1453\r## rr 0.9830 1.0173 0.9714 0.9947\r## hr 0.9995 1.0005 0.9959 1.0032\r## bun 0.9928 1.0072 0.9861 0.9996\r## ## Concordance= 0.581 (se = 0.012 )\r## Likelihood ratio test= 41.23 on 9 df, p=5e-06\r## Wald test = 40.77 on 9 df, p=6e-06\r## Score (logrank) test = 40.88 on 9 df, p=5e-06\rround(exp(confint(model_ca_nm)),3)\r## 2.5 % 97.5 %\r## steroid 0.778 1.010\r## age 1.006 1.023\r## gender 0.627 0.982\r## hot 1.093 1.496\r## adl 0.793 1.180\r## ams 0.775 1.145\r## rr 0.971 0.995\r## hr 0.996 1.003\r## bun 0.986 1.000\rround(exp(coefficients(model_ca_nm)),3)\r## steroid age gender hot adl ams rr hr bun ## 0.886 1.014 0.785 1.278 0.968 0.942 0.983 1.000 0.993\rステロイドの使用はHR 0.886 (95%CI 0.778 - 1.010)\n状態安定に影響を与えるとは言えない結果であった。\n(イベントが状態がよい=1のためHRが1を超えると状態を安定させる方向)\n\rモデル1-2:random効果を考慮したモデル\r# GLMMで扱うパッケージ\rlibrary(lme4)\rmodel_ca_ri \u0026lt;- coxme::coxme(data = copd_ca, Surv(time_to_stability,stability) ~　steroid + age + gender + hot + adl + ams + rr + hr + bun + (1|hospital))\r最後の(1|hospital)が施設ごとに切片が違うことを表している。\n# 結果の確認\rsummary(model_ca_ri)\r## Cox mixed-effects model fit by maximum likelihood\r## Data: copd_ca\r## events, n = 932, 1119\r## Iterations= 5 23 ## NULL Integrated Fitted\r## Log-likelihood -5446.863 -5416.35 -5410.778\r## ## Chisq df p AIC BIC\r## Integrated loglik 61.03 10.00 2.3152e-09 41.03 -7.35\r## Penalized loglik 72.17 12.29 1.6582e-10 47.58 -11.89\r## ## Model: Surv(time_to_stability, stability) ~ steroid + age + gender + hot + adl + ams + rr + hr + bun + (1 | hospital) ## Fixed coefficients\r## coef exp(coef) se(coef) z p\r## steroid -0.1891431726 0.8276680 0.069411572 -2.72 0.0064\r## age 0.0114649558 1.0115309 0.004530116 2.53 0.0110\r## gender -0.2397071791 0.7868582 0.114585337 -2.09 0.0360\r## hot 0.2924630311 1.3397232 0.080883780 3.62 0.0003\r## adl 0.0318516716 1.0323644 0.102796189 0.31 0.7600\r## ams -0.0956917165 0.9087441 0.101592480 -0.94 0.3500\r## rr -0.0174388264 0.9827123 0.006113988 -2.85 0.0043\r## hr -0.0002423059 0.9997577 0.001846803 -0.13 0.9000\r## bun -0.0075758979 0.9924527 0.003531128 -2.15 0.0320\r## ## Random effects\r## Group Variable Std Dev Variance ## hospital Intercept 0.23398785 0.05475031\rround(exp(confint(model_ca_ri)),3)\r## 2.5 % 97.5 %\r## steroid 0.722 0.948\r## age 1.003 1.021\r## gender 0.629 0.985\r## hot 1.143 1.570\r## adl 0.844 1.263\r## ams 0.745 1.109\r## rr 0.971 0.995\r## hr 0.996 1.003\r## bun 0.986 0.999\rround(exp(coefficients(model_ca_ri)),3)\r## steroid age gender hot adl ams rr hr bun ## 0.828 1.012 0.787 1.340 1.032 0.909 0.983 1.000 0.992\rランダム切片モデルで考えると＜曝露＞ステロイドの使用は有意であった。\n今回は臨床的な病態安定の達成をイベントとして1とカウントしている。\nHR 0.83ということはむしろ安定させない方向に働くと考えられる。\nモデル1-2:切片のチェック\rlibrary(lme4)\rranef(model_ca_ri)\r## $hospital\r## 1 2 3 4 5 ## 0.02903655 0.29990271 -0.01872156 -0.01416696 -0.29605075\r病院別のランダム切片の値を確認するとそれぞればらつきがあることが分かる。\n病院1,2の方が基本イベント達成しやすい傾向があるようだ。\nこの辺りは病院による何らかの特性の違いを反映していると考えられる。\nしかし、そもそもageや在宅酸素が正の値をとっていることから\n年齢が高くなる、在宅酸素をしていると病態が安定するという結果になる。\n臨床的な感覚からすると矛盾であり、データの妥当性やモデルの妥当性を含めて検証が必要かもしれない。\n\r\rmodel2-1:傾向スコア + ランダム効果を無視\rまずクラスター効果を無視した傾向スコアを算出する。\n治療指標の作成\r今後の便利のためsteroidとは別に治療指標という変数を作成する、治療指標は因子型としておく\ncopd_ca$treated \u0026lt;- as.factor(copd_ca$steroid)\r\r連続予測子の標準化\r#標準化された連続予測子\rfor (var in covariateNames_ca) {\rif (class(copd_ca[,var])!=\u0026quot;factor\u0026quot;) { copd_ca[,var] = (copd_ca[,var]-mean(copd_ca[,var]))/sd(copd_ca[,var]) } }\r\r傾向スコアの推定\r#ロジスティック回帰モデルの式の作成\rps.formula0 \u0026lt;- paste(covariateNames_ca, collapse=\u0026quot;+\u0026quot;) ps.formula0 \u0026lt;- formula(paste(\u0026quot;treated~\u0026quot;,ps.formula0))\rprint(ps.formula0)\r## treated ~ gender + age + hot + adl + rr + ams + hr + bun\r#クラスタリングを無視した傾向スコアの推定\rps.model0 \u0026lt;- glm(ps.formula0, data = copd_ca, family=binomial)\r#クラスタリングを無視した傾向スコアを得る\rcopd_ca$ps0 \u0026lt;- fitted(ps.model0)\r\r共通指示の評価(傾向スコアの分布にばらつきがないか)\rhist(copd_ca$ps0[copd_ca$treated==0], density = 10, angle = 45, main=\u0026quot;Propensity Scores\u0026quot;,\rbreaks=seq(0,1,by=0.01),\rxlim=c(0,1), ylim=c(0,60), xlab=\u0026quot;Shaded = Untreated | Gray = Steroid\u0026quot;)\rhist(copd_ca$ps0[copd_ca$treated==1], col=gray(0.4,0.25), breaks=seq(0,1,by=0.01),\rxlim=c(0,1), ylim=c(0,60),add=T) \r傾向スコアの分布は同じくらいであることが分かる。\n\rATEの推定\r今回の興味は試験に参加した全集団にステロイド使用した場合の平均因果効果である。\n# 重みの計算\rcopd_ca$psw0 \u0026lt;- with(copd_ca, ifelse(treated==1, 1/ps0, 1/(1-ps0)))\r#重みの正規化\rcopd_ca$psw0 \u0026lt;- copd_ca$psw0/mean(copd_ca$psw0)\r# 統合\rwith(copd_ca, by(psw0, steroid, summary))\r## steroid: 0\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.8188 1.0006 1.0756 1.1079 1.1847 1.7251 ## ------------------------------------------------------------ ## steroid: 1\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.6717 0.8418 0.9100 0.9112 0.9720 1.1853\r\r両群のバランス評価\r傾向スコアで調整するにあたり、曝露群と非曝露群でバランスがとれているかの評価が必要\nまずはベースラインでの評価を行う\nrequire(twang)\rbaseline.balance0 \u0026lt;- bal.stat(data=copd_ca,#dataset\rvar=covariateNames_ca,#list of the variables to be included in the balance check\rtreat.var=\u0026quot;treated\u0026quot;,#treatment assignment variable\rw.all=1,#define weights equal to 1 (no weighting)\rsampw=1,#define the sampling weights (no weighting)\rget.means=T, #compute means and variances\rget.ks=F,#overwrite the default for obtaining KS statistic\restimand=\u0026quot;ATE\u0026quot;,#specify the estimand of interest\rmultinom=F)#underline that multinomial ps are not used\rbaseline.balance.es \u0026lt;- baseline.balance0$results\rsummary(abs(baseline.balance.es$std.eff.sz))\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.02125 0.03662 0.04553 0.07668 0.12321 0.18266\r標準化効果量は最大で0.18266とバランスがとれていない項目があることが分かる。\n続いて傾向スコアで重みづけした後のバランス評価を行う。\npsw.balance0 \u0026lt;- bal.stat(data=copd_ca,#dataset\rvar=covariateNames_ca,#list of the variables to be included in the balance check\rtreat.var=\u0026quot;treated\u0026quot;,#treatment assignment variable\rw.all=copd_ca$psw0,#define the overall weights\rsampw=1,#define the sampling weights\rget.means=T, #compute means and variances\rget.ks=F,#overwrite the default for obtaining KS statistic\restimand=\u0026quot;ATE\u0026quot;,#specify the estimand of interest\rmultinom=F)#underline that multinomial ps are not used\rpsw.balance.table0 \u0026lt;- psw.balance0$results\rsummary(abs(psw.balance.table0$std.eff.sz))\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.0001159 0.0008443 0.0025712 0.0019355 0.0027109 0.0033863\r標準効果量の最大値は0.0033863であり両群でバランスがとれていることが分かる。\n\r生存時間解析\rlibrary(hrIPW)\rmodel_ca_ps \u0026lt;- coxph(data = copd_ca, Surv(time_to_stability,stability) ~　treated, weights = psw0, robust = TRUE)\r結果確認\nsummary(model_ca_ps)\r## Call:\r## coxph(formula = Surv(time_to_stability, stability) ~ treated, ## data = copd_ca, weights = psw0, robust = TRUE)\r## ## n= 1119, number of events= 932 ## ## coef exp(coef) se(coef) robust se z Pr(\u0026gt;|z|) ## treated1 -0.11933 0.88752 0.06591 0.06498 -1.836 0.0663 .\r## ---\r## Signif. codes: 0 \u0026#39;***\u0026#39; 0.001 \u0026#39;**\u0026#39; 0.01 \u0026#39;*\u0026#39; 0.05 \u0026#39;.\u0026#39; 0.1 \u0026#39; \u0026#39; 1\r## ## exp(coef) exp(-coef) lower .95 upper .95\r## treated1 0.8875 1.127 0.7814 1.008\r## ## Concordance= 0.509 (se = 0.011 )\r## Likelihood ratio test= 3.28 on 1 df, p=0.07\r## Wald test = 3.37 on 1 df, p=0.07\r## Score (logrank) test = 3.28 on 1 df, p=0.07, Robust = 3.44 p=0.06\r## ## (Note: the likelihood ratio and score tests assume independence of\r## observations within a cluster, the Wald and robust score tests do not).\rround(exp(confint(model_ca_ps)),3)\r## 2.5 % 97.5 %\r## treated1 0.781 1.008\rround(exp(coefficients(model_ca_ps)),3)\r## treated1 ## 0.888\rロバスト推定した場合：HR 0.888、95%CI: 0.781 - 1.008で有意にはならなかった。\n\r\rmodel2-2:傾向スコア + ランダム効果を含む\r2-1.マルチレベルロジスティック回帰モデル式の作成\rps.formula \u0026lt;- paste(covariateNames_ca, collapse=\u0026quot;+\u0026quot;) # 今回はクラスター効果を示す変数がはいっている\rps.formula \u0026lt;- formula(paste(\u0026quot;steroid~\u0026quot;,ps.formula,\u0026quot;+ (1|hospital)\u0026quot;))\r\r2-2.ランダム切片によるマルチレベルロジスティック回帰\r#ランダム切片によるマルチレベルモデル ps.model \u0026lt;- glmer(formula = ps.formula, family = binomial, data = copd_ca, #it was necessary to use the \u0026quot;control\u0026quot; argument to obtain convergence\r#by chaing the optimizer and increasing the number of iterations\rcontrol=glmerControl(optimizer=\u0026quot;bobyqa\u0026quot;,optCtrl=list(maxfun=2e5))) #使用する非線形オプティマイザや非線形オプティマイザに渡すパラメータなどの制御パラメータを含むリスト\r\r2-3. 傾向スコアを得る\r#傾向スコアを得\rcopd_ca$ps=fitted(ps.model) ##extract the model estimated propensity scores\rwith(copd_ca, by(ps, treated, summary))\r## treated: 0\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.1112 0.4352 0.5142 0.5025 0.6093 0.8183 ## ------------------------------------------------------------ ## treated: 1\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.1520 0.5002 0.5943 0.5867 0.6771 0.8920\r\r2-4. 共通支持を評価\rhist(copd_ca$ps[copd_ca$treated==0], density = 10, angle = 45, main=\u0026quot;Propensity Scores\u0026quot;,\rbreaks=seq(0,1,by=0.01),\rxlim=c(0,1), ylim=c(0,40), xlab=\u0026quot;Shaded = Untreated | Gray = Treated\u0026quot;)\rhist(copd_ca$ps[copd_ca$treated==1], col=gray(0.4,0.25), breaks=seq(0,1,by=0.01),\rxlim=c(0,1), ylim=c(0,40),add=T) \r傾向スコアのばらつきはあるが重なりは同じくらいであることが分かる\n傾向スコアのカーネル密度推定\ndensityplot( ~ ps, groups=steroid, plot.points=F, xlim=c(0,1), data = copd_ca, ylab = \u0026quot;Propensity Scores\u0026quot;, xlab = \u0026quot;Treatment\u0026quot;,auto.key = TRUE)\r\r2-5. ATEの推定\r今回も興味は試験に参加した全集団でのステロイドの因果効果である。\n# 重みの計算\rcopd_ca$psw \u0026lt;- with(copd_ca, ifelse(treated==1, 1/ps, 1/(1-ps)))\r#重みの正規化\rcopd_ca$psw \u0026lt;- copd_ca$psw/mean(copd_ca$psw)\r# 統合\rwith(copd_ca, by(psw, steroid, summary))\r## steroid: 0\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.5665 0.8914 1.0364 1.1085 1.2888 2.7716 ## ------------------------------------------------------------ ## steroid: 1\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.5645 0.7436 0.8472 0.9108 1.0067 3.3119\rpsw.balance \u0026lt;- bal.stat(data=copd_ca,#dataset\rvar=covariateNames_ca,#list of the variables to be included in the balance check\rtreat.var=\u0026quot;treated\u0026quot;,#treatment assignment variable\rw.all=copd_ca$psw,#define the overall weights\rsampw=1,#define the sampling weights\rget.means=T, #compute means and variances\rget.ks=F,#overwrite the default for obtaining KS statistic\restimand=\u0026quot;ATE\u0026quot;,#specify the estimand of interest\rmultinom=F)#underline that multinomial ps are not used\rpsw.balance.table \u0026lt;- psw.balance$results\rsummary(abs(psw.balance.table$std.eff.sz))\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.001953 0.004157 0.006546 0.006607 0.008396 0.011965\r最大でも標準効果量が0.1未満であり両群のバランスは保たれている。\nmodel_ca_psw \u0026lt;- coxph(data = copd_ca, Surv(time_to_stability,stability) ~　treated, weights = psw, robust = TRUE)\r結果確認\nsummary(model_ca_psw)\r## Call:\r## coxph(formula = Surv(time_to_stability, stability) ~ treated, ## data = copd_ca, weights = psw, robust = TRUE)\r## ## n= 1119, number of events= 932 ## ## coef exp(coef) se(coef) robust se z Pr(\u0026gt;|z|) ## treated1 -0.18572 0.83051 0.06618 0.06887 -2.697 0.007 **\r## ---\r## Signif. codes: 0 \u0026#39;***\u0026#39; 0.001 \u0026#39;**\u0026#39; 0.01 \u0026#39;*\u0026#39; 0.05 \u0026#39;.\u0026#39; 0.1 \u0026#39; \u0026#39; 1\r## ## exp(coef) exp(-coef) lower .95 upper .95\r## treated1 0.8305 1.204 0.7256 0.9505\r## ## Concordance= 0.521 (se = 0.011 )\r## Likelihood ratio test= 7.87 on 1 df, p=0.005\r## Wald test = 7.27 on 1 df, p=0.007\r## Score (logrank) test = 7.9 on 1 df, p=0.005, Robust = 7.45 p=0.006\r## ## (Note: the likelihood ratio and score tests assume independence of\r## observations within a cluster, the Wald and robust score tests do not).\rround(exp(confint(model_ca_psw)),3)\r## 2.5 % 97.5 %\r## treated1 0.726 0.951\rround(exp(coefficients(model_ca_psw)),3)\r## treated1 ## 0.831\rHR 0.831, 95%CI:0.726 - 0.951\n施設のランダム効果を考慮して傾向スコアを算出し、ATEを推定して生存時間解析を行うと結果は有意であった。\n\r\r結果のまとめ\r今回の結果では、クラスター効果を無視した解析を行うと興味のある曝露の効果は有意とはならず、\nクラスター効果を考慮した解析を行うと有意になった。\n傾向スコアを推定した場合としていない場合とでは点推定値および信頼区間には大きな差はなかった。\n##【reference】\n\rCitation\rShiroshita, Akihiro (2020), Effectiveness of steroid therapy on pneumonic chronic obstructive pulmonary disease exacerbation: a multi-centred retrospective cohort study, v3, Dryad, Dataset, https://doi.org/10.5061/dryad.m63xsj3zd\r\rFan Li, Alan M Zaslavsky, Mary Beth Landrum\rPropensity socre weighing with multilevel data. Stat Med. 2013.30;32(19):3373 - 87.\nP.Austin\rVariance estimation when using inverse probability of treatment weighting with survival analysis.\rStat Med. 2016.35(30):5642 - 55.\n\r","date":1595924002,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1595924002,"objectID":"88f9328f624d1975b4611ec58f50ad8b","permalink":"/post/propensity_score_multi/","publishdate":"2020-07-28T17:13:22+09:00","relpermalink":"/post/propensity_score_multi/","section":"post","summary":"マルチレベルデータに対する傾向スコア分析","tags":["傾向スコア","マルチレベル分析","生存時間解析"],"title":"Rによる傾向スコア分析の実装２","type":"post"},{"authors":["Kumakt"],"categories":["Stata"],"content":"Stataによる線形回帰モデル Stataによる線形回帰モデルを実装する。\n# dataの読み込み\ruse https://www.stata-press.com/data/r16/lbw\r Unknown #command\r(Hosmer \u0026amp; Lemeshow data)\r 公式サイトのデータより読み込み\n189人の出生児の体重に関する研究のデータ\ndescribe\r Contains data from https://www.stata-press.com/data/r16/lbw.dta\robs: 189 Hosmer \u0026amp; Lemeshow data\rvars: 11 15 Jan 2018 05:01\r--------------------------------------------------------------------------------\rstorage display value\rvariable name type format label variable label\r--------------------------------------------------------------------------------\rid int %8.0g identification code\rlow byte %8.0g birthweight\u0026lt;2500g\rage byte %8.0g age of mother\rlwt int %8.0g weight at last menstrual period\rrace byte %8.0g race race\rsmoke byte %9.0g smoke smoked during pregnancy\rptl byte %8.0g premature labor history (count)\rht byte %8.0g has history of hypertension\rui byte %8.0g presence, uterine irritability\rftv byte %8.0g number of visits to physician\rduring 1st trimester\rbwt int %8.0g birthweight (grams)\r--------------------------------------------------------------------------------\rSorted by:  データの分析 まずデータの分析を行う。\n目的変数は出生時の体重である。\n母体の年齢や喫煙などが関与していることが予想される。\nsu age bwt smoke, detail\r  age of mother\r-------------------------------------------------------------\rPercentiles Smallest\r1% 14 14\r5% 16 14\r10% 17 14 Obs 189\r25% 19 15 Sum of Wgt. 189\r50% 23 Mean 23.2381\rLargest Std. Dev. 5.298678\r75% 26 35\r90% 31 36 Variance 28.07599\r95% 32 36 Skewness .7164391\r99% 36 45 Kurtosis 3.568442\rbirthweight (grams)\r-------------------------------------------------------------\rPercentiles Smallest\r1% 1021 709\r5% 1790 1021\r10% 1970 1135 Obs 189\r25% 2414 1330 Sum of Wgt. 189\r50% 2977 Mean 2944.286\rLargest Std. Dev. 729.016\r75% 3475 4174\r90% 3884 4238 Variance 531464.4\r95% 3997 4593 Skewness -.2069782\r99% 4593 4990 Kurtosis 2.888821\rsmoked during pregnancy\r-------------------------------------------------------------\rPercentiles Smallest\r1% 0 0\r5% 0 0\r10% 0 0 Obs 189\r25% 0 0 Sum of Wgt. 189\r50% 0 Mean .3915344\rLargest Std. Dev. .4893898\r75% 1 1\r90% 1 1 Variance .2395024\r95% 1 1 Skewness .4444461\r99% 1 1 Kurtosis 1.197532\r tabulate low smoke, chi2 column\r +-------------------+\r| Key |\r|-------------------|\r| frequency |\r| column percentage |\r+-------------------+\r| smoked during\rbirthweigh | pregnancy\rt\u0026lt;2500g | nonsmoker smoker | Total\r-----------+----------------------+----------\r0 | 86 44 | 130 | 74.78 59.46 | 68.78 -----------+----------------------+----------\r1 | 29 30 | 59 | 25.22 40.54 | 31.22 -----------+----------------------+----------\rTotal | 115 74 | 189 | 100.00 100.00 | 100.00 Pearson chi2(1) = 4.9237 Pr = 0.026\r 低体重と母体の喫煙歴の関係を見ると、明らかに喫煙歴のある母体の方が低体重出生児が多い。\n$$\\chi^2$$検定でも有意に喫煙歴がある方が低体重出生児が多いという結果であった。\nグラフで可視化する # ヒストグラム作成\rhist bwt, bin(25)\r 次は散布図を作成する\n# 散布図を作成\rscatter bwt age\r 線形回帰モデルの作成 出生時の体重と母体の年齢が線形であると仮定すると、\n$$Y_{i(bwt)} = \\beta_0 + \\beta*x_{i(age)} + \\epsilon$$\nと表すことができる。\n$$\\epsilon$$は残差である。\nregress bwt age\r  Source | SS df MS Number of obs = 189\r-------------+---------------------------------- F(1, 187) = 1.51\rModel | 800428.169 1 800428.169 Prob \u0026gt; F = 0.2207\rResidual | 99114870.4 187 530026.045 R-squared = 0.0080\r-------------+---------------------------------- Adj R-squared = 0.0027\rTotal | 99915298.6 188 531464.354 Root MSE = 728.03\r------------------------------------------------------------------------------\rbwt | Coef. Std. Err. t P\u0026gt;|t| [95% Conf. Interval]\r-------------+----------------------------------------------------------------\rage | 12.31444 10.02079 1.23 0.221 -7.45389 32.08277\r_cons | 2658.122 238.8097 11.13 0.000 2187.014 3129.229\r------------------------------------------------------------------------------\r 回帰式のモデルの結果は、\n$$Y_{i(bwt)} = 12.31*x_{i(age)} + 2658.122$$\nである。\nつまり母体の年齢が1歳増えるごとに12.31gずつ体重が増えることになる。\nしかし、そもそも母体の年齢と体重には線形の関係がはっきりはなさそうである。\n今回のモデルの決定係数も0.0027と非常に低い。\nむしろ他のモデルを考えた方が良さそうである。\n重回帰モデル 先のモデルでは、年齢と低体重出生児との関係はあまりなさそうであった。\nむしろモデルには喫煙歴などを含めた方がよいモデルができる可能性が高い。\n今度は母体の喫煙歴、年齢、人種で調整したモデルの作成を行う。\n$$Y_{i(bwt)} = \\beta_0 + \\beta_1*x_{i(smoke)} + \\beta_2*x_{i(age)} + \\beta_3*x_{i(race)} + \\epsilon$$\nregress bwt smoke age i.race\r  Source | SS df MS Number of obs = 189\r-------------+---------------------------------- F(4, 184) = 6.50\rModel | 12366825.4 4 3091706.34 Prob \u0026gt; F = 0.0001\rResidual | 87548473.2 184 475806.92 R-squared = 0.1238\r-------------+---------------------------------- Adj R-squared = 0.1047\rTotal | 99915298.6 188 531464.354 Root MSE = 689.79\r------------------------------------------------------------------------------\rbwt | Coef. Std. Err. t P\u0026gt;|t| [95% Conf. Interval]\r-------------+----------------------------------------------------------------\rsmoke | -425.5563 109.9505 -3.87 0.000 -642.4822 -208.6304\rage | 1.998899 9.767361 0.20 0.838 -17.27152 21.26932\r|\rrace |\rblack | -444.6489 156.1404 -2.85 0.005 -752.7047 -136.5931\rother | -449.481 118.9765 -3.78 0.000 -684.2147 -214.7474\r|\r_cons | 3284.964 260.5749 12.61 0.000 2770.865 3799.062\r------------------------------------------------------------------------------\r 今回のモデルではProb \u0026gt; Fを見ると、このモデルは有意であり、調整決定係数も最初のモデルより改善している。\nそれでも係数は低く、あまりこのモデルでは説明できていないことになる。\nestat esize\r Effect sizes for linear models\r-----------------------------------------------------------------\rSource | Eta-Squared df [95% Conf. Interval]\r--------------------+--------------------------------------------\rModel | .1237731 4 .0358881 .1997528\r|\rsmoke | .0752852 1 .0183756 .1560631\rage | .0002276 1 . .0199652\rrace | .0847912 2 .0197304 .1627342\r-----------------------------------------------------------------\rNote: Eta-Squared values for individual model terms are partial.\r このコマンドをすることでこのモデル式の全体での効果サイズが分かる。\n全体では0.124であり、修正前の決定係数と同じ値である。\nつまり修正前の決定係数によれば、bwtの変化の約12.4%がこのモデルによって説明されることを示している。\n下の数値は各変数の効果サイズで、smokeは他のすべての項で説明されている変化を除いて約7.7%bwtの変化を説明 できることを意味する。\nモデルの評価 線形回帰モデルでは残差の正規性と等分散性が前提となっている。\nそのため、それを確認する必要がある。\n# 推定値を求める\rregress bwt smoke age i.race\rpredict re, residuals\r Unknown #command\rSource | SS df MS Number of obs = 189\r-------------+---------------------------------- F(4, 184) = 6.50\rModel | 12366825.4 4 3091706.34 Prob \u0026gt; F = 0.0001\rResidual | 87548473.2 184 475806.92 R-squared = 0.1238\r-------------+---------------------------------- Adj R-squared = 0.1047\rTotal | 99915298.6 188 531464.354 Root MSE = 689.79\r------------------------------------------------------------------------------\rbwt | Coef. Std. Err. t P\u0026gt;|t| [95% Conf. Interval]\r-------------+----------------------------------------------------------------\rsmoke | -425.5563 109.9505 -3.87 0.000 -642.4822 -208.6304\rage | 1.998899 9.767361 0.20 0.838 -17.27152 21.26932\r|\rrace |\rblack | -444.6489 156.1404 -2.85 0.005 -752.7047 -136.5931\rother | -449.481 118.9765 -3.78 0.000 -684.2147 -214.7474\r|\r_cons | 3284.964 260.5749 12.61 0.000 2770.865 3799.062\r------------------------------------------------------------------------------\r ### 残差の正規性の確認\rhist re, normal\r 正規性は保たれているようである。\nQQ plot qnorm re\r 統計学的検定 sktest re\r Skewness and kurtosis tests for normality\r----- Joint test -----\rVariable | Obs Pr(skewness) Pr(kurtosis) Adj chi2(2) Prob\u0026gt;chi2\r-------------+-----------------------------------------------------------------\rre | 189 0.0555 0.9848 3.71 0.1564\r 帰無仮説は「残差に正規性がある」である。\n棄却されると正規性がないことになる。\n等分散性の確認 rvfplot, yline(0)\r 統計学的検定 hettest\r Breusch-Pagan / Cook-Weisberg test for heteroskedasticity Ho: Constant variance\rVariables: fitted values of bwt\rchi2(1) = 0.00\rProb \u0026gt; chi2 = 0.9961\r 棄却されないので、等分散性は少なくとも否定はされないことになる。\n参考文献 Stata公式資料\nhttps://www.stata-press.com\n講義プリント\n","date":1595756412,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1595756412,"objectID":"eaf8f63553623fe2d34b89e15071b510","permalink":"/post/linear_regression/","publishdate":"2020-07-26T18:40:12+09:00","relpermalink":"/post/linear_regression/","section":"post","summary":"Stataによる線形回帰モデルについて簡単に","tags":["線形回帰モデル"],"title":"Stataによる線形回帰モデルの実装","type":"post"},{"authors":["Kumakt"],"categories":["R"],"content":"\rサンプルデータを作成する\r以前の「Rによる傾向スコアの実装」で使用したデータと同じ仮想データを用いる。\n適当なデータがないため、仮想データを作成する。\n\rEffect of Targeted Polymyxin B Hemoperfusion on 28-Day Mortality in Patients With Septic Shock and Elevated Endotoxin Level\n\rThe EUPHRATES Randomized Clinical Trialより\n\r元ネタは敗血症性ショックに対するエンドトキシン吸着療法の多施設共同RCT(60施設)\n\rPMX療法(透析)対シャム療法(偽透析：透析している振り)\n\rサンプル数:450名のRCT\n\rAge, Sex, 平均血圧(Arterial pressure mean:MAP)、重症度スコア(APACHEⅡ)、人工呼吸器の有無(Mechanical\nventilation)、菌血症の有無(Bacteremia)\n\r介入:エンドトキシン吸着療法(PMX)\n\rアウトカム:28日後死亡(twentyeight_day_mortality)\n\r今回は多施設観察研究と想定し施設数も作成して、10施設とする\n\r\rJAMA\nhttps://jamanetwork.com/journals/jama/fullarticle/2706139\n\rパッケージの読み込み\rlibrary(dplyr)\r# パイプを使うため\rlibrary(magrittr)\r# シミュレーションデータを作るため\rlibrary(simstudy)\r\r仮想データの実装\rset.seed(123) # seedを設定することで必ず同じデータが毎回できるので再現性の固定\r# まず施設IDの作成\rb \u0026lt;- defData(varname = \u0026quot;institution_id\u0026quot;, dist = \u0026quot;noZeroPoisson\u0026quot;, formula = 3)\rc \u0026lt;- genData(450, b)\r# 各変数の作成\ra \u0026lt;- data.frame(rnorm(450,59,8),rbinom(450,1,prob=0.6),rnorm(450,72,5),rnorm(450,28,5),rbinom(450,1,0.94)\r,rbinom(450,1,0.30),rbinom(450,1,0.5),rbinom(450,1,0.34))\rcolnames(a) \u0026lt;- c(\u0026#39;Age\u0026#39;,\u0026#39;Sex\u0026#39;,\u0026#39;MAP\u0026#39;,\u0026#39;APACHEⅡ\u0026#39;,\u0026#39;Mechanical_ventilation\u0026#39;,\u0026#39;Bacteremia\u0026#39;,\u0026#39;PMX\u0026#39;,\u0026#39;twentyeight_day_mortality\u0026#39;)\r# 列の名前を付ける # sex 1=male, Mechanical_ventilation yes=1, Bacteremia yes=1, PMX yes=1, 28day_mortality yes=1 \r両者を結合する。\npmx \u0026lt;- cbind.data.frame(c,a)\rpmx \u0026lt;- as.data.frame(pmx)\r\r作成したデータの確認\rsummary(pmx)\r## id institution_id Age Sex ## Min. : 1.0 Min. : 1.000 Min. :36.52 Min. :0.0000 ## 1st Qu.:113.2 1st Qu.: 2.000 1st Qu.:54.19 1st Qu.:0.0000 ## Median :225.5 Median : 3.000 Median :59.33 Median :1.0000 ## Mean :225.5 Mean : 3.142 Mean :59.11 Mean :0.5822 ## 3rd Qu.:337.8 3rd Qu.: 4.000 3rd Qu.:64.59 3rd Qu.:1.0000 ## Max. :450.0 Max. :10.000 Max. :79.57 Max. :1.0000 ## MAP APACHEⅡ Mechanical_ventilation Bacteremia ## Min. :59.25 Min. :12.76 Min. :0.0000 Min. :0.0000 ## 1st Qu.:68.47 1st Qu.:25.05 1st Qu.:1.0000 1st Qu.:0.0000 ## Median :71.81 Median :28.54 Median :1.0000 Median :0.0000 ## Mean :72.00 Mean :28.30 Mean :0.9267 Mean :0.2689 ## 3rd Qu.:75.03 3rd Qu.:31.90 3rd Qu.:1.0000 3rd Qu.:1.0000 ## Max. :88.95 Max. :44.45 Max. :1.0000 Max. :1.0000 ## PMX twentyeight_day_mortality\r## Min. :0.0000 Min. :0.0000 ## 1st Qu.:0.0000 1st Qu.:0.0000 ## Median :0.0000 Median :0.0000 ## Mean :0.4889 Mean :0.3467 ## 3rd Qu.:1.0000 3rd Qu.:1.0000 ## Max. :1.0000 Max. :1.0000\rstr(pmx)\r## \u0026#39;data.frame\u0026#39;: 450 obs. of 10 variables:\r## $ id : int 1 2 3 4 5 6 7 8 9 10 ...\r## $ institution_id : num 2 4 3 5 6 1 3 5 3 3 ...\r## $ Age : num 59.5 53.4 53.3 66.1 50.9 ...\r## $ Sex : int 1 1 1 1 1 1 1 0 1 1 ...\r## $ MAP : num 66.9 68 73.5 80.2 77.4 ...\r## $ APACHEⅡ : num 27.3 20.8 24 32.4 32.5 ...\r## $ Mechanical_ventilation : int 1 1 1 1 1 1 1 1 0 1 ...\r## $ Bacteremia : int 0 0 0 0 0 1 1 0 0 0 ...\r## $ PMX : int 0 0 0 1 0 0 0 0 1 1 ...\r## $ twentyeight_day_mortality: int 1 0 0 0 0 1 0 0 1 0 ...\rおおむね狙い通りのデータになっていることが分かる。\n今回は２つの解析を行う。\nマルチレベルロジスティック回帰モデルを実装する。\n\r前回と違い施設というクラスターを含めて傾向スコアを用いて解析を実装する。\n\r\rまずは1のマルチレベルロジスティック回帰について実装する。\nモデルを２つ作成する。\n\rモデル1:クラスター効果を無視した多変量ロジスティック回帰\n\rモデル2:クラスター効果を加えたマルチレベルロジスティック回帰\n\r\r\rモデル1 多変量ロジスティック回帰\r最初に通常のロジスティック回帰を行う。\nこのモデルではクラスター効果を無視してモデルを作る。\nつまり結果には施設間の差は影響しないという仮定である。\nそのため個人レベルでの変数のみが影響するとしてモデルを作成する。\n被検者iの死亡する確率を\\(p_i\\)とすると、(すなわち死亡という場合の条件付き確率)\n\\(logit(p_i) = log odds = log(\\frac{p_i}{1-p_i}) = M + e_i\\)\nと表すことができる。\nここで、Mはロジスティック尺度で表された集団全体の平均確率、\\(e_i\\)はiの残差である。\nモデル1では各個人レベルの変数が死亡する確率に影響を与えていると考える。\n\\(logit(p_i) = M + \\beta_1*PMX_i + \\beta_2*Age_i + \\beta_3*Sex_i + \\beta_4*APACH_i + \\beta_5*Ven_i + e_i\\)\nとして表すことができる。\n共変量の設定\rcovariateName_nc \u0026lt;- c(\r\u0026quot;PMX\u0026quot;,\u0026quot;Age\u0026quot;,\u0026quot;Sex\u0026quot;,\u0026quot;MAP\u0026quot;, \u0026quot;APACHEⅡ\u0026quot;, \u0026quot;Mechanical_ventilation\u0026quot;\r)\r\r式の作成\rnc.formula \u0026lt;- paste(covariateName_nc, collapse=\u0026quot;+\u0026quot;) nc.formula \u0026lt;- formula(paste(\u0026quot;twentyeight_day_mortality~\u0026quot;,nc.formula))\rprint(nc.formula)\r## twentyeight_day_mortality ~ PMX + Age + Sex + MAP + APACHEⅡ + ## Mechanical_ventilation\r\rロジスティック回帰\rmodel_nc \u0026lt;- pmx %\u0026gt;% glm(nc.formula, data = ., family = binomial(link = \u0026quot;logit\u0026quot;))\r\r結果の確認\rsummary(model_nc)\r## ## Call:\r## glm(formula = nc.formula, family = binomial(link = \u0026quot;logit\u0026quot;), ## data = .)\r## ## Deviance Residuals: ## Min 1Q Median 3Q Max ## -1.4461 -0.9199 -0.8317 1.3800 1.7795 ## ## Coefficients:\r## Estimate Std. Error z value Pr(\u0026gt;|z|) ## (Intercept) -0.457777 1.768631 -0.259 0.7958 ## PMX 0.145555 0.200801 0.725 0.4685 ## Age -0.013387 0.012768 -1.048 0.2944 ## Sex 0.191703 0.205746 0.932 0.3515 ## MAP 0.005604 0.020071 0.279 0.7801 ## APACHEⅡ 0.029188 0.020369 1.433 0.1519 ## Mechanical_ventilation -0.873933 0.367343 -2.379 0.0174 *\r## ---\r## Signif. codes: 0 \u0026#39;***\u0026#39; 0.001 \u0026#39;**\u0026#39; 0.01 \u0026#39;*\u0026#39; 0.05 \u0026#39;.\u0026#39; 0.1 \u0026#39; \u0026#39; 1\r## ## (Dispersion parameter for binomial family taken to be 1)\r## ## Null deviance: 580.82 on 449 degrees of freedom\r## Residual deviance: 570.18 on 443 degrees of freedom\r## AIC: 584.18\r## ## Number of Fisher Scoring iterations: 4\rオッズ比へ変換する\n# オッズ比と95%信頼区間の確認\rnc_odds \u0026lt;- as.data.frame(cbind(exp(summary(model_nc)$coefficient[,1]),exp(confint(model_nc))\r,summary(model_nc)$coefficient[,4]))\r## Waiting for profiling to be done...\r# result_oddsというデータフレームの列名を名付ける\rnames(nc_odds) \u0026lt;- c(\u0026quot;Odds ratio\u0026quot;,\u0026quot;lower 95%CI\u0026quot;,\u0026quot;upper 95%CI\u0026quot;,\u0026quot;P value\u0026quot;)\r# 小数点２桁で結果を表示\rround(nc_odds,2)\r## Odds ratio lower 95%CI upper 95%CI P value\r## (Intercept) 0.63 0.02 20.42 0.80\r## PMX 1.16 0.78 1.72 0.47\r## Age 0.99 0.96 1.01 0.29\r## Sex 1.21 0.81 1.82 0.35\r## MAP 1.01 0.97 1.05 0.78\r## APACHEⅡ 1.03 0.99 1.07 0.15\r## Mechanical_ventilation 0.42 0.20 0.86 0.02\rlibrary(pROC)\rROC_nc \u0026lt;- roc(response = pmx$twentyeight_day_mortality, predictor = model_nc$fitted.values)\rROC_nc\r## ## Call:\r## roc.default(response = pmx$twentyeight_day_mortality, predictor = model_nc$fitted.values)\r## ## Data: model_nc$fitted.values in 294 controls (pmx$twentyeight_day_mortality 0) \u0026lt; 156 cases (pmx$twentyeight_day_mortality 1).\r## Area under the curve: 0.598\rAUC 0.598でモデルの精度は良くないことが分かる。\n結果としては、PMXはOR 1.16 (95%CI:0.78 - 1.72)で死亡を減らす関係は認めなかった。\nむしろ点推定値と信頼区間を考慮すると若干死亡を高める方向に働いている可能性もある。\nしかしAUCが低いことから、そもそもこのモデルの精度が良くないため共変量などについて再考する必要がありそう。\n＊人工呼吸器の使用で死亡が減る方向になっている結果は、シミュレーションデータなので今回は無視する。\n\r\rモデル2:マルチレベルロジスティック回帰\rこのモデルではクラスター効果を考慮してモデルを作る。\n回帰モデルでは観測値の独立性が前提となっている。\nしかし各施設内では同じような治療がなされ治療成績が似通っている可能性がある。\n逆に言えば施設間でPMXの適応や手技の成熟度、集中治療のレベルなどが違う可能性があり、\n個人レベルでの変数のみではなく施設も影響するとしてモデルを作成する必要がある。\n施設という階層があり、その下に個人レベルの変数があるという形である。\n施設jに所属の個人iの死亡する確率\\(p_{ij}\\)は、\n\rレベル1(個人レベル): \\(logit(p_{ij}) = M_{0j} + e_{ij}\\)\n\rレベル2(集団レベル): \\(M_{oj} = \\gamma_{00} + u_{0j}\\)\n\r\rとして表すことができる。\n\\(M_{0j}\\)は集団jの死亡する平均確率、\\(e_{ij}\\)は集団jでの個人間の残差を表している。\n\\(\\gamma_{00}\\)は集団全体の死亡する平均確率、\\(u_{0j}\\)は集団間の変動を表す。\nマルチレベルモデルでは集団によって変動しない値を固定効果(fixed effect)、\r\\(u_{oj}\\)のように変動する値を変量効果(random effedt)と呼ぶ。\nそれぞれが従う分布は平均0、個人レベルの分散\\(V_I\\)、集団レベルの分散\\(V_C\\)として、\n\\(e_{ij}\\) ~ \\(N(0,V_I)\\)\n\\(u_{0j}\\) ~ \\(N(0,V_C)\\)\nの正規分布に従うことが仮定される。\n最終的にモデル2は、\n\\(logit(p_ij) = \\gamma_{00} + u_{0j} + \\beta_1*PMX_{ij} + \\beta_2*Age_{ij} + \\beta_3*Sex_{ij} + \\beta_4*APACH_{ij} + \\beta_5*Ven_{ij} + e_{ij}\\)\nとして表すことができる。\n共変量の設定\rcovariateName_c \u0026lt;- c(\r\u0026quot;PMX\u0026quot;,\u0026quot;Age\u0026quot;,\u0026quot;Sex\u0026quot;,\u0026quot;MAP\u0026quot;, \u0026quot;APACHEⅡ\u0026quot;, \u0026quot;Mechanical_ventilation\u0026quot;\r)\r\r式の作成\rc.formula \u0026lt;- paste(covariateName_c, collapse=\u0026quot;+\u0026quot;) c.formula \u0026lt;- formula(paste(\u0026quot;twentyeight_day_mortality~\u0026quot;,c.formula,\u0026quot;+(1|institution_id)\u0026quot;))\rprint(c.formula)\r## twentyeight_day_mortality ~ PMX + Age + Sex + MAP + APACHEⅡ + ## Mechanical_ventilation + (1 | institution_id)\r\rマルチレベルロジスティック回帰\rlibrary(lme4)\rmodel_c \u0026lt;- pmx %\u0026gt;% glmer(c.formula, data = ., family = binomial(link = \u0026quot;logit\u0026quot;), control = glmerControl(optimizer = \u0026quot;bobyqa\u0026quot;),\rnAGQ = 10)\r\r結果の確認\rprint(model_c, corr = FALSE)\r## Generalized linear mixed model fit by maximum likelihood (Adaptive\r## Gauss-Hermite Quadrature, nAGQ = 10) [glmerMod]\r## Family: binomial ( logit )\r## Formula: twentyeight_day_mortality ~ PMX + Age + Sex + MAP + APACHEⅡ + ## Mechanical_ventilation + (1 | institution_id)\r## Data: .\r## AIC BIC logLik deviance df.resid ## 586.1784 619.0524 -285.0892 570.1784 442 ## Random effects:\r## Groups Name Std.Dev.\r## institution_id (Intercept) 0 ## Number of obs: 450, groups: institution_id, 10\r## Fixed Effects:\r## (Intercept) PMX Age ## -0.457777 0.145555 -0.013387 ## Sex MAP APACHEⅡ ## 0.191703 0.005604 0.029188 ## Mechanical_ventilation ## -0.873933 ## convergence code 0; 0 optimizer warnings; 1 lme4 warnings\r95%信頼区間を求める\n通常の方法では出せないので注意\nse \u0026lt;- sqrt(diag(vcov(model_c)))\r# table of estimates with 95% CI\r(tab \u0026lt;- cbind(Est = fixef(model_c), LL = fixef(model_c) - 1.96 * se, UL = fixef(model_c) + 1.96 *\rse))\r## Est LL UL\r## (Intercept) -0.457777126 -3.92314409 3.00758984\r## PMX 0.145554945 -0.24801464 0.53912453\r## Age -0.013386704 -0.03840952 0.01163611\r## Sex 0.191702790 -0.21155879 0.59496437\r## MAP 0.005604172 -0.03371708 0.04492542\r## APACHEⅡ 0.029187831 -0.01073457 0.06911023\r## Mechanical_ventilation -0.873933310 -1.59392402 -0.15394260\rオッズ比を求める\nround(exp(tab),2)\r## Est LL UL\r## (Intercept) 0.63 0.02 20.24\r## PMX 1.16 0.78 1.71\r## Age 0.99 0.96 1.01\r## Sex 1.21 0.81 1.81\r## MAP 1.01 0.97 1.05\r## APACHEⅡ 1.03 0.99 1.07\r## Mechanical_ventilation 0.42 0.20 0.86\r今回の結果は、ランダム効果の分散は0であり、目的変数には集団による違いはないことになる。\n実際、モデル1とモデル2では結果はほぼ同じである。\n\r級内相関係数\r病院などの集団内でデータがどの程度類似しているかを検討するための指標として、級内相関係数(ICC)がある。\nICCが大きいほど観測値の独立性の仮定からの逸脱が大きいことを意味する。\n線形回帰モデルと違いロジスティック回帰モデルでは解釈が難しい。\nなぜなら、集団内での分散はロジスティック尺度上にあり、個人レベルの分散は確率であるからである。\r(二項分布の分散Vはp(1-p)である。)\nいくつか計算する方法はあるが今回は分散が0のためICCは計算できない。\ntau2 \u0026lt;- lme4::VarCorr(model_c)\rtau2\r## Groups Name Std.Dev.\r## institution_id (Intercept) 0\r\r\r参考文献\rPeter C Austin, Juan Merlo. Intermediate and advanced topics in multilevel logistic regression analysis.\rStat Med. 2017. 10;36(20):3257 - 3277.\rPMID:28543517.\nJuan Merlo, Basile Chais, et.al. A brief conceptual tutorial of multilevel analysis in social epidemiology: using measures of clustering in multilevel logistic regression to investigate contextual phenomena. J Epidemiol Community Health 2006;60:290–297.\rPMID:15911637.\nThree methods for computing the intra-class correlation in multilevel logistic regression\nhttps://www.barelysignificant.com/post/icc/\nMIXED EFFECTS LOGISTIC REGRESSION | R DATA ANALYSIS EXAMPLES\nhttps://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/\n\r","date":1595670012,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1595670012,"objectID":"a6963bdc3134dfd03ee22dd825f54c2f","permalink":"/post/multilevel/","publishdate":"2020-07-25T18:40:12+09:00","relpermalink":"/post/multilevel/","section":"post","summary":"Rによるマルチレベル分析について簡単に","tags":["マルチレベル分析"],"title":"Rによるマルチレベル分析の実装","type":"post"},{"authors":["Kumakt"],"categories":["R"],"content":"\rサンプルデータを作成する\r適当なパッケージがないため、仮想データを作成する。\n\rEffect of Targeted Polymyxin B Hemoperfusion on 28-Day Mortality in Patients With Septic Shock and Elevated Endotoxin Level\n\rThe EUPHRATES Randomized Clinical Trialより\n\r元ネタは敗血症性ショックに対するエンドトキシン吸着療法の多施設共同RCT(60施設)\n\rPMX療法(透析)対シャム療法(偽透析：透析している振り)\n\rサンプル数:450名のRCT\n\rAge, Sex, 平均血圧(Arterial pressure mean:MAP)、重症度スコア(APACHEⅡ)、人工呼吸器の有無(Mechanical\nventilation)、菌血症の有無(Bacteremia)\n\r介入:エンドトキシン吸着療法(PMX)\n\rアウトカム:28日後死亡(twentyeight_day_mortality)\n\r今回は多施設観察研究と想定し施設数も作成して、10施設とする\n\r\rJAMA\nhttps://jamanetwork.com/journals/jama/fullarticle/2706139\n\rパッケージの読み込み\rlibrary(dplyr)\r# パイプを使うため\rlibrary(magrittr)\r# シミュレーションデータを作るため\rlibrary(simstudy)\r\r仮想データの実装\rset.seed(123) # seedを設定することで必ず同じデータが毎回できるので再現性の固定\r# まず施設IDの作成\rb \u0026lt;- defData(varname = \u0026quot;institution_id\u0026quot;, dist = \u0026quot;noZeroPoisson\u0026quot;, formula = 3)\rc \u0026lt;- genData(450, b)\r# 各変数の作成\ra \u0026lt;- data.frame(rnorm(450,59,8),rbinom(450,1,prob=0.6),rnorm(450,72,5),rnorm(450,28,5),rbinom(450,1,0.94)\r,rbinom(450,1,0.30),rbinom(450,1,0.5),rbinom(450,1,0.34))\rcolnames(a) \u0026lt;- c(\u0026#39;Age\u0026#39;,\u0026#39;Sex\u0026#39;,\u0026#39;MAP\u0026#39;,\u0026#39;APACHEⅡ\u0026#39;,\u0026#39;Mechanical_ventilation\u0026#39;,\u0026#39;Bacteremia\u0026#39;,\u0026#39;PMX\u0026#39;,\u0026#39;twentyeight_day_mortality\u0026#39;)\r# 列の名前を付ける # sex 1=male, Mechanical_ventilation yes=1, Bacteremia yes=1, PMX yes=1, 28day_mortality yes=1 \r両者を結合する。\npmx \u0026lt;- cbind.data.frame(c,a)\rpmx \u0026lt;- as.data.frame(pmx)\r\r作成したデータの確認\rsummary(pmx)\r## id institution_id Age Sex ## Min. : 1.0 Min. : 1.000 Min. :36.52 Min. :0.0000 ## 1st Qu.:113.2 1st Qu.: 2.000 1st Qu.:54.19 1st Qu.:0.0000 ## Median :225.5 Median : 3.000 Median :59.33 Median :1.0000 ## Mean :225.5 Mean : 3.142 Mean :59.11 Mean :0.5822 ## 3rd Qu.:337.8 3rd Qu.: 4.000 3rd Qu.:64.59 3rd Qu.:1.0000 ## Max. :450.0 Max. :10.000 Max. :79.57 Max. :1.0000 ## MAP APACHEⅡ Mechanical_ventilation Bacteremia ## Min. :59.25 Min. :12.76 Min. :0.0000 Min. :0.0000 ## 1st Qu.:68.47 1st Qu.:25.05 1st Qu.:1.0000 1st Qu.:0.0000 ## Median :71.81 Median :28.54 Median :1.0000 Median :0.0000 ## Mean :72.00 Mean :28.30 Mean :0.9267 Mean :0.2689 ## 3rd Qu.:75.03 3rd Qu.:31.90 3rd Qu.:1.0000 3rd Qu.:1.0000 ## Max. :88.95 Max. :44.45 Max. :1.0000 Max. :1.0000 ## PMX twentyeight_day_mortality\r## Min. :0.0000 Min. :0.0000 ## 1st Qu.:0.0000 1st Qu.:0.0000 ## Median :0.0000 Median :0.0000 ## Mean :0.4889 Mean :0.3467 ## 3rd Qu.:1.0000 3rd Qu.:1.0000 ## Max. :1.0000 Max. :1.0000\rstr(pmx)\r## \u0026#39;data.frame\u0026#39;: 450 obs. of 10 variables:\r## $ id : int 1 2 3 4 5 6 7 8 9 10 ...\r## $ institution_id : num 2 4 3 5 6 1 3 5 3 3 ...\r## $ Age : num 59.5 53.4 53.3 66.1 50.9 ...\r## $ Sex : int 1 1 1 1 1 1 1 0 1 1 ...\r## $ MAP : num 66.9 68 73.5 80.2 77.4 ...\r## $ APACHEⅡ : num 27.3 20.8 24 32.4 32.5 ...\r## $ Mechanical_ventilation : int 1 1 1 1 1 1 1 1 0 1 ...\r## $ Bacteremia : int 0 0 0 0 0 1 1 0 0 0 ...\r## $ PMX : int 0 0 0 1 0 0 0 0 1 1 ...\r## $ twentyeight_day_mortality: int 1 0 0 0 0 1 0 0 1 0 ...\rおおむね狙い通りのデータになっていることが分かる。\n今回は施設というクラスターは無視して傾向スコアを用いて解析を実装する。\n\r傾向スコアの作成\r実際の論文ではRCTのため傾向スコアや多変量解析は行われていない。\n今回は観察研究という設定で計算する。\nPMXを行うか否かについて関係する共変量を設定する。\nまず共変量をオブジェクトに格納する。\nこうすることの利点はモデルを作る際に見やすくなることである。\ncovariateNames \u0026lt;- c(\r\u0026quot;Age\u0026quot;,\r\u0026quot;Sex\u0026quot;,\r\u0026quot;MAP\u0026quot;,\r\u0026quot;APACHEⅡ\u0026quot;,\r\u0026quot;Mechanical_ventilation\u0026quot;\r)\r治療指標の作成\r便利のために、pmxとは別に治療指標の変数を作成する。治療指標は因子型としておく。\npmx$treat \u0026lt;- as.factor(pmx$PMX)\r####　連続予測子の標準化\n#標準化された連続予測子\rfor (var in covariateNames) {\rif (class(pmx[,var])!=\u0026quot;factor\u0026quot;) { pmx[,var] = (pmx[,var]-mean(pmx[,var]))/sd(pmx[,var]) }\r}\r\r傾向スコアの推定\r#ロジスティック回帰モデルの式の作成準備\rps.formula \u0026lt;- paste(covariateNames, collapse=\u0026quot;+\u0026quot;) ps.formula \u0026lt;- formula(paste(\u0026quot;treat~\u0026quot;,ps.formula))\rprint(ps.formula)\r## treat ~ Age + Sex + MAP + APACHEⅡ + Mechanical_ventilation\r#クラスタリングを無視した傾向スコアの推定\r#ps.model \u0026lt;- glm(ps.formula, data = pmx, family=binomial)\rps.model \u0026lt;- pmx %\u0026gt;% glm(ps.formula, data = ., family=binomial(link = \u0026quot;logit\u0026quot;))\r#クラスタリングを無視した傾向スコアを得る\rpmx$ps \u0026lt;- fitted(ps.model)\r\r傾向スコアの評価\rlibrary(pROC)\rROC \u0026lt;- pmx %\u0026gt;% roc(treat ~ ps, data = ., ci = TRUE)\rROC\r## ## Call:\r## roc.formula(formula = treat ~ ps, data = ., ci = TRUE)\r## ## Data: ps in 230 controls (treat 0) \u0026lt; 220 cases (treat 1).\r## Area under the curve: 0.5255\r## 95% CI: 0.472-0.579 (DeLong)\r今回はAUC 0.5255と低い値であり、モデルの精度として良くないようである。\n\rCommon supportの評価\r傾向スコアにばらつきがないかを評価する\nhist(pmx$ps[pmx$treat==0], density = 10, angle = 45, main=\u0026quot;Propensity Scores\u0026quot;,\rbreaks=seq(0,1,by=0.01),\rxlim=c(0,1), ylim=c(0,50), xlab=\u0026quot;Shaded = Untreated | Gray = PMX\u0026quot;)\rhist(pmx$ps[pmx$treat==1], col=gray(0.4,0.25), breaks=seq(0,1,by=0.01),\rxlim=c(0,1), ylim=c(0,50),add=T) \rPMX群とコントロール群では傾向スコアの分布は同じくらいであることが分かる。\n\r\rATEの推定\r今回は、試験の対象集団全体におけるPMXの効果を知りたいのであるからAverage treatment effect(ATE)を\r推定することとする。\n# 重みの計算\rpmx$psw \u0026lt;- with(pmx, ifelse(treat==1, 1/ps, 1/(1-ps)))\rsummary(pmx$psw)\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 1.745 1.929 1.995 2.000 2.056 2.301\r今回は傾向スコアに極端なweightはないが、もしある場合は対処を考える必要がある。\n方法として、\n極端なweightがモデルの仕様の誤りによるものかどうかをチェックするために、傾向スコアモデルを再指定する\n\r傾向スコア法を変更する\n\rweight打切りを行う\n\r安定化weightを使用する。\n\r\r3については99%タイルでweightを切り捨てるという方法がある。\n4についてはweightを加重平均などで安定化する方法である。\n今回は不要だが、参考までにweightの安定化を行う。\n#重みの正規化\rpmx$psw \u0026lt;- pmx$psw/mean(pmx$psw)\r# 統合\rwith(pmx, by(psw, PMX, summary))\r## PMX: 0\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.8724 0.9464 0.9803 0.9782 1.0087 1.1163 ## ------------------------------------------------------------ ## PMX: 1\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.9079 0.9842 1.0158 1.0228 1.0559 1.1506\r安定化する前と比べてもほとんど変化はないことが分かる。\n今回は仮想データであるため、元々傾向スコアの分布が比較的均一であったため、安定化や切り捨ては不要で\nある。\n実際のデータでは極端なweightを取ることがあるため、対処が必要になることがある。\n\r両群のバランス評価\r介入群とコントロール群でバランスがとれているか確認が必要である。\nそのためにtwangパッケージを用いる。\nrequire(twang)\rbaseline.balance \u0026lt;- bal.stat(data=pmx,#データセット\rvar=covariateNames,#バランスチェックの確認に含む変数のリスト\rtreat.var=\u0026quot;treat\u0026quot;,#介入・曝露の変数\rw.all=1,#傾向スコアのweightなどがある場合、デフォルトは1 (no weighting)\rsampw=1,#サンプリングウェイト (no weighting)\rget.means=T, #平均と分散を計算するかどうか\rget.ks=F,#コルモゴロフ・スミルノフ統計量を計算するかどうか\restimand=\u0026quot;ATE\u0026quot;,#ATEとATTどちらか\rmultinom=F)#多項傾向スコアを用いるかどうか\rbaseline.balance.es \u0026lt;- baseline.balance$results\rsummary(abs(baseline.balance.es$std.eff.sz))\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.008427 0.022860 0.029534 0.035160 0.044532 0.070447\r標準化効果量は最大で0.070447とバランスはとれているようである。\n続いて傾向スコアで重みづけした後のバランス評価を行う。\npsw.balance \u0026lt;- bal.stat(data=pmx,#データセット\rvar=covariateNames,#バランスチェックの確認に含む変数のリスト\rtreat.var=\u0026quot;treat\u0026quot;,#介入・曝露の変数\rw.all=pmx$psw,#傾向スコアのweightなどがある場合\rsampw=1,#サンプリングウェイト (no weighting)\rget.means=T, #平均と分散を計算するかどうか\rget.ks=F,#コルモゴロフ・スミルノフ統計量を計算するかどうか\restimand=\u0026quot;ATE\u0026quot;,#ATEとATTどちらか\rmultinom=F)#多項傾向スコアを用いるかどうか\rpsw.balance.table \u0026lt;- psw.balance$results\rsummary(abs(psw.balance.table$std.eff.sz))\r## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 5.949e-05 9.701e-05 1.924e-04 2.899e-04 5.454e-04 5.550e-04\r標準効果量はかなり小さく、今回のデータでは重みづけする前後でもバランスはとれていた。\n\r治療効果の評価\r今回はデータ作成の都合上、簡単のために生存までの時間は無視してロジスティック回帰モデルで評価する。\nそのために変数を論理型に変更しておく。\npmx$twentyeight_day_mortality \u0026lt;- as.logical(pmx$twentyeight_day_mortality)\rpmx$PMX \u0026lt;- as.logical(pmx$PMX)\rstr(pmx$twentyeight_day_mortality)\r## logi [1:450] TRUE FALSE FALSE FALSE FALSE TRUE ...\r論理型に変換できたことを確認\nfinal.model \u0026lt;- pmx %\u0026gt;%\rglm(twentyeight_day_mortality ~ PMX, family = binomial(link = \u0026quot;logit\u0026quot;), weights = psw, data = .)\r## Warning in eval(family$initialize): non-integer #successes in a binomial glm!\rここでの警告はstack.flowを見る限り問題はなさそう。\nhttps://stackoverflow.com/questions/12953045/warning-non-integer-successes-in-a-binomial-glm-survey-packages\n二重にロバストな推定\nlibrary(lmtest)\rlibrary(sandwich)\rresult \u0026lt;- coeftest(final.model, vcov = sandwich)\rsummary(result)\r## Estimate Std. Error z value Pr(\u0026gt;|z|) ## Min. :-0.69787 Min. :0.1403 Min. :-4.9734 Min. :0.0000007 ## 1st Qu.:-0.48800 1st Qu.:0.1549 1st Qu.:-3.5517 1st Qu.:0.1188765 ## Median :-0.27813 Median :0.1694 Median :-2.1299 Median :0.2377523 ## Mean :-0.27813 Mean :0.1694 Mean :-2.1299 Mean :0.2377523 ## 3rd Qu.:-0.06826 3rd Qu.:0.1839 3rd Qu.:-0.7082 3rd Qu.:0.3566282 ## Max. : 0.14161 Max. :0.1985 Max. : 0.7136 Max. :0.4755040\rexp(result[2])\r## [1] 1.152124\rexp(-1.96*result[4])\r## [1] 0.6777543\rexp(1.96*result[4])\r## [1] 1.475461\rPMXのオッズ比は1.15 (95%CI 0.68 - 1.48)であった。\nRRに変換すると、1.068となる。\nhttps://clincalc.com/Stats/ConvertOR.aspx#1\nこれは元論文の1.09と近いが、そもそも介入と非介入の割合が50%なので、リスク比に変換するのは正しくないであろう。\n【参考文献】\rPractical Propensity Score Methods Using R SAGE Publications, Inc\n\r\r","date":1595423798,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1595423798,"objectID":"eccbf25e85b531554ddd104ff2588bdb","permalink":"/post/propensity_score/","publishdate":"2020-07-22T22:16:38+09:00","relpermalink":"/post/propensity_score/","section":"post","summary":"Rによる傾向スコアの実装について簡単に","tags":["傾向スコア"],"title":"Rによる傾向スコアの実装","type":"post"},{"authors":["Kumakt"],"categories":["R"],"content":"\rパッケージの読み込み\r\rまずパッケージを読み込む\r\r# パッケージの読み込み\rlibrary(survival)\rlibrary(magrittr)\r\rデータの確認\r\rsummary関数とstr関数を用いる。\n\r必要に応じてグラフなどを書いてデータの分布を調べる。\n\r\rhead(myeloid, n = 5)\r## id trt sex futime death txtime crtime rltime\r## 1 1 B f 235 1 NA 44 113\r## 2 2 A m 286 1 200 NA NA\r## 3 3 A f 1983 0 NA 38 NA\r## 4 4 B f 2137 0 245 25 NA\r## 5 5 B f 326 1 112 56 200\r先頭5行の表示\nsummary(myeloid)\r## id trt sex futime death ## Min. : 1.0 Length:646 f:361 Min. : 4.0 Min. :0.0000 ## 1st Qu.:162.2 Class :character m:285 1st Qu.: 286.5 1st Qu.:0.0000 ## Median :323.5 Mode :character Median : 817.0 Median :0.0000 ## Mean :323.5 Mean :1010.1 Mean :0.4954 ## 3rd Qu.:484.8 3rd Qu.:1733.2 3rd Qu.:1.0000 ## Max. :646.0 Max. :2419.0 Max. :1.0000 ## ## txtime crtime rltime ## Min. : 24.0 Min. : 21.0 Min. : 26.0 ## 1st Qu.: 105.0 1st Qu.: 32.0 1st Qu.: 181.5 ## Median : 147.0 Median : 39.0 Median : 283.0 ## Mean : 229.3 Mean : 50.1 Mean : 363.3 ## 3rd Qu.: 244.2 3rd Qu.: 57.0 3rd Qu.: 470.0 ## Max. :1526.0 Max. :554.0 Max. :1905.0 ## NA\u0026#39;s :282 NA\u0026#39;s :192 NA\u0026#39;s :420\r# データの型確認\rstr(myeloid)\r## \u0026#39;data.frame\u0026#39;: 646 obs. of 8 variables:\r## $ id : int 1 2 3 4 5 6 7 8 9 10 ...\r## $ trt : chr \u0026quot;B\u0026quot; \u0026quot;A\u0026quot; \u0026quot;A\u0026quot; \u0026quot;B\u0026quot; ...\r## $ sex : Factor w/ 2 levels \u0026quot;f\u0026quot;,\u0026quot;m\u0026quot;: 1 2 1 1 1 1 2 1 1 1 ...\r## $ futime: num 235 286 1983 2137 326 ...\r## $ death : num 1 1 0 0 1 0 1 1 0 0 ...\r## $ txtime: num NA 200 NA 245 112 102 NA 205 NA 106 ...\r## $ crtime: num 44 NA 38 25 56 NA NA 34 28 NA ...\r## $ rltime: num 113 NA NA NA 200 NA NA 382 NA NA ...\rここで使うデータは、パッケージに付属のデータ：白血病患者に対する治療のA/Bでの効果を調べるデータ\n\rid: subject identifier, 1-646,\rtrt: treatment arm A or B,\n\rsex: f=female, m=male,\n\rfutime: time to death or last follow-up,\n\rdeath: 1 if futime is a death, 0 for censoring,\n\rtxtime: time to hematropetic stem cell transplant\rcrtime: time to complete response, rltime: time to relapse of disease\r\r今回は治療A/Bと死亡までの差をみる\n欠損値が存在しているが、今回の解析には影響を与えない。\n\r生存時間解析の準備\rge.surv \u0026lt;- Surv(myeloid$futime, myeloid$death)\rhead(ge.surv, n = 10)\r## [1] 235 286 1983+ 2137+ 326 2041+ 63 446 1695+ 1669+\r+はイベント打ち切り、無印はイベントがなかったことを示す\n#myeloid %\u0026gt;% Surv(myeloid$futime, myeloid$death)\r## [1] 235 286 1983+ 2137+ 326 2041+ 63 446 1695+ 1669+ 66+ 1364+\r## [13] 17+ 209 261 2380+ 431 372 838 2086+ 1480+ 188 963 318 ## [25] 373 1657+ 213 1421+ 337 565 286 1823+ 17+ 201 321+ 529 ## [37] 266 1305 1460+ 1832 1859+ 1864+ 1880+ 368 1391+ 762 332 376+\r## [49] 1740+ 2241+ 582 284 823 2186+ 2198+ 1737+ 2315+ 2006+ 185 2367+\r## [61] 1893+ 1734+ 2042+ 2162+ 1176+ 2148+ 2247+ 1991+ 180 1956+ 1976+ 13 ## [73] 1913+ 110 116 245 2194+ 531 1782+ 548 46 2052+ 411 1034 ## [85] 293 2250+ 235 267 2136+ 1465+ 439 295 286 1251+ 1360+ 1783+\r## [97] 1866+ 892 1525+ 461 322 1323+ 651 241+ 2300+ 2192+ 191 18+\r## [109] 1621 50 15+ 27 574 917 609 1774+ 206 297 77 52 ## [121] 1429+ 278 1393+ 232 106 397 140 2038+ 1911+ 13 1990+ 424 ## [133] 2063+ 1721+ 955+ 1731+ 1499+ 281 310 1999+ 408 1361+ 337 15+\r## [145] 1530+ 234 1681+ 518 800 1806+ 1192+ 2304+ 1687+ 1785+ 1912+ 2335+\r## [157] 31+ 485 432+ 1409 1464+ 18 462 408 1423+ 1431+ 248 1459+\r## [169] 2148+ 2188+ 1725+ 218 1999+ 1254 1420+ 1521+ 1921+ 1648+ 1555+ 614 ## [181] 50 86 588+ 874 33 156 563 231 1020 1390+ 572 1877+\r## [193] 2122+ 322 511 288 368 480 2224+ 1708+ 561 1578+ 834 1583+\r## [205] 7+ 513 1426+ 2040+ 1796+ 1627+ 360 1280+ 2371+ 1479+ 260 2219+\r## [217] 20 269 381 163 1287+ 1092+ 154 771 1972+ 1658+ 2283 1827+\r## [229] 4+ 2210+ 1379 516 1007 1757+ 2134+ 99 1369+ 121 2361+ 423 ## [241] 322 1423+ 369 603 25 1809+ 131 602 692 1444+ 601+ 305 ## [253] 518 2118+ 972 524 1881+ 74 2345+ 403 14+ 2053+ 2254+ 76 ## [265] 22+ 2154+ 779 167 16+ 191 707 103 283 293 1442+ 1350+\r## [277] 1710+ 19+ 1384+ 263 1947+ 230 248 216 1717+ 1718+ 707 303 ## [289] 89 1545+ 1283 388 2023+ 1990+ 140 759 2145+ 168+ 1843+ 2188+\r## [301] 1960+ 874 34 438 396 867 1885+ 148 1522+ 2233+ 1795+ 13 ## [313] 1467+ 1682+ 2063+ 1302+ 56 1666+ 1708+ 1384+ 644 239 2095+ 2065+\r## [325] 588 432 308 1779+ 197 2183+ 1368+ 193 2239+ 1479+ 1414+ 599 ## [337] 1834+ 1290+ 1968+ 2123+ 385 698+ 2255+ 1319+ 1465+ 1552 1883+ 409 ## [349] 144 157 1370+ 193+ 128 671 670 1960+ 1320+ 679 1815+ 2149+\r## [361] 748 1901+ 2229+ 964 1379+ 146 179 6+ 1755+ 2043+ 258 460 ## [373] 575 364 2344+ 1953+ 386 1164 374 1683+ 1704+ 86+ 262 187 ## [385] 65 355 36+ 1727+ 1855+ 215 319 1861+ 21+ 497 1385+ 9 ## [397] 418 2028+ 476 1744+ 1952+ 344 464 1742+ 355 2222+ 226 356 ## [409] 1405+ 210 907 2276+ 104 565 727 385 20 333 578 1988+\r## [421] 1349+ 2007+ 255 522 539 23 1714+ 2056+ 341 258 2237+ 1102 ## [433] 1729+ 2318+ 9+ 411 59+ 805 2058+ 697 2048+ 2034+ 696 411 ## [445] 2083+ 388 342 1544+ 44 326 2200+ 28 1360+ 658 621 307 ## [457] 248 1652+ 1623+ 540 166 246 458 329 2017+ 1129 1720+ 1703+\r## [469] 167 1584+ 9+ 1021 465 1308+ 1681+ 1846+ 1241 1602+ 1813+ 1742+\r## [481] 1459+ 95 1559+ 24 465 1333+ 419 1924+ 85 1537 246 1774+\r## [493] 1999+ 2233+ 1367+ 267 1085 2052+ 742 516+ 499 1907+ 400 1792+\r## [505] 1698+ 774 833 2253+ 1383+ 1039+ 148 447 476 736 1485+ 567+\r## [517] 27 1745+ 313 1739+ 2043+ 1760+ 45 145 1989+ 242 1099+ 506 ## [529] 2044+ 1497+ 156 456 1695+ 2299+ 1281+ 1990+ 24 495 743 2419+\r## [541] 1764+ 170 1331+ 112 295 359 32 27 1374+ 120+ 365 144 ## [553] 168 1901+ 275 826 1704+ 432+ 1780+ 49+ 1313+ 24+ 2126+ 609 ## [565] 203 1245 436+ 1825+ 1915 2150+ 1710+ 2125+ 1594+ 1414+ 1455+ 1799+\r## [577] 1728+ 1688+ 1113+ 185 10+ 811 1480+ 515 122 2179+ 420 248 ## [589] 24 906+ 486 273 1220 40 443 383 829 160+ 275 400 ## [601] 768 1347+ 1374+ 375 1456+ 27 93+ 1943+ 2041+ 517 252 293 ## [613] 1417+ 752 1322+ 2070+ 16 2191+ 334 1370 2369+ 1401+ 664 259 ## [625] 2308+ 2335+ 120 2055+ 1730+ 1373+ 563 1480+ 884 1386+ 1845+ 1313+\r## [637] 410 697 253 21 22+ 237 2394+ 17+ 181 25+\r\rKaplan-Meier法\r\rノンパラメトリック法による生存時間を当てはめる関数 survfit\n\rデフォルトはカプラン・マイヤー推定法\n\r\r\r生存曲線を描く\rplot(ge.model,lty=1:2,xlab = \u0026quot;Survival time\u0026quot;, ylab = \u0026quot;Overall survival\u0026quot;, col = 1:2) %\u0026gt;% legend(locator(1),c(\u0026quot;A\u0026quot;,\u0026quot;B\u0026quot;), lty=c(1,2))\r## 実際に描くときはlegendを併記するとグラフに追記できる\rうまくlegendが追加できない。ggplot2を使って記載する方法もある。\nggplotを用いてカプランマイヤー曲線を描く。\nggplotはdata.frame型を使わなければならないので、fortifyを定義してやる必要がある。\nfortify.survfit \u0026lt;- function(survfit.data) {\rdata.frame(time = survfit.data$time,\rn.risk = survfit.data$n.risk,\rn.event = survfit.data$n.event,\rn.censor = survfit.data$n.censor,\rsurv = survfit.data$surv,\rstd.err = survfit.data$std.err,\rupper = survfit.data$upper,\rlower = survfit.data$lower,\rstrata = rep(names(survfit.data$strata), survfit.data$strata))\r}\rhead(ggplot2::fortify(ge.model))\r## time n.risk n.event n.censor surv std.err upper lower strata\r## 1 6 317 0 1 1.0000000 0.000000000 1 1.0000000 trt=A\r## 2 9 316 0 2 1.0000000 0.000000000 1 1.0000000 trt=A\r## 3 13 314 1 0 0.9968153 0.003189797 1 0.9906028 trt=A\r## 4 14 313 0 1 0.9968153 0.003189797 1 0.9906028 trt=A\r## 5 15 312 0 1 0.9968153 0.003189797 1 0.9906028 trt=A\r## 6 16 311 1 1 0.9936101 0.004532899 1 0.9848216 trt=A\rlibrary(ggplot2)\rge.model %\u0026gt;% ggplot() + geom_line(aes_string(x = \u0026#39;time\u0026#39;, y = \u0026#39;surv\u0026#39;, colour = \u0026#39;strata\u0026#39;)) + geom_ribbon(aes_string(x = \u0026#39;time\u0026#39;, ymin = \u0026#39;lower\u0026#39;, ymax = \u0026#39;upper\u0026#39;, fill = \u0026#39;strata\u0026#39;), alpha = 0.5) + ylim(0,1) +\rxlab(\u0026quot;survival time\u0026quot;) + ylab(\u0026quot;survival rate\u0026quot;) + ggtitle(\u0026quot;Kaplan-Meier曲線\u0026quot;)\r#+ scale_y_continuous(labels = scales::percent)\r打ち切りも表したいときは、\nge.censor \u0026lt;- ggplot2::fortify(ge.model) \rge.censor %\u0026gt;% ggplot() + geom_line(aes_string(x = \u0026#39;time\u0026#39;, y = \u0026#39;surv\u0026#39;, colour = \u0026#39;strata\u0026#39;)) + geom_ribbon(aes_string(x = \u0026#39;time\u0026#39;, ymin = \u0026#39;lower\u0026#39;, ymax = \u0026#39;upper\u0026#39;, fill = \u0026#39;strata\u0026#39;), alpha = 0.5) + geom_point(data = ge.censor[ge.censor$n.censor \u0026gt; 0,],\raes_string(x = \u0026#39;time\u0026#39;, y = \u0026#39;surv\u0026#39;), shape = \u0026#39;+\u0026#39;, size = 2) +\rylim(0,1) +\rxlab(\u0026quot;survival time\u0026quot;) + ylab(\u0026quot;survival rate\u0026quot;) + ggtitle(\u0026quot;Kaplan-Meier曲線\u0026quot;)\rKaplan-Meier曲線を見る限り、比例ハザード性は保たれているようである。\n\rログランク検定\rAとBによる生存曲線を比較する。\nsurvdiff(Surv(myeloid$futime, myeloid$death) ~ myeloid$trt)\r## Call:\r## survdiff(formula = Surv(myeloid$futime, myeloid$death) ~ myeloid$trt)\r## ## N Observed Expected (O-E)^2/E (O-E)^2/V\r## myeloid$trt=A 317 171 143 5.28 9.59\r## myeloid$trt=B 329 149 177 4.29 9.59\r## ## Chisq= 9.6 on 1 degrees of freedom, p= 0.002\r帰無仮説は「両群の生存曲線に差がない」である。\n今回の結果はp値=0.002であり生存曲線に差があるという結果になる。\nただし、ログランク検定では患者の背景因子などは調整されていない。\n\rCox比例ハザード\r先に描いた生存曲線から比例ハザード性は保たれていると考えられる。\n今回は性別くらいしか調整する変数はないが、それを加えて解析を行う。\nmodel.cox \u0026lt;- coxph(Surv(futime, death) ~ trt + sex, data = myeloid)\rsummary(model.cox)\r## Call:\r## coxph(formula = Surv(futime, death) ~ trt + sex, data = myeloid)\r## ## n= 646, number of events= 320 ## ## coef exp(coef) se(coef) z Pr(\u0026gt;|z|) ## trtB -0.3582 0.6989 0.1129 -3.174 0.00151 **\r## sexm 0.1150 1.1219 0.1128 1.020 0.30782 ## ---\r## Signif. codes: 0 \u0026#39;***\u0026#39; 0.001 \u0026#39;**\u0026#39; 0.01 \u0026#39;*\u0026#39; 0.05 \u0026#39;.\u0026#39; 0.1 \u0026#39; \u0026#39; 1\r## ## exp(coef) exp(-coef) lower .95 upper .95\r## trtB 0.6989 1.4307 0.5602 0.872\r## sexm 1.1219 0.8913 0.8994 1.399\r## ## Concordance= 0.549 (se = 0.016 )\r## Likelihood ratio test= 10.56 on 2 df, p=0.005\r## Wald test = 10.53 on 2 df, p=0.005\r## Score (logrank) test = 10.62 on 2 df, p=0.005\r性別による生存率に違いはない。\n治療BについてはHR 0.699 (95%CI 0.560 - 0.872)という結果で、治療B群の方が死亡率を有意に低下させる。\n【参考文献】\nggplotでカプランマイヤー曲線を描く際に、こちらのサイトを参考にさせていただいた。\nhttp://sinhrks.hatenablog.com/entry/2014/10/04/195825\n\r","date":1594818998,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1594818998,"objectID":"56847cb99604e69e8f873c25d61b72a3","permalink":"/post/survival/","publishdate":"2020-07-15T22:16:38+09:00","relpermalink":"/post/survival/","section":"post","summary":"Rによる生存時間解析の実装について簡単に","tags":["生存時間解析"],"title":"Rによる生存時間解析の実装","type":"post"},{"authors":["Kumakt"],"categories":["R"],"content":"\r一般事項\rある変数と別の変数の関係を数式で表したものを回帰モデルと呼ぶ。\n両者の関係が線形で与えられると仮定したものが線形回帰モデルである。\n式で表すと、\n\\[y = \\beta_0 + \\beta_1x\\]\nである。\n実際のデータでこのモデルを考える際には、観測値と仮定したモデルとの間には誤差が生じるため\n\\(y_i = \\beta_0 + \\beta_1x_i + \\epsilon_i\\)となる。\n\\(i = 1,2,3...n\\)である。\nこのモデルがデータに良くあてはまるためには誤差\\(\\epsilon_i\\)の総和が小さくなるようなパラメータを求めればよい。\nただし、線形回帰モデルと観測値の差は負の値になることもあるため、そのまま総和をとるわけでなく、2乗して\n総和をとる。これが最小二乗法である。\n\r架空データの作成\rここでは収縮期血圧と年齢の関係をみる単純なモデルを考える。\n# 乱数発生で毎回同じ値になるようにseedを設定する\rset.seed(123)\r# ある程度線形モデルにフィットするようにするため相関を指定\rrho \u0026lt;- 0.65\r# 正規分布に従う乱数の設定(サンプルサイズ、平均、標準偏差は自由に設定可能)\ry \u0026lt;- rnorm(n = 50, mean = 140, sd = 10)\rx \u0026lt;- rnorm(n = 50, mean = 65, sd = 10)\rz \u0026lt;- rnorm(n = 50, mean = 0, sd = 10)\r# 相関をもった現実味のある値にするため、それぞれbpとageに格納\r# sqrtは平方根という意味\rbp \u0026lt;- sqrt(rho)*z + sqrt(1 - rho)*y + 30\rage \u0026lt;- sqrt(rho)*z + sqrt(1 - rho)*x + 30\r# データフレームという形式でbpとageをdataというオブジェクトに格納\rdata \u0026lt;- data.frame(age,bp)\r# 列に名前を付ける\rname \u0026lt;- c(\u0026quot;age\u0026quot;,\u0026quot;SBP\u0026quot;)\rcolnames(data) \u0026lt;- name\r# これで収縮期血圧と年齢の関係を示すデータが完成\r\rデータの確認を行う\r次は実際にどんなデータであるか確認を行う。\n# 外れ値や欠損値など\r# summaryはデータの平均などを示す関数、headは先頭から指定の行を表示\rsummary(data)\r## age SBP ## Min. :47.15 Min. : 91.89 ## 1st Qu.:62.03 1st Qu.:103.05 ## Median :66.83 Median :111.74 ## Mean :67.27 Mean :110.98 ## 3rd Qu.:72.59 3rd Qu.:118.22 ## Max. :83.99 Max. :134.37\rhead(data, n = 3)\r## age SBP\r## 1 64.22569 103.7818\r## 2 70.35670 113.5344\r## 3 66.21200 120.0577\r# strは各変数の形式を示す、実際の解析ではどの形式なのか数値型なのか因子型なのかといった形の確認が重要\rstr(data)\r## \u0026#39;data.frame\u0026#39;: 50 obs. of 2 variables:\r## $ age: num 64.2 70.4 66.2 73.7 59.4 ...\r## $ SBP: num 104 114 120 110 106 ...\r\r図示\rデータの分布を散布図を描いて確認を行う。\nplot関数でも描くことができるが今回はggplot2を用いる。\nlibrary(ggplot2)\rggplot(data = data,\raes(x = age, y = SBP)) +\rgeom_point() +\rtheme_bw()\r散布図をみる限り、年齢と収縮期血圧には線形の関係がありそうに見える。\n\rモデルを作成する\rここでは２変量の単純なモデルを作成する。\nlm関数は線形回帰モデルを作成する。\nmodel \u0026lt;- lm(data = data, bp ~ age)\rsummary(model)\r## ## Call:\r## lm(formula = bp ~ age, data = data)\r## ## Residuals:\r## Min 1Q Median 3Q Max ## -14.833 -4.858 0.504 6.091 13.138 ## ## Coefficients:\r## Estimate Std. Error t value Pr(\u0026gt;|t|) ## (Intercept) 62.2829 8.1559 7.637 7.83e-10 ***\r## age 0.7239 0.1202 6.022 2.32e-07 ***\r## ---\r## Signif. codes: 0 \u0026#39;***\u0026#39; 0.001 \u0026#39;**\u0026#39; 0.01 \u0026#39;*\u0026#39; 0.05 \u0026#39;.\u0026#39; 0.1 \u0026#39; \u0026#39; 1\r## ## Residual standard error: 7.478 on 48 degrees of freedom\r## Multiple R-squared: 0.4304, Adjusted R-squared: 0.4185 ## F-statistic: 36.26 on 1 and 48 DF, p-value: 2.322e-07\rResidualsは残差のことで誤差の予測値とみなすことができる。\nCoefficientsは係数の結果である。切片と係数に該当する。\n今回のモデルは、\n\\(y_i = 62.283 + 0.724x_i\\)と表すことができる。\n\rモデルの評価\rlibrary(ggfortify)\rautoplot(model, smooth.colour = NA)\r## Warning: `arrange_()` is deprecated as of dplyr 0.7.0.\r## Please use `arrange()` instead.\r## See vignette(\u0026#39;programming\u0026#39;) for more help\r## This warning is displayed once every 8 hours.\r## Call `lifecycle::last_warnings()` to see where this warning was generated.\r## Warning: Removed 50 row(s) containing missing values (geom_path).\r## Warning: Removed 50 row(s) containing missing values (geom_path).\r## Warning: Removed 50 row(s) containing missing values (geom_path).\r右上のQQplotはおおむね問題なさそうであり、残差は正規分布していそうである。\nまた左下の図をみても分散に明らかな偏りはなさそうであり、等分散性が保たれていると思われる。\r(ばらつきは比較的ありそうである)\nまた先のsummaryの結果をみるとR-squaredという項目があるが、これが決定係数である。\n予測値を\\(\\hat{y_i}\\)、平均値を\\(\\bar{y}\\)と表すと、\n\\[R^2 =1 - \\frac{\\sum_{i=1}^n(y_i - \\hat{y_i})^2}{\\sum_{i=1}^n(y_i - \\bar{y})^2}\\]\nとなる。決定係数は1に近いほど当てはまりがよいのであるから、この分数の部分が0に近ければよい。\n分子が小さくなる、つまり予測値と観測値が近いほど0に近づく、決定係数が1に近づくということになる。\n\r最後に散布図に線形回帰直線をひいてみる\rggplot(data = data,\raes(x = age, y = SBP)) +\rgeom_point() +\rstat_smooth(method = \u0026quot;lm\u0026quot;, se = TRUE, size = 1) +\rtheme_bw()\r## `geom_smooth()` using formula \u0026#39;y ~ x\u0026#39;\r\r結果\r今回の年齢と収縮期血圧の関係では、年齢が高くなるほど線形に収縮期血圧が高くなると予想し、モデルを作成した。\nモデルの前提は満たされているようであり、係数も有意な結果であった。\nしかし決定係数は修正\\(R^2\\)および\\(R^2\\)ともに良いとは言えず、収縮期血圧について年齢だけのモデルでは、\r十分に説明できていないことになる。\n実際の臨床でも血圧を予測するうえで他に、家族歴など様々な要因が重要であることは当然であり、年齢だけで\r十分に説明できないということは妥当であるといえる。\n\r","date":1594735057,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1594735057,"objectID":"7437ae4ba188ef9b40a9b05be7d80bd0","permalink":"/post/linear/","publishdate":"2020-07-14T22:57:37+09:00","relpermalink":"/post/linear/","section":"post","summary":"Rによる線形回帰モデルの実装","tags":["regression"],"title":"線形回帰モデルの基礎","type":"post"},{"authors":["Kumakt"],"categories":["R"],"content":"\rパッケージの読み込み\r今回はパッケージに付属のデータを用いる。\n# 必要なパッケージの読み込み\rlibrary(ggplot2)\rlibrary(dplyr)\rlibrary(ggfortify)\rlibrary(DAAG)\r\rデータの確認\r# データの確認\rdata(\u0026quot;head.injury\u0026quot;)\rsummary(head.injury)\r## age.65 amnesia.before basal.skull.fracture GCS.decrease ## Min. :0.000 Min. :0.0000 Min. :0.00000 Min. :0.00000 ## 1st Qu.:0.000 1st Qu.:0.0000 1st Qu.:0.00000 1st Qu.:0.00000 ## Median :0.000 Median :0.0000 Median :0.00000 Median :0.00000 ## Mean :0.116 Mean :0.2047 Mean :0.06985 Mean :0.02275 ## 3rd Qu.:0.000 3rd Qu.:0.0000 3rd Qu.:0.00000 3rd Qu.:0.00000 ## Max. :1.000 Max. :1.0000 Max. :1.00000 Max. :1.00000 ## GCS.13 GCS.15.2hours high.risk loss.of.consciousness\r## Min. :0.00000 Min. :0.0000 Min. :0.0000 Min. :0.0000 ## 1st Qu.:0.00000 1st Qu.:0.0000 1st Qu.:0.0000 1st Qu.:0.0000 ## Median :0.00000 Median :0.0000 Median :0.0000 Median :0.0000 ## Mean :0.03749 Mean :0.1266 Mean :0.2429 Mean :0.1118 ## 3rd Qu.:0.00000 3rd Qu.:0.0000 3rd Qu.:0.0000 3rd Qu.:0.0000 ## Max. :1.00000 Max. :1.0000 Max. :1.0000 Max. :1.0000 ## open.skull.fracture vomiting clinically.important.brain.injury\r## Min. :0.00000 Min. :0.00000 Min. :0.0000 ## 1st Qu.:0.00000 1st Qu.:0.00000 1st Qu.:0.0000 ## Median :0.00000 Median :0.00000 Median :0.0000 ## Mean :0.03685 Mean :0.09869 Mean :0.0801 ## 3rd Qu.:0.00000 3rd Qu.:0.00000 3rd Qu.:0.0000 ## Max. :1.00000 Max. :1.00000 Max. :1.0000\rstr(head.injury)\r## \u0026#39;data.frame\u0026#39;: 3121 obs. of 11 variables:\r## $ age.65 : num 0 0 0 0 0 0 0 0 1 0 ...\r## $ amnesia.before : num 1 0 0 0 0 1 0 0 0 1 ...\r## $ basal.skull.fracture : num 0 0 0 0 0 0 0 0 0 0 ...\r## $ GCS.decrease : num 0 0 0 0 0 0 0 0 0 0 ...\r## $ GCS.13 : num 0 0 0 0 0 0 0 0 0 0 ...\r## $ GCS.15.2hours : num 0 0 0 1 1 0 0 0 0 0 ...\r## $ high.risk : num 0 0 0 0 0 0 0 0 1 0 ...\r## $ loss.of.consciousness : num 0 0 0 0 0 0 0 0 0 0 ...\r## $ open.skull.fracture : num 0 0 0 0 0 0 0 0 0 0 ...\r## $ vomiting : num 0 0 0 0 0 0 0 0 0 0 ...\r## $ clinically.important.brain.injury: num 0 0 0 0 0 0 0 0 0 0 ...\r## 分布や欠損、各変数の型を確認しておく\r\rDAAGパッケージに付属のデータセット\r\r軽度の頭部外傷のデータセット\n\r3121名、11列をもつ。\r\r以下、変数名\n\rage.65：0 = under 65, 1 = over 65\n\ramnesia.before : 受傷前についての健忘(記憶があるか)\ramnesia before impact (less than 30 minutes = 0, more than 30 minutes =1).\n\rbasal.skull.fracture : 頭蓋亭骨折(0 = no fracture, 1 = fracture).\n\rGCS.decrease : 意識レベル低下\rGlasgow Coma Scale decrease (0 = no deterioration, 1 = deterioration).\n\rGCS.13 : 最初の意識レベル initial Glasgow Coma Scale (0 = not ‘13’, 1 = ‘13’).\n\rGCS.15.2hours : けがをして2時間後の意識レベル\rGlasgow Coma Scale after 2 hours (0 = not ‘15’, 1 = ‘15’).\n\rhigh.risk : 神経学的な介入が必要かどうか医師による判断\rassessed by clinician as high risk for neurological intervention (0 = not high risk, 1 = high risk).\n\rloss.of.consciousness : 意識消失の有無(0 = conscious, 1 = loss of consciousness).\n\ropen.skull.fracture : 開放性頭蓋骨骨折(0 = no fracture, 1 = fracture)\n\rvomiting : 嘔吐の有無(0 = no vomiting, 1 = vomiting)\n\rclinically.important.brain.injury : CTで臨床的に重要な急性期の脳所見があるかどうか\rany acute brain finding revealed on CT (0 = not present, 1 = present).\n\r\r\nStiell, I.G., Wells, G.A., Vandemheen, K., Clement, C., Lesiuk, H., Laupacis, A., McKnight, R.D., Verbee, R., Brison, R., Cass, D., Eisenhauer, M., Greenberg, G.H., and Worthington, J. (2001) The Canadian CT Head Rule for Patients with Minor Head Injury, The Lancet. 357: 1391-1396.\n＜今回のモデル＞\n目的変数：CT所見に何か異常があるか\n興味のある説明変数：健忘の有無\nとして多変量ロジスティック回帰モデルを作成する。\n\rモデルの作成\r# モデルの作成\r# glm関数は一般化線形モデルに用いる関数で、familyで自分が使いたい分布を指定する。\r#今回は二値変数がアウトカムなので二項分布に従い、リンク関数はlogitなので以下のようになる\rmodel \u0026lt;- glm(clinically.important.brain.injury ~ amnesia.before + age.65 + GCS.decrease + GCS.15.2hours + GCS.13 + high.risk + loss.of.consciousness + vomiting,family = binomial(link = \u0026quot;logit\u0026quot;),data = head.injury)\r\r結果の確認\r# モデルの結果確認\rsummary(model)\r## ## Call:\r## glm(formula = clinically.important.brain.injury ~ amnesia.before + ## age.65 + GCS.decrease + GCS.15.2hours + GCS.13 + high.risk + ## loss.of.consciousness + vomiting, family = binomial(link = \u0026quot;logit\u0026quot;), ## data = head.injury)\r## ## Deviance Residuals: ## Min 1Q Median 3Q Max ## -2.6149 -0.3355 -0.2339 -0.1734 2.9001 ## ## Coefficients:\r## Estimate Std. Error z value Pr(\u0026gt;|z|) ## (Intercept) -4.1904 0.1485 -28.211 \u0026lt; 2e-16 ***\r## amnesia.before 0.6055 0.1656 3.656 0.000256 ***\r## age.65 1.3412 0.1761 7.617 2.60e-14 ***\r## GCS.decrease 0.3901 0.3573 1.092 0.274954 ## GCS.15.2hours 1.9435 0.1598 12.164 \u0026lt; 2e-16 ***\r## GCS.13 1.2985 0.2663 4.876 1.09e-06 ***\r## high.risk 1.1237 0.1527 7.360 1.84e-13 ***\r## loss.of.consciousness 0.8733 0.1926 4.534 5.78e-06 ***\r## vomiting 1.2541 0.1865 6.724 1.77e-11 ***\r## ---\r## Signif. codes: 0 \u0026#39;***\u0026#39; 0.001 \u0026#39;**\u0026#39; 0.01 \u0026#39;*\u0026#39; 0.05 \u0026#39;.\u0026#39; 0.1 \u0026#39; \u0026#39; 1\r## ## (Dispersion parameter for binomial family taken to be 1)\r## ## Null deviance: 1741.6 on 3120 degrees of freedom\r## Residual deviance: 1287.0 on 3112 degrees of freedom\r## AIC: 1305\r## ## Number of Fisher Scoring iterations: 6\r各変数の係数を確認する。\n値をオッズ比へ変換する。\n# オッズ比と95%信頼区間の確認\rresult_odds \u0026lt;- as.data.frame(cbind(exp(summary(model)$coefficient[,1]),exp(confint(model))\r,summary(model)$coefficient[,4]))\r## Waiting for profiling to be done...\r# result_oddsというデータフレームの列名を名付ける\rnames(result_odds) \u0026lt;- c(\u0026quot;Odds ratio\u0026quot;,\u0026quot;lower 95%CI\u0026quot;,\u0026quot;upper 95%CI\u0026quot;,\u0026quot;P value\u0026quot;)\r# 小数点２桁で結果を表示\rround(result_odds,2)\r## Odds ratio lower 95%CI upper 95%CI P value\r## (Intercept) 0.02 0.01 0.02 0.00\r## amnesia.before 1.83 1.32 2.53 0.00\r## age.65 3.82 2.70 5.39 0.00\r## GCS.decrease 1.48 0.71 2.91 0.27\r## GCS.15.2hours 6.98 5.10 9.56 0.00\r## GCS.13 3.66 2.15 6.12 0.00\r## high.risk 3.08 2.28 4.15 0.00\r## loss.of.consciousness 2.39 1.63 3.47 0.00\r## vomiting 3.50 2.42 5.03 0.00\r\rモデルの評価\rlibrary(pROC)\r## Type \u0026#39;citation(\u0026quot;pROC\u0026quot;)\u0026#39; for a citation.\r## ## 次のパッケージを付け加えます: \u0026#39;pROC\u0026#39;\r## 以下のオブジェクトは \u0026#39;package:stats\u0026#39; からマスクされています: ## ## cov, smooth, var\rROC \u0026lt;- roc(response=head.injury$clinically.important.brain.injury, predictor=model$fitted.values)\r## Setting levels: control = 0, case = 1\r## Setting direction: controls \u0026lt; cases\rROC\r## ## Call:\r## roc.default(response = head.injury$clinically.important.brain.injury, predictor = model$fitted.values)\r## ## Data: model$fitted.values in 2871 controls (head.injury$clinically.important.brain.injury 0) \u0026lt; 250 cases (head.injury$clinically.important.brain.injury 1).\r## Area under the curve: 0.8387\rplot(ROC)\rROC(C統計量)は0.837くらいで今回のモデルの当てはまりはよさそうである。\n「怪我の前の記憶喪失(健忘)」と「CT所見に何かしら異常が見つかるか」の関係をみることが今回の目的であり、\n最終結果はオッズ比 1.83, 95%CI 1.32 - 2.53となり、受傷時の健忘はCTの異常所見の発見に影響があると言える。\n\r","date":1594734364,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1594734364,"objectID":"4e4a31b9d2fb4111d929595b9d16341a","permalink":"/post/logi/","publishdate":"2020-07-14T22:46:04+09:00","relpermalink":"/post/logi/","section":"post","summary":"Logistic回帰の実装について簡単に","tags":["GLM"],"title":"Logistic回帰の実装","type":"post"},{"authors":["Kumakt"],"categories":["R"],"content":"\r一般事項\rRにはグラフを書く上でおもに２つの方法がある。\nデフォルトのgraphicsで扱うplot関数などとggplot2パッケージによる方法である。\nここでは医学系でよく扱うグラフをggplot2を実装する。\n\rデータの準備\rあるA市とB市で収縮期血圧を調査した設定で架空データを作成する。\nset.seed(125) # 乱数の固定のシード\ra \u0026lt;- rnorm(n = 100, mean = 140, sd = 10)\rb \u0026lt;- rnorm(n = 100, mean = 60, sd = 5 )\rc \u0026lt;- rep(c(\u0026quot;A_city\u0026quot;,\u0026quot;B_city\u0026quot;),50)\rd \u0026lt;- rbinom(n = 100, size = 1, prob = 0.6) # ここでは男性の割合を0.6として二項分布によるランダム値の作成\rstudy \u0026lt;- data.frame(a,b,c,d)\rname \u0026lt;- c(\u0026quot;SBP\u0026quot;, \u0026quot;Age\u0026quot;, \u0026quot;City\u0026quot;, \u0026quot;Sex\u0026quot;) colnames(study) \u0026lt;- name\r# 性別は二値なのでデータ型を変換する\rstudy$Sex \u0026lt;- as.factor(study$Sex)\rstudy$Sex \u0026lt;- factor(study$Sex,levels = c(1,0),\rlabels = c(\u0026quot;Male\u0026quot;,\u0026quot;Female\u0026quot;))\r\rデータの確認\rsummary(study)\r## SBP Age City Sex ## Min. :103.9 Min. :46.80 A_city:50 Male :63 ## 1st Qu.:134.6 1st Qu.:56.90 B_city:50 Female:37 ## Median :141.7 Median :59.93 ## Mean :141.0 Mean :60.09 ## 3rd Qu.:147.9 3rd Qu.:63.14 ## Max. :164.0 Max. :72.41\r\r散布図\rggplotでは要素を追記していく形が基本となる。\n散布図で連続変数同士の関係をみる。\n例えば年齢と収縮期血圧の関係を見たい場合\nlibrary(ggplot2)\rggplot(data = study, aes(x = Age, y = SBP, colour = City)) + # ここがベースで、使用するデータ、軸、およびcolourを指定することでカテゴリーごとに色分けできる\rgeom_point(size = 4) + # 散布図にするという指定\rxlab(\u0026quot;Age\u0026quot;) + # x軸ラベルの命名\rylab(\u0026quot;SBP\u0026quot;) + # y軸ラベルの命名\rggtitle(\u0026quot;SBP調査\u0026quot;) + # グラフタイトルの命名\rtheme_bw() \rA市もB市も同じくらいばらついていそうである。\n\r箱ひげ図\r離散型の変数と連続型の変数の関係をみるために使う。\n箱ひげ図により統計量(平均値、標準偏差)も一緒に図示できる。\nggplot(data = study, aes(x = City, y = SBP, colour = City)) +\rgeom_boxplot() + # ここがboxplotに変わっただけ\rgeom_jitter() + # 各点のばらつきを追加する\r# geom_point(size = 3, alpha = 0.5) +\rxlab(\u0026quot;Age\u0026quot;) + ylab(\u0026quot;SBP\u0026quot;) + ggtitle(\u0026quot;SBP調査\u0026quot;) + theme_bw()\r\rバイオリンプロット\rバイオリンプロットによりデータの分布の密度も可視化することができる。\n# バイオリンプロットも描くことができる\rggplot(data = study, aes(x = City, y = SBP, colour = City)) +\rgeom_violin() +\rxlab(\u0026quot;Age\u0026quot;) + ylab(\u0026quot;SBP\u0026quot;) + ggtitle(\u0026quot;SBP調査\u0026quot;) + theme_bw()\r\rヒストグラム\r連続変数などの分布をみる。\nここでは両方の都市での年齢の分布を示している。\n# ヒストグラム\rggplot(data = study, aes(x = Age)) +\rgeom_histogram(binwidth = 2) + # ヒストグラム描きます、階級値は2にしますという宣言\rfacet_wrap(~City) # 群別の図を書くことができる\r\r棒グラフ\r今回のデータでは必要性が乏しいが\nggplot(data = study, aes(x = City, y = SBP, fill = Sex)) +\rgeom_bar(stat = \u0026quot;identity\u0026quot;, position = \u0026quot;dodge\u0026quot;) +\rxlab(\u0026quot;Sex\u0026quot;) +\rylab(\u0026quot;SBP\u0026quot;)\r\r","date":1594692794,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1594692794,"objectID":"10065deaa3098b0da91b78b48d0efc71","permalink":"/post/2015-07-23-r-rmarkdown/","publishdate":"2020-07-13T21:13:14-05:00","relpermalink":"/post/2015-07-23-r-rmarkdown/","section":"post","summary":"一般事項 Rにはグラフを書く上でおもに２つの方法がある。 デフォルトのgraphicsで扱うplot関数などとggplot2パッケージによる方法である。 ここでは医学","tags":["R Markdown","ggplot","regression"],"title":"Rによるグラフ基礎","type":"post"},{"authors":["Kumakt"],"categories":[],"content":"from IPython.core.display import Image Image('https://www.python.org/static/community_logos/python-logo-master-v3-TM-flattened.png')  print(\u0026quot;Welcome to Academic!\u0026quot;)  Welcome to Academic!  Install Python and JupyterLab  Install Anaconda which includes Python 3 and JupyterLab.\nAlternatively, install JupyterLab with pip3 install jupyterlab.\nCreate or upload a Jupyter notebook Run the following commands in your Terminal, substituting \u0026lt;MY-WEBSITE-FOLDER\u0026gt; and \u0026lt;SHORT-POST-TITLE\u0026gt; with the file path to your Academic website folder and a short title for your blog post (use hyphens instead of spaces), respectively:\nmkdir -p \u0026lt;MY-WEBSITE-FOLDER\u0026gt;/content/post/\u0026lt;SHORT-POST-TITLE\u0026gt;/ cd \u0026lt;MY-WEBSITE-FOLDER\u0026gt;/content/post/\u0026lt;SHORT-POST-TITLE\u0026gt;/ jupyter lab index.ipynb  The jupyter command above will launch the JupyterLab editor, allowing us to add Academic metadata and write the content.\nEdit your post metadata The first cell of your Jupter notebook will contain your post metadata ( front matter).\nIn Jupter, choose Markdown as the type of the first cell and wrap your Academic metadata in three dashes, indicating that it is YAML front matter:\n--- title: My post's title date: 2019-09-01 # Put any other Academic metadata here... ---  Edit the metadata of your post, using the documentation as a guide to the available options.\nTo set a featured image, place an image named featured into your post\u0026rsquo;s folder.\nFor other tips, such as using math, see the guide on writing content with Academic.\nConvert notebook to Markdown jupyter nbconvert index.ipynb --to markdown --NbConvertApp.output_files_dir=.  Example This post was created with Jupyter. The orginal files can be found at https://github.com/gcushen/hugo-academic/tree/master/exampleSite/content/post/jupyter\n","date":1549324800,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1567641600,"objectID":"6e929dc84ed3ef80467b02e64cd2ed64","permalink":"/post/jupyter/","publishdate":"2019-02-05T00:00:00Z","relpermalink":"/post/jupyter/","section":"post","summary":"Learn how to blog in Academic using Jupyter notebooks","tags":[],"title":"デフォルトのまま(Display Jupyter Notebooks with Academic)","type":"post"}]