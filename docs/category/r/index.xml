<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>R | Kumakt Memorandum</title>
    <link>/category/r/</link>
      <atom:link href="/category/r/index.xml" rel="self" type="application/rss+xml" />
    <description>R</description>
    <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator><language>en-us</language><lastBuildDate>Sat, 25 Jul 2020 18:40:12 +0900</lastBuildDate>
    <image>
      <url>/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_2.png</url>
      <title>R</title>
      <link>/category/r/</link>
    </image>
    
    <item>
      <title>Rによるマルチレベル分析の実装</title>
      <link>/post/multilevel/</link>
      <pubDate>Sat, 25 Jul 2020 18:40:12 +0900</pubDate>
      <guid>/post/multilevel/</guid>
      <description>


&lt;div id=&#34;サンプルデータを作成する&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;サンプルデータを作成する&lt;/h3&gt;
&lt;p&gt;以前の「Rによる傾向スコアの実装」で使用したデータと同じ仮想データを用いる。&lt;/p&gt;
&lt;p&gt;適当なデータがないため、仮想データを作成する。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Effect of Targeted Polymyxin B Hemoperfusion on 28-Day Mortality in Patients With Septic Shock and Elevated Endotoxin Level&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The EUPHRATES Randomized Clinical Trialより&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;元ネタは敗血症性ショックに対するエンドトキシン吸着療法の多施設共同RCT(60施設)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;PMX療法(透析)対シャム療法(偽透析：透析している振り)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;サンプル数:450名のRCT&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Age, Sex, 平均血圧(Arterial pressure mean:MAP)、重症度スコア(APACHEⅡ)、人工呼吸器の有無(Mechanical&lt;br /&gt;
ventilation)、菌血症の有無(Bacteremia)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;介入:エンドトキシン吸着療法(PMX)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;アウトカム:28日後死亡(twentyeight_day_mortality)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;今回は多施設観察研究と想定し施設数も作成して、10施設とする&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;JAMA&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://jamanetwork.com/journals/jama/fullarticle/2706139&#34; class=&#34;uri&#34;&gt;https://jamanetwork.com/journals/jama/fullarticle/2706139&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;パッケージの読み込み&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;パッケージの読み込み&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(dplyr)
# パイプを使うため
library(magrittr)
# シミュレーションデータを作るため
library(simstudy)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;仮想データの実装&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;仮想データの実装&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;set.seed(123) # seedを設定することで必ず同じデータが毎回できるので再現性の固定
# まず施設IDの作成
b &amp;lt;- defData(varname = &amp;quot;institution_id&amp;quot;, dist = &amp;quot;noZeroPoisson&amp;quot;, formula = 3)
c &amp;lt;- genData(450, b)

# 各変数の作成
a &amp;lt;- data.frame(rnorm(450,59,8),rbinom(450,1,prob=0.6),rnorm(450,72,5),rnorm(450,28,5),rbinom(450,1,0.94)
               ,rbinom(450,1,0.30),rbinom(450,1,0.5),rbinom(450,1,0.34))

colnames(a) &amp;lt;- c(&amp;#39;Age&amp;#39;,&amp;#39;Sex&amp;#39;,&amp;#39;MAP&amp;#39;,&amp;#39;APACHEⅡ&amp;#39;,&amp;#39;Mechanical_ventilation&amp;#39;,&amp;#39;Bacteremia&amp;#39;,&amp;#39;PMX&amp;#39;,&amp;#39;twentyeight_day_mortality&amp;#39;)
# 列の名前を付ける 
# sex 1=male, Mechanical_ventilation yes=1, Bacteremia yes=1, PMX yes=1, 28day_mortality yes=1 &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;両者を結合する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;pmx &amp;lt;- cbind.data.frame(c,a)

pmx &amp;lt;- as.data.frame(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;作成したデータの確認&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;作成したデータの確認&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##        id        institution_id        Age             Sex        
##  Min.   :  1.0   Min.   : 1.000   Min.   :36.52   Min.   :0.0000  
##  1st Qu.:113.2   1st Qu.: 2.000   1st Qu.:54.19   1st Qu.:0.0000  
##  Median :225.5   Median : 3.000   Median :59.33   Median :1.0000  
##  Mean   :225.5   Mean   : 3.142   Mean   :59.11   Mean   :0.5822  
##  3rd Qu.:337.8   3rd Qu.: 4.000   3rd Qu.:64.59   3rd Qu.:1.0000  
##  Max.   :450.0   Max.   :10.000   Max.   :79.57   Max.   :1.0000  
##       MAP           APACHEⅡ      Mechanical_ventilation   Bacteremia    
##  Min.   :59.25   Min.   :12.76   Min.   :0.0000         Min.   :0.0000  
##  1st Qu.:68.47   1st Qu.:25.05   1st Qu.:1.0000         1st Qu.:0.0000  
##  Median :71.81   Median :28.54   Median :1.0000         Median :0.0000  
##  Mean   :72.00   Mean   :28.30   Mean   :0.9267         Mean   :0.2689  
##  3rd Qu.:75.03   3rd Qu.:31.90   3rd Qu.:1.0000         3rd Qu.:1.0000  
##  Max.   :88.95   Max.   :44.45   Max.   :1.0000         Max.   :1.0000  
##       PMX         twentyeight_day_mortality
##  Min.   :0.0000   Min.   :0.0000           
##  1st Qu.:0.0000   1st Qu.:0.0000           
##  Median :0.0000   Median :0.0000           
##  Mean   :0.4889   Mean   :0.3467           
##  3rd Qu.:1.0000   3rd Qu.:1.0000           
##  Max.   :1.0000   Max.   :1.0000&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;str(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    450 obs. of  10 variables:
##  $ id                       : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ institution_id           : num  2 4 3 5 6 1 3 5 3 3 ...
##  $ Age                      : num  59.5 53.4 53.3 66.1 50.9 ...
##  $ Sex                      : int  1 1 1 1 1 1 1 0 1 1 ...
##  $ MAP                      : num  66.9 68 73.5 80.2 77.4 ...
##  $ APACHEⅡ                  : num  27.3 20.8 24 32.4 32.5 ...
##  $ Mechanical_ventilation   : int  1 1 1 1 1 1 1 1 0 1 ...
##  $ Bacteremia               : int  0 0 0 0 0 1 1 0 0 0 ...
##  $ PMX                      : int  0 0 0 1 0 0 0 0 1 1 ...
##  $ twentyeight_day_mortality: int  1 0 0 0 0 1 0 0 1 0 ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;おおむね狙い通りのデータになっていることが分かる。&lt;/p&gt;
&lt;p&gt;今回は２つの解析を行う。&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;p&gt;マルチレベルロジスティック回帰モデルを実装する。&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;前回と違い施設というクラスターを含めて傾向スコアを用いて解析を実装する。&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;まずは1のマルチレベルロジスティック回帰について実装する。&lt;/p&gt;
&lt;p&gt;モデルを２つ作成する。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;モデル1:クラスター効果を無視した多変量ロジスティック回帰&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;モデル2:クラスター効果を加えたマルチレベルロジスティック回帰&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div id=&#34;モデル1-多変量ロジスティック回帰&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデル1 多変量ロジスティック回帰&lt;/h3&gt;
&lt;p&gt;最初に通常のロジスティック回帰を行う。&lt;/p&gt;
&lt;p&gt;このモデルではクラスター効果を無視してモデルを作る。&lt;/p&gt;
&lt;p&gt;つまり結果には施設間の差は影響しないという仮定である。&lt;/p&gt;
&lt;p&gt;そのため個人レベルでの変数のみが影響するとしてモデルを作成する。&lt;/p&gt;
&lt;p&gt;被検者iの死亡する確率を&lt;span class=&#34;math inline&#34;&gt;\(p_i\)&lt;/span&gt;とすると、(すなわち死亡という場合の条件付き確率)&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(logit(p_i) = log odds = log(\frac{p_i}{1-p_i}) = M + e_i\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;と表すことができる。&lt;/p&gt;
&lt;p&gt;ここで、Mはロジスティック尺度で表された集団全体の平均確率、&lt;span class=&#34;math inline&#34;&gt;\(e_i\)&lt;/span&gt;はiの残差である。&lt;/p&gt;
&lt;p&gt;モデル1では各個人レベルの変数が死亡する確率に影響を与えていると考える。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(logit(p_i) = M + \beta_1*PMX_i + \beta_2*Age_i + \beta_3*Sex_i + \beta_4*APACH_i + \beta_5*Ven_i + e_i\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;として表すことができる。&lt;/p&gt;
&lt;div id=&#34;共変量の設定&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;共変量の設定&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;covariateName_nc &amp;lt;- c(
  &amp;quot;PMX&amp;quot;,&amp;quot;Age&amp;quot;,&amp;quot;Sex&amp;quot;,&amp;quot;MAP&amp;quot;, &amp;quot;APACHEⅡ&amp;quot;, &amp;quot;Mechanical_ventilation&amp;quot;
  )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;式の作成&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;式の作成&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;nc.formula &amp;lt;- paste(covariateName_nc, collapse=&amp;quot;+&amp;quot;) 
nc.formula &amp;lt;- formula(paste(&amp;quot;twentyeight_day_mortality~&amp;quot;,nc.formula))
print(nc.formula)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## twentyeight_day_mortality ~ PMX + Age + Sex + MAP + APACHEⅡ + 
##     Mechanical_ventilation&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;ロジスティック回帰&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;ロジスティック回帰&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;model_nc &amp;lt;- pmx %&amp;gt;% glm(nc.formula, data = ., family = binomial(link = &amp;quot;logit&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;結果の確認&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;結果の確認&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(model_nc)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## glm(formula = nc.formula, family = binomial(link = &amp;quot;logit&amp;quot;), 
##     data = .)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.4461  -0.9199  -0.8317   1.3800   1.7795  
## 
## Coefficients:
##                         Estimate Std. Error z value Pr(&amp;gt;|z|)  
## (Intercept)            -0.457777   1.768631  -0.259   0.7958  
## PMX                     0.145555   0.200801   0.725   0.4685  
## Age                    -0.013387   0.012768  -1.048   0.2944  
## Sex                     0.191703   0.205746   0.932   0.3515  
## MAP                     0.005604   0.020071   0.279   0.7801  
## APACHEⅡ                 0.029188   0.020369   1.433   0.1519  
## Mechanical_ventilation -0.873933   0.367343  -2.379   0.0174 *
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 580.82  on 449  degrees of freedom
## Residual deviance: 570.18  on 443  degrees of freedom
## AIC: 584.18
## 
## Number of Fisher Scoring iterations: 4&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;オッズ比へ変換する&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# オッズ比と95%信頼区間の確認
nc_odds &amp;lt;- as.data.frame(cbind(exp(summary(model_nc)$coefficient[,1]),exp(confint(model_nc))
                                    ,summary(model_nc)$coefficient[,4]))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Waiting for profiling to be done...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# result_oddsというデータフレームの列名を名付ける
names(nc_odds) &amp;lt;- c(&amp;quot;Odds ratio&amp;quot;,&amp;quot;lower 95%CI&amp;quot;,&amp;quot;upper 95%CI&amp;quot;,&amp;quot;P value&amp;quot;)
# 小数点２桁で結果を表示
round(nc_odds,2)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##                        Odds ratio lower 95%CI upper 95%CI P value
## (Intercept)                  0.63        0.02       20.42    0.80
## PMX                          1.16        0.78        1.72    0.47
## Age                          0.99        0.96        1.01    0.29
## Sex                          1.21        0.81        1.82    0.35
## MAP                          1.01        0.97        1.05    0.78
## APACHEⅡ                      1.03        0.99        1.07    0.15
## Mechanical_ventilation       0.42        0.20        0.86    0.02&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(pROC)

ROC_nc &amp;lt;- roc(response = pmx$twentyeight_day_mortality, predictor = model_nc$fitted.values)
ROC_nc&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## roc.default(response = pmx$twentyeight_day_mortality, predictor = model_nc$fitted.values)
## 
## Data: model_nc$fitted.values in 294 controls (pmx$twentyeight_day_mortality 0) &amp;lt; 156 cases (pmx$twentyeight_day_mortality 1).
## Area under the curve: 0.598&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;AUC 0.598でモデルの精度は良くないことが分かる。&lt;/p&gt;
&lt;p&gt;結果としては、PMXはOR 1.16 (95%CI:0.78 - 1.72)で死亡を減らす関係は認めなかった。&lt;/p&gt;
&lt;p&gt;むしろ点推定値と信頼区間を考慮すると若干死亡を高める方向に働いている可能性もある。&lt;/p&gt;
&lt;p&gt;しかしAUCが低いことから、そもそもこのモデルの精度が良くないため共変量などについて再考する必要がありそう。&lt;/p&gt;
&lt;p&gt;＊人工呼吸器の使用で死亡が減る方向になっている結果は、シミュレーションデータなので今回は無視する。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;モデル2マルチレベルロジスティック回帰&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデル2:マルチレベルロジスティック回帰&lt;/h3&gt;
&lt;p&gt;このモデルではクラスター効果を考慮してモデルを作る。&lt;/p&gt;
&lt;p&gt;回帰モデルでは観測値の独立性が前提となっている。&lt;/p&gt;
&lt;p&gt;しかし各施設内では同じような治療がなされ治療成績が似通っている可能性がある。&lt;/p&gt;
&lt;p&gt;逆に言えば施設間でPMXの適応や手技の成熟度、集中治療のレベルなどが違う可能性があり、&lt;/p&gt;
&lt;p&gt;個人レベルでの変数のみではなく施設も影響するとしてモデルを作成する必要がある。&lt;/p&gt;
&lt;p&gt;施設という階層があり、その下に個人レベルの変数があるという形である。&lt;/p&gt;
&lt;p&gt;施設jに所属の個人iの死亡する確率&lt;span class=&#34;math inline&#34;&gt;\(p_{ij}\)&lt;/span&gt;は、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;レベル1(個人レベル): &lt;span class=&#34;math inline&#34;&gt;\(logit(p_{ij}) = M_{0j} + e_{ij}\)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;レベル2(集団レベル): &lt;span class=&#34;math inline&#34;&gt;\(M_{oj} = \gamma_{00} + u_{0j}\)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;として表すことができる。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(M_{0j}\)&lt;/span&gt;は集団jの死亡する平均確率、&lt;span class=&#34;math inline&#34;&gt;\(e_{ij}\)&lt;/span&gt;は集団jでの個人間の残差を表している。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(\gamma_{00}\)&lt;/span&gt;は集団全体の死亡する平均確率、&lt;span class=&#34;math inline&#34;&gt;\(u_{0j}\)&lt;/span&gt;は集団間の変動を表す。&lt;/p&gt;
&lt;p&gt;マルチレベルモデルでは集団によって変動しない値を固定効果(fixed effect)、
&lt;span class=&#34;math inline&#34;&gt;\(u_{oj}\)&lt;/span&gt;のように変動する値を変量効果(random effedt)と呼ぶ。&lt;/p&gt;
&lt;p&gt;それぞれが従う分布は平均0、個人レベルの分散&lt;span class=&#34;math inline&#34;&gt;\(V_I\)&lt;/span&gt;、集団レベルの分散&lt;span class=&#34;math inline&#34;&gt;\(V_C\)&lt;/span&gt;として、&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(e_{ij}\)&lt;/span&gt; ~ &lt;span class=&#34;math inline&#34;&gt;\(N(0,V_I)\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(u_{0j}\)&lt;/span&gt; ~ &lt;span class=&#34;math inline&#34;&gt;\(N(0,V_C)\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;の正規分布に従うことが仮定される。&lt;/p&gt;
&lt;p&gt;最終的にモデル2は、&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(logit(p_ij) = \gamma_{00} + u_{0j} + \beta_1*PMX_{ij} + \beta_2*Age_{ij} + \beta_3*Sex_{ij} + \beta_4*APACH_{ij} + \beta_5*Ven_{ij} + e_{ij}\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;として表すことができる。&lt;/p&gt;
&lt;div id=&#34;共変量の設定-1&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;共変量の設定&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;covariateName_c &amp;lt;- c(
  &amp;quot;PMX&amp;quot;,&amp;quot;Age&amp;quot;,&amp;quot;Sex&amp;quot;,&amp;quot;MAP&amp;quot;, &amp;quot;APACHEⅡ&amp;quot;, &amp;quot;Mechanical_ventilation&amp;quot;
  )&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;式の作成-1&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;式の作成&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;c.formula &amp;lt;- paste(covariateName_c, collapse=&amp;quot;+&amp;quot;) 
c.formula &amp;lt;- formula(paste(&amp;quot;twentyeight_day_mortality~&amp;quot;,c.formula,&amp;quot;+(1|institution_id)&amp;quot;))
print(c.formula)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## twentyeight_day_mortality ~ PMX + Age + Sex + MAP + APACHEⅡ + 
##     Mechanical_ventilation + (1 | institution_id)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;マルチレベルロジスティック回帰&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;マルチレベルロジスティック回帰&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(lme4)
model_c &amp;lt;- pmx %&amp;gt;% glmer(c.formula, data = ., family = binomial(link = &amp;quot;logit&amp;quot;), control = glmerControl(optimizer = &amp;quot;bobyqa&amp;quot;),
    nAGQ = 10)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;結果の確認-1&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;結果の確認&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;print(model_c, corr = FALSE)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Generalized linear mixed model fit by maximum likelihood (Adaptive
##   Gauss-Hermite Quadrature, nAGQ = 10) [glmerMod]
##  Family: binomial  ( logit )
## Formula: twentyeight_day_mortality ~ PMX + Age + Sex + MAP + APACHEⅡ +  
##     Mechanical_ventilation + (1 | institution_id)
##    Data: .
##       AIC       BIC    logLik  deviance  df.resid 
##  586.1784  619.0524 -285.0892  570.1784       442 
## Random effects:
##  Groups         Name        Std.Dev.
##  institution_id (Intercept) 0       
## Number of obs: 450, groups:  institution_id, 10
## Fixed Effects:
##            (Intercept)                     PMX                     Age  
##              -0.457777                0.145555               -0.013387  
##                    Sex                     MAP                 APACHEⅡ  
##               0.191703                0.005604                0.029188  
## Mechanical_ventilation  
##              -0.873933  
## convergence code 0; 0 optimizer warnings; 1 lme4 warnings&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;95%信頼区間を求める&lt;/p&gt;
&lt;p&gt;通常の方法では出せないので注意&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;se &amp;lt;- sqrt(diag(vcov(model_c)))
# table of estimates with 95% CI
(tab &amp;lt;- cbind(Est = fixef(model_c), LL = fixef(model_c) - 1.96 * se, UL = fixef(model_c) + 1.96 *
    se))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##                                 Est          LL          UL
## (Intercept)            -0.457777126 -3.92314409  3.00758984
## PMX                     0.145554945 -0.24801464  0.53912453
## Age                    -0.013386704 -0.03840952  0.01163611
## Sex                     0.191702790 -0.21155879  0.59496437
## MAP                     0.005604172 -0.03371708  0.04492542
## APACHEⅡ                 0.029187831 -0.01073457  0.06911023
## Mechanical_ventilation -0.873933310 -1.59392402 -0.15394260&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;オッズ比を求める&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;round(exp(tab),2)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##                         Est   LL    UL
## (Intercept)            0.63 0.02 20.24
## PMX                    1.16 0.78  1.71
## Age                    0.99 0.96  1.01
## Sex                    1.21 0.81  1.81
## MAP                    1.01 0.97  1.05
## APACHEⅡ                1.03 0.99  1.07
## Mechanical_ventilation 0.42 0.20  0.86&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;今回の結果は、ランダム効果の分散は0であり、目的変数には集団による違いはないことになる。&lt;/p&gt;
&lt;p&gt;実際、モデル1とモデル2では結果はほぼ同じである。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;級内相関係数&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;級内相関係数&lt;/h4&gt;
&lt;p&gt;病院などの集団内でデータがどの程度類似しているかを検討するための指標として、級内相関係数(ICC)がある。&lt;/p&gt;
&lt;p&gt;ICCが大きいほど観測値の独立性の仮定からの逸脱が大きいことを意味する。&lt;/p&gt;
&lt;p&gt;線形回帰モデルと違いロジスティック回帰モデルでは解釈が難しい。&lt;/p&gt;
&lt;p&gt;なぜなら、集団内での分散はロジスティック尺度上にあり、個人レベルの分散は確率であるからである。
(二項分布の分散Vはp(1-p)である。)&lt;/p&gt;
&lt;p&gt;いくつか計算する方法はあるが今回は分散が0のためICCは計算できない。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;tau2 &amp;lt;- lme4::VarCorr(model_c)
tau2&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  Groups         Name        Std.Dev.
##  institution_id (Intercept) 0&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;参考文献&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;参考文献&lt;/h3&gt;
&lt;p&gt;Peter C Austin, Juan Merlo. Intermediate and advanced topics in multilevel logistic regression analysis.
Stat Med. 2017. 10;36(20):3257 - 3277.
&lt;a href=&#34;PMID:28543517&#34; class=&#34;uri&#34;&gt;PMID:28543517&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Juan Merlo, Basile Chais, et.al. A brief conceptual tutorial of multilevel analysis in social epidemiology: using measures of clustering in multilevel logistic regression to investigate contextual phenomena. J Epidemiol Community Health 2006;60:290–297.
&lt;a href=&#34;PMID:15911637&#34; class=&#34;uri&#34;&gt;PMID:15911637&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Three methods for computing the intra-class correlation in multilevel logistic regression&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.barelysignificant.com/post/icc/&#34; class=&#34;uri&#34;&gt;https://www.barelysignificant.com/post/icc/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;MIXED EFFECTS LOGISTIC REGRESSION | R DATA ANALYSIS EXAMPLES&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/&#34; class=&#34;uri&#34;&gt;https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Rによる傾向スコアの実装</title>
      <link>/post/propensity_score/</link>
      <pubDate>Wed, 22 Jul 2020 22:16:38 +0900</pubDate>
      <guid>/post/propensity_score/</guid>
      <description>


&lt;div id=&#34;サンプルデータを作成する&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;サンプルデータを作成する&lt;/h3&gt;
&lt;p&gt;適当なパッケージがないため、仮想データを作成する。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Effect of Targeted Polymyxin B Hemoperfusion on 28-Day Mortality in Patients With Septic Shock and Elevated Endotoxin Level&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The EUPHRATES Randomized Clinical Trialより&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;元ネタは敗血症性ショックに対するエンドトキシン吸着療法の多施設共同RCT(60施設)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;PMX療法(透析)対シャム療法(偽透析：透析している振り)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;サンプル数:450名のRCT&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Age, Sex, 平均血圧(Arterial pressure mean:MAP)、重症度スコア(APACHEⅡ)、人工呼吸器の有無(Mechanical&lt;br /&gt;
ventilation)、菌血症の有無(Bacteremia)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;介入:エンドトキシン吸着療法(PMX)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;アウトカム:28日後死亡(twentyeight_day_mortality)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;今回は多施設観察研究と想定し施設数も作成して、10施設とする&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;JAMA&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://jamanetwork.com/journals/jama/fullarticle/2706139&#34; class=&#34;uri&#34;&gt;https://jamanetwork.com/journals/jama/fullarticle/2706139&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;パッケージの読み込み&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;パッケージの読み込み&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(dplyr)
# パイプを使うため
library(magrittr)
# シミュレーションデータを作るため
library(simstudy)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;仮想データの実装&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;仮想データの実装&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;set.seed(123) # seedを設定することで必ず同じデータが毎回できるので再現性の固定
# まず施設IDの作成
b &amp;lt;- defData(varname = &amp;quot;institution_id&amp;quot;, dist = &amp;quot;noZeroPoisson&amp;quot;, formula = 3)
c &amp;lt;- genData(450, b)

# 各変数の作成
a &amp;lt;- data.frame(rnorm(450,59,8),rbinom(450,1,prob=0.6),rnorm(450,72,5),rnorm(450,28,5),rbinom(450,1,0.94)
               ,rbinom(450,1,0.30),rbinom(450,1,0.5),rbinom(450,1,0.34))

colnames(a) &amp;lt;- c(&amp;#39;Age&amp;#39;,&amp;#39;Sex&amp;#39;,&amp;#39;MAP&amp;#39;,&amp;#39;APACHEⅡ&amp;#39;,&amp;#39;Mechanical_ventilation&amp;#39;,&amp;#39;Bacteremia&amp;#39;,&amp;#39;PMX&amp;#39;,&amp;#39;twentyeight_day_mortality&amp;#39;)
# 列の名前を付ける 
# sex 1=male, Mechanical_ventilation yes=1, Bacteremia yes=1, PMX yes=1, 28day_mortality yes=1 &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;両者を結合する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;pmx &amp;lt;- cbind.data.frame(c,a)

pmx &amp;lt;- as.data.frame(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;作成したデータの確認&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;作成したデータの確認&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##        id        institution_id        Age             Sex        
##  Min.   :  1.0   Min.   : 1.000   Min.   :36.52   Min.   :0.0000  
##  1st Qu.:113.2   1st Qu.: 2.000   1st Qu.:54.19   1st Qu.:0.0000  
##  Median :225.5   Median : 3.000   Median :59.33   Median :1.0000  
##  Mean   :225.5   Mean   : 3.142   Mean   :59.11   Mean   :0.5822  
##  3rd Qu.:337.8   3rd Qu.: 4.000   3rd Qu.:64.59   3rd Qu.:1.0000  
##  Max.   :450.0   Max.   :10.000   Max.   :79.57   Max.   :1.0000  
##       MAP           APACHEⅡ      Mechanical_ventilation   Bacteremia    
##  Min.   :59.25   Min.   :12.76   Min.   :0.0000         Min.   :0.0000  
##  1st Qu.:68.47   1st Qu.:25.05   1st Qu.:1.0000         1st Qu.:0.0000  
##  Median :71.81   Median :28.54   Median :1.0000         Median :0.0000  
##  Mean   :72.00   Mean   :28.30   Mean   :0.9267         Mean   :0.2689  
##  3rd Qu.:75.03   3rd Qu.:31.90   3rd Qu.:1.0000         3rd Qu.:1.0000  
##  Max.   :88.95   Max.   :44.45   Max.   :1.0000         Max.   :1.0000  
##       PMX         twentyeight_day_mortality
##  Min.   :0.0000   Min.   :0.0000           
##  1st Qu.:0.0000   1st Qu.:0.0000           
##  Median :0.0000   Median :0.0000           
##  Mean   :0.4889   Mean   :0.3467           
##  3rd Qu.:1.0000   3rd Qu.:1.0000           
##  Max.   :1.0000   Max.   :1.0000&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;str(pmx)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    450 obs. of  10 variables:
##  $ id                       : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ institution_id           : num  2 4 3 5 6 1 3 5 3 3 ...
##  $ Age                      : num  59.5 53.4 53.3 66.1 50.9 ...
##  $ Sex                      : int  1 1 1 1 1 1 1 0 1 1 ...
##  $ MAP                      : num  66.9 68 73.5 80.2 77.4 ...
##  $ APACHEⅡ                  : num  27.3 20.8 24 32.4 32.5 ...
##  $ Mechanical_ventilation   : int  1 1 1 1 1 1 1 1 0 1 ...
##  $ Bacteremia               : int  0 0 0 0 0 1 1 0 0 0 ...
##  $ PMX                      : int  0 0 0 1 0 0 0 0 1 1 ...
##  $ twentyeight_day_mortality: int  1 0 0 0 0 1 0 0 1 0 ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;おおむね狙い通りのデータになっていることが分かる。&lt;/p&gt;
&lt;p&gt;今回は施設というクラスターは無視して傾向スコアを用いて解析を実装する。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;傾向スコアの作成&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;傾向スコアの作成&lt;/h3&gt;
&lt;p&gt;実際の論文ではRCTのため傾向スコアや多変量解析は行われていない。&lt;/p&gt;
&lt;p&gt;今回は観察研究という設定で計算する。&lt;/p&gt;
&lt;p&gt;PMXを行うか否かについて関係する共変量を設定する。&lt;/p&gt;
&lt;p&gt;まず共変量をオブジェクトに格納する。&lt;/p&gt;
&lt;p&gt;こうすることの利点はモデルを作る際に見やすくなることである。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;covariateNames &amp;lt;- c(
  &amp;quot;Age&amp;quot;,
  &amp;quot;Sex&amp;quot;,
  &amp;quot;MAP&amp;quot;,
  &amp;quot;APACHEⅡ&amp;quot;,
  &amp;quot;Mechanical_ventilation&amp;quot;
)&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;治療指標の作成&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;治療指標の作成&lt;/h4&gt;
&lt;p&gt;便利のために、pmxとは別に治療指標の変数を作成する。治療指標は因子型としておく。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;pmx$treat &amp;lt;- as.factor(pmx$PMX)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;####　連続予測子の標準化&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#標準化された連続予測子
for (var in covariateNames) {
  if (class(pmx[,var])!=&amp;quot;factor&amp;quot;) { pmx[,var] = (pmx[,var]-mean(pmx[,var]))/sd(pmx[,var]) }
  }&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;傾向スコアの推定&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;傾向スコアの推定&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#ロジスティック回帰モデルの式の作成準備
ps.formula &amp;lt;- paste(covariateNames, collapse=&amp;quot;+&amp;quot;) 
ps.formula &amp;lt;- formula(paste(&amp;quot;treat~&amp;quot;,ps.formula))
print(ps.formula)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## treat ~ Age + Sex + MAP + APACHEⅡ + Mechanical_ventilation&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#クラスタリングを無視した傾向スコアの推定
#ps.model &amp;lt;- glm(ps.formula, data = pmx, family=binomial)

ps.model &amp;lt;- pmx %&amp;gt;% glm(ps.formula, data = ., family=binomial(link = &amp;quot;logit&amp;quot;))

#クラスタリングを無視した傾向スコアを得る
pmx$ps &amp;lt;- fitted(ps.model)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;傾向スコアの評価&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;傾向スコアの評価&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(pROC)

ROC &amp;lt;- pmx %&amp;gt;% roc(treat ~ ps, data = ., ci = TRUE)
ROC&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## roc.formula(formula = treat ~ ps, data = ., ci = TRUE)
## 
## Data: ps in 230 controls (treat 0) &amp;lt; 220 cases (treat 1).
## Area under the curve: 0.5255
## 95% CI: 0.472-0.579 (DeLong)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;今回はAUC 0.5255と低い値であり、モデルの精度として良くないようである。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;common-supportの評価&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Common supportの評価&lt;/h4&gt;
&lt;p&gt;傾向スコアにばらつきがないかを評価する&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;hist(pmx$ps[pmx$treat==0], density = 10, angle = 45, main=&amp;quot;Propensity Scores&amp;quot;,
     breaks=seq(0,1,by=0.01),
     xlim=c(0,1), ylim=c(0,50), xlab=&amp;quot;Shaded = Untreated | Gray = PMX&amp;quot;)
hist(pmx$ps[pmx$treat==1], col=gray(0.4,0.25), breaks=seq(0,1,by=0.01),
     xlim=c(0,1), ylim=c(0,50),add=T) &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/Propensity_score_files/figure-html/unnamed-chunk-12-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;PMX群とコントロール群では傾向スコアの分布は同じくらいであることが分かる。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;ateの推定&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;ATEの推定&lt;/h3&gt;
&lt;p&gt;今回は、試験の対象集団全体におけるPMXの効果を知りたいのであるからAverage treatment effect(ATE)を
推定することとする。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 重みの計算
pmx$psw &amp;lt;- with(pmx, ifelse(treat==1, 1/ps, 1/(1-ps)))

summary(pmx$psw)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.745   1.929   1.995   2.000   2.056   2.301&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;今回は傾向スコアに極端なweightはないが、もしある場合は対処を考える必要がある。&lt;/p&gt;
&lt;p&gt;方法として、&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;p&gt;極端なweightがモデルの仕様の誤りによるものかどうかをチェックするために、傾向スコアモデルを再指定する&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;傾向スコア法を変更する&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;weight打切りを行う&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;安定化weightを使用する。&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;3については99%タイルでweightを切り捨てるという方法がある。&lt;/p&gt;
&lt;p&gt;4についてはweightを加重平均などで安定化する方法である。&lt;/p&gt;
&lt;p&gt;今回は不要だが、参考までにweightの安定化を行う。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#重みの正規化
pmx$psw &amp;lt;- pmx$psw/mean(pmx$psw)
# 統合
with(pmx, by(psw, PMX, summary))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## PMX: 0
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.8724  0.9464  0.9803  0.9782  1.0087  1.1163 
## ------------------------------------------------------------ 
## PMX: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.9079  0.9842  1.0158  1.0228  1.0559  1.1506&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;安定化する前と比べてもほとんど変化はないことが分かる。&lt;/p&gt;
&lt;p&gt;今回は仮想データであるため、元々傾向スコアの分布が比較的均一であったため、安定化や切り捨ては不要で&lt;br&gt;
ある。&lt;/p&gt;
&lt;p&gt;実際のデータでは極端なweightを取ることがあるため、対処が必要になることがある。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;両群のバランス評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;両群のバランス評価&lt;/h3&gt;
&lt;p&gt;介入群とコントロール群でバランスがとれているか確認が必要である。&lt;/p&gt;
&lt;p&gt;そのためにtwangパッケージを用いる。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;require(twang)

baseline.balance &amp;lt;- bal.stat(data=pmx,#データセット
                          var=covariateNames,#バランスチェックの確認に含む変数のリスト
                          treat.var=&amp;quot;treat&amp;quot;,#介入・曝露の変数
                          w.all=1,#傾向スコアのweightなどがある場合、デフォルトは1 (no weighting)
                          sampw=1,#サンプリングウェイト (no weighting)
                          get.means=T, #平均と分散を計算するかどうか
                          get.ks=F,#コルモゴロフ・スミルノフ統計量を計算するかどうか
                          estimand=&amp;quot;ATE&amp;quot;,#ATEとATTどちらか
                          multinom=F)#多項傾向スコアを用いるかどうか

baseline.balance.es &amp;lt;- baseline.balance$results

summary(abs(baseline.balance.es$std.eff.sz))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## 0.008427 0.022860 0.029534 0.035160 0.044532 0.070447&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;標準化効果量は最大で0.070447とバランスはとれているようである。&lt;/p&gt;
&lt;p&gt;続いて傾向スコアで重みづけした後のバランス評価を行う。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;psw.balance &amp;lt;- bal.stat(data=pmx,#データセット
                          var=covariateNames,#バランスチェックの確認に含む変数のリスト
                          treat.var=&amp;quot;treat&amp;quot;,#介入・曝露の変数
                          w.all=pmx$psw,#傾向スコアのweightなどがある場合
                          sampw=1,#サンプリングウェイト (no weighting)
                          get.means=T, #平均と分散を計算するかどうか
                          get.ks=F,#コルモゴロフ・スミルノフ統計量を計算するかどうか
                          estimand=&amp;quot;ATE&amp;quot;,#ATEとATTどちらか
                          multinom=F)#多項傾向スコアを用いるかどうか


psw.balance.table &amp;lt;- psw.balance$results

summary(abs(psw.balance.table$std.eff.sz))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
## 5.949e-05 9.701e-05 1.924e-04 2.899e-04 5.454e-04 5.550e-04&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;標準効果量はかなり小さく、今回のデータでは重みづけする前後でもバランスはとれていた。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;治療効果の評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;治療効果の評価&lt;/h3&gt;
&lt;p&gt;今回はデータ作成の都合上、簡単のために生存までの時間は無視してロジスティック回帰モデルで評価する。&lt;/p&gt;
&lt;p&gt;そのために変数を論理型に変更しておく。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;pmx$twentyeight_day_mortality &amp;lt;- as.logical(pmx$twentyeight_day_mortality)
pmx$PMX &amp;lt;- as.logical(pmx$PMX)

str(pmx$twentyeight_day_mortality)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  logi [1:450] TRUE FALSE FALSE FALSE FALSE TRUE ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;論理型に変換できたことを確認&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;final.model &amp;lt;- pmx %&amp;gt;%
  glm(twentyeight_day_mortality ~ PMX, family = binomial(link = &amp;quot;logit&amp;quot;), weights = psw, data = .)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning in eval(family$initialize): non-integer #successes in a binomial glm!&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ここでの警告はstack.flowを見る限り問題はなさそう。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://stackoverflow.com/questions/12953045/warning-non-integer-successes-in-a-binomial-glm-survey-packages&#34; class=&#34;uri&#34;&gt;https://stackoverflow.com/questions/12953045/warning-non-integer-successes-in-a-binomial-glm-survey-packages&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;二重にロバストな推定&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(lmtest)
library(sandwich)
result &amp;lt;- coeftest(final.model, vcov = sandwich)&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(result)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##     Estimate          Std. Error        z value           Pr(&amp;gt;|z|)        
##  Min.   :-0.69787   Min.   :0.1403   Min.   :-4.9734   Min.   :0.0000007  
##  1st Qu.:-0.48800   1st Qu.:0.1549   1st Qu.:-3.5517   1st Qu.:0.1188765  
##  Median :-0.27813   Median :0.1694   Median :-2.1299   Median :0.2377523  
##  Mean   :-0.27813   Mean   :0.1694   Mean   :-2.1299   Mean   :0.2377523  
##  3rd Qu.:-0.06826   3rd Qu.:0.1839   3rd Qu.:-0.7082   3rd Qu.:0.3566282  
##  Max.   : 0.14161   Max.   :0.1985   Max.   : 0.7136   Max.   :0.4755040&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;exp(result[2])&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] 1.152124&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;exp(-1.96*result[4])&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.6777543&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;exp(1.96*result[4])&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] 1.475461&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;PMXのオッズ比は1.15 (95%CI 0.68 - 1.48)であった。&lt;/p&gt;
&lt;p&gt;RRに変換すると、1.068となる。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://clincalc.com/Stats/ConvertOR.aspx#1&#34; class=&#34;uri&#34;&gt;https://clincalc.com/Stats/ConvertOR.aspx#1&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これは元論文の1.09と近いが、そもそも介入と非介入の割合が50%なので、リスク比に変換するのは正しくないであろう。&lt;/p&gt;
&lt;div id=&#34;参考文献&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;【参考文献】&lt;/h4&gt;
&lt;p&gt;Practical Propensity Score Methods Using R SAGE Publications, Inc&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Rによる生存時間解析の実装</title>
      <link>/post/survival/</link>
      <pubDate>Wed, 15 Jul 2020 22:16:38 +0900</pubDate>
      <guid>/post/survival/</guid>
      <description>


&lt;div id=&#34;パッケージの読み込み&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;パッケージの読み込み&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;まずパッケージを読み込む&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# パッケージの読み込み
library(survival)
library(magrittr)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データの確認&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;データの確認&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;summary関数とstr関数を用いる。&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;必要に応じてグラフなどを書いてデータの分布を調べる。&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;head(myeloid, n = 5)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##   id trt sex futime death txtime crtime rltime
## 1  1   B   f    235     1     NA     44    113
## 2  2   A   m    286     1    200     NA     NA
## 3  3   A   f   1983     0     NA     38     NA
## 4  4   B   f   2137     0    245     25     NA
## 5  5   B   f    326     1    112     56    200&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;先頭5行の表示&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(myeloid)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##        id            trt            sex         futime           death       
##  Min.   :  1.0   Length:646         f:361   Min.   :   4.0   Min.   :0.0000  
##  1st Qu.:162.2   Class :character   m:285   1st Qu.: 286.5   1st Qu.:0.0000  
##  Median :323.5   Mode  :character           Median : 817.0   Median :0.0000  
##  Mean   :323.5                              Mean   :1010.1   Mean   :0.4954  
##  3rd Qu.:484.8                              3rd Qu.:1733.2   3rd Qu.:1.0000  
##  Max.   :646.0                              Max.   :2419.0   Max.   :1.0000  
##                                                                              
##      txtime           crtime          rltime      
##  Min.   :  24.0   Min.   : 21.0   Min.   :  26.0  
##  1st Qu.: 105.0   1st Qu.: 32.0   1st Qu.: 181.5  
##  Median : 147.0   Median : 39.0   Median : 283.0  
##  Mean   : 229.3   Mean   : 50.1   Mean   : 363.3  
##  3rd Qu.: 244.2   3rd Qu.: 57.0   3rd Qu.: 470.0  
##  Max.   :1526.0   Max.   :554.0   Max.   :1905.0  
##  NA&amp;#39;s   :282      NA&amp;#39;s   :192     NA&amp;#39;s   :420&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# データの型確認
str(myeloid)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    646 obs. of  8 variables:
##  $ id    : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ trt   : chr  &amp;quot;B&amp;quot; &amp;quot;A&amp;quot; &amp;quot;A&amp;quot; &amp;quot;B&amp;quot; ...
##  $ sex   : Factor w/ 2 levels &amp;quot;f&amp;quot;,&amp;quot;m&amp;quot;: 1 2 1 1 1 1 2 1 1 1 ...
##  $ futime: num  235 286 1983 2137 326 ...
##  $ death : num  1 1 0 0 1 0 1 1 0 0 ...
##  $ txtime: num  NA 200 NA 245 112 102 NA 205 NA 106 ...
##  $ crtime: num  44 NA 38 25 56 NA NA 34 28 NA ...
##  $ rltime: num  113 NA NA NA 200 NA NA 382 NA NA ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ここで使うデータは、パッケージに付属のデータ：白血病患者に対する治療のA/Bでの効果を調べるデータ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;id: subject identifier, 1-646,&lt;/li&gt;
&lt;li&gt;trt: treatment arm A or B,&lt;br /&gt;
&lt;/li&gt;
&lt;li&gt;sex: f=female, m=male,&lt;br /&gt;
&lt;/li&gt;
&lt;li&gt;futime: time to death or last follow-up,&lt;br /&gt;
&lt;/li&gt;
&lt;li&gt;death: 1 if futime is a death, 0 for censoring,&lt;br /&gt;
&lt;/li&gt;
&lt;li&gt;txtime: time to hematropetic stem cell transplant&lt;/li&gt;
&lt;li&gt;crtime: time to complete response, rltime: time to relapse of disease&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;今回は治療A/Bと死亡までの差をみる&lt;/p&gt;
&lt;p&gt;欠損値が存在しているが、今回の解析には影響を与えない。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;生存時間解析の準備&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;生存時間解析の準備&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ge.surv &amp;lt;- Surv(myeloid$futime, myeloid$death)
head(ge.surv, n = 10)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  [1]  235   286  1983+ 2137+  326  2041+   63   446  1695+ 1669+&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;+はイベント打ち切り、無印はイベントがなかったことを示す&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#myeloid %&amp;gt;% 
  Surv(myeloid$futime, myeloid$death)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##   [1]  235   286  1983+ 2137+  326  2041+   63   446  1695+ 1669+   66+ 1364+
##  [13]   17+  209   261  2380+  431   372   838  2086+ 1480+  188   963   318 
##  [25]  373  1657+  213  1421+  337   565   286  1823+   17+  201   321+  529 
##  [37]  266  1305  1460+ 1832  1859+ 1864+ 1880+  368  1391+  762   332   376+
##  [49] 1740+ 2241+  582   284   823  2186+ 2198+ 1737+ 2315+ 2006+  185  2367+
##  [61] 1893+ 1734+ 2042+ 2162+ 1176+ 2148+ 2247+ 1991+  180  1956+ 1976+   13 
##  [73] 1913+  110   116   245  2194+  531  1782+  548    46  2052+  411  1034 
##  [85]  293  2250+  235   267  2136+ 1465+  439   295   286  1251+ 1360+ 1783+
##  [97] 1866+  892  1525+  461   322  1323+  651   241+ 2300+ 2192+  191    18+
## [109] 1621    50    15+   27   574   917   609  1774+  206   297    77    52 
## [121] 1429+  278  1393+  232   106   397   140  2038+ 1911+   13  1990+  424 
## [133] 2063+ 1721+  955+ 1731+ 1499+  281   310  1999+  408  1361+  337    15+
## [145] 1530+  234  1681+  518   800  1806+ 1192+ 2304+ 1687+ 1785+ 1912+ 2335+
## [157]   31+  485   432+ 1409  1464+   18   462   408  1423+ 1431+  248  1459+
## [169] 2148+ 2188+ 1725+  218  1999+ 1254  1420+ 1521+ 1921+ 1648+ 1555+  614 
## [181]   50    86   588+  874    33   156   563   231  1020  1390+  572  1877+
## [193] 2122+  322   511   288   368   480  2224+ 1708+  561  1578+  834  1583+
## [205]    7+  513  1426+ 2040+ 1796+ 1627+  360  1280+ 2371+ 1479+  260  2219+
## [217]   20   269   381   163  1287+ 1092+  154   771  1972+ 1658+ 2283  1827+
## [229]    4+ 2210+ 1379   516  1007  1757+ 2134+   99  1369+  121  2361+  423 
## [241]  322  1423+  369   603    25  1809+  131   602   692  1444+  601+  305 
## [253]  518  2118+  972   524  1881+   74  2345+  403    14+ 2053+ 2254+   76 
## [265]   22+ 2154+  779   167    16+  191   707   103   283   293  1442+ 1350+
## [277] 1710+   19+ 1384+  263  1947+  230   248   216  1717+ 1718+  707   303 
## [289]   89  1545+ 1283   388  2023+ 1990+  140   759  2145+  168+ 1843+ 2188+
## [301] 1960+  874    34   438   396   867  1885+  148  1522+ 2233+ 1795+   13 
## [313] 1467+ 1682+ 2063+ 1302+   56  1666+ 1708+ 1384+  644   239  2095+ 2065+
## [325]  588   432   308  1779+  197  2183+ 1368+  193  2239+ 1479+ 1414+  599 
## [337] 1834+ 1290+ 1968+ 2123+  385   698+ 2255+ 1319+ 1465+ 1552  1883+  409 
## [349]  144   157  1370+  193+  128   671   670  1960+ 1320+  679  1815+ 2149+
## [361]  748  1901+ 2229+  964  1379+  146   179     6+ 1755+ 2043+  258   460 
## [373]  575   364  2344+ 1953+  386  1164   374  1683+ 1704+   86+  262   187 
## [385]   65   355    36+ 1727+ 1855+  215   319  1861+   21+  497  1385+    9 
## [397]  418  2028+  476  1744+ 1952+  344   464  1742+  355  2222+  226   356 
## [409] 1405+  210   907  2276+  104   565   727   385    20   333   578  1988+
## [421] 1349+ 2007+  255   522   539    23  1714+ 2056+  341   258  2237+ 1102 
## [433] 1729+ 2318+    9+  411    59+  805  2058+  697  2048+ 2034+  696   411 
## [445] 2083+  388   342  1544+   44   326  2200+   28  1360+  658   621   307 
## [457]  248  1652+ 1623+  540   166   246   458   329  2017+ 1129  1720+ 1703+
## [469]  167  1584+    9+ 1021   465  1308+ 1681+ 1846+ 1241  1602+ 1813+ 1742+
## [481] 1459+   95  1559+   24   465  1333+  419  1924+   85  1537   246  1774+
## [493] 1999+ 2233+ 1367+  267  1085  2052+  742   516+  499  1907+  400  1792+
## [505] 1698+  774   833  2253+ 1383+ 1039+  148   447   476   736  1485+  567+
## [517]   27  1745+  313  1739+ 2043+ 1760+   45   145  1989+  242  1099+  506 
## [529] 2044+ 1497+  156   456  1695+ 2299+ 1281+ 1990+   24   495   743  2419+
## [541] 1764+  170  1331+  112   295   359    32    27  1374+  120+  365   144 
## [553]  168  1901+  275   826  1704+  432+ 1780+   49+ 1313+   24+ 2126+  609 
## [565]  203  1245   436+ 1825+ 1915  2150+ 1710+ 2125+ 1594+ 1414+ 1455+ 1799+
## [577] 1728+ 1688+ 1113+  185    10+  811  1480+  515   122  2179+  420   248 
## [589]   24   906+  486   273  1220    40   443   383   829   160+  275   400 
## [601]  768  1347+ 1374+  375  1456+   27    93+ 1943+ 2041+  517   252   293 
## [613] 1417+  752  1322+ 2070+   16  2191+  334  1370  2369+ 1401+  664   259 
## [625] 2308+ 2335+  120  2055+ 1730+ 1373+  563  1480+  884  1386+ 1845+ 1313+
## [637]  410   697   253    21    22+  237  2394+   17+  181    25+&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;kaplan-meier法&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Kaplan-Meier法&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ノンパラメトリック法による生存時間を当てはめる関数 survfit&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;デフォルトはカプラン・マイヤー推定法&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div id=&#34;生存曲線を描く&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;生存曲線を描く&lt;/h4&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;plot(ge.model,lty=1:2,xlab = &amp;quot;Survival time&amp;quot;, ylab = &amp;quot;Overall survival&amp;quot;, col = 1:2) %&amp;gt;% legend(locator(1),c(&amp;quot;A&amp;quot;,&amp;quot;B&amp;quot;), lty=c(1,2))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/survival_files/figure-html/unnamed-chunk-7-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;## 実際に描くときはlegendを併記するとグラフに追記できる&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;うまくlegendが追加できない。ggplot2を使って記載する方法もある。&lt;/p&gt;
&lt;p&gt;ggplotを用いてカプランマイヤー曲線を描く。&lt;/p&gt;
&lt;p&gt;ggplotはdata.frame型を使わなければならないので、fortifyを定義してやる必要がある。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;fortify.survfit &amp;lt;- function(survfit.data) {
  data.frame(time = survfit.data$time,
             n.risk = survfit.data$n.risk,
             n.event = survfit.data$n.event,
             n.censor = survfit.data$n.censor,
             surv = survfit.data$surv,
             std.err = survfit.data$std.err,
             upper = survfit.data$upper,
             lower = survfit.data$lower,
             strata = rep(names(survfit.data$strata), survfit.data$strata))
}

head(ggplot2::fortify(ge.model))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##   time n.risk n.event n.censor      surv     std.err upper     lower strata
## 1    6    317       0        1 1.0000000 0.000000000     1 1.0000000  trt=A
## 2    9    316       0        2 1.0000000 0.000000000     1 1.0000000  trt=A
## 3   13    314       1        0 0.9968153 0.003189797     1 0.9906028  trt=A
## 4   14    313       0        1 0.9968153 0.003189797     1 0.9906028  trt=A
## 5   15    312       0        1 0.9968153 0.003189797     1 0.9906028  trt=A
## 6   16    311       1        1 0.9936101 0.004532899     1 0.9848216  trt=A&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(ggplot2)

ge.model %&amp;gt;% ggplot() + geom_line(aes_string(x = &amp;#39;time&amp;#39;, y = &amp;#39;surv&amp;#39;, colour = &amp;#39;strata&amp;#39;)) + 
  geom_ribbon(aes_string(x = &amp;#39;time&amp;#39;, ymin = &amp;#39;lower&amp;#39;, ymax = &amp;#39;upper&amp;#39;, fill = &amp;#39;strata&amp;#39;), alpha = 0.5) + 
  ylim(0,1) +
  xlab(&amp;quot;survival time&amp;quot;) + ylab(&amp;quot;survival rate&amp;quot;) + ggtitle(&amp;quot;Kaplan-Meier曲線&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/survival_files/figure-html/unnamed-chunk-9-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#+ scale_y_continuous(labels = scales::percent)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;打ち切りも表したいときは、&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ge.censor &amp;lt;- ggplot2::fortify(ge.model)  &lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ge.censor %&amp;gt;% ggplot() + geom_line(aes_string(x = &amp;#39;time&amp;#39;, y = &amp;#39;surv&amp;#39;, colour = &amp;#39;strata&amp;#39;)) + 
  geom_ribbon(aes_string(x = &amp;#39;time&amp;#39;, ymin = &amp;#39;lower&amp;#39;, ymax = &amp;#39;upper&amp;#39;, fill = &amp;#39;strata&amp;#39;), alpha = 0.5) + 
  geom_point(data = ge.censor[ge.censor$n.censor &amp;gt; 0,],
             aes_string(x = &amp;#39;time&amp;#39;, y = &amp;#39;surv&amp;#39;), shape = &amp;#39;+&amp;#39;, size = 2) +
  ylim(0,1) +
  xlab(&amp;quot;survival time&amp;quot;) + ylab(&amp;quot;survival rate&amp;quot;) + ggtitle(&amp;quot;Kaplan-Meier曲線&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/survival_files/figure-html/unnamed-chunk-11-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Kaplan-Meier曲線を見る限り、比例ハザード性は保たれているようである。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;ログランク検定&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;ログランク検定&lt;/h4&gt;
&lt;p&gt;AとBによる生存曲線を比較する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;survdiff(Surv(myeloid$futime, myeloid$death) ~ myeloid$trt)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Call:
## survdiff(formula = Surv(myeloid$futime, myeloid$death) ~ myeloid$trt)
## 
##                 N Observed Expected (O-E)^2/E (O-E)^2/V
## myeloid$trt=A 317      171      143      5.28      9.59
## myeloid$trt=B 329      149      177      4.29      9.59
## 
##  Chisq= 9.6  on 1 degrees of freedom, p= 0.002&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;帰無仮説は「両群の生存曲線に差がない」である。&lt;/p&gt;
&lt;p&gt;今回の結果はp値=0.002であり生存曲線に差があるという結果になる。&lt;/p&gt;
&lt;p&gt;ただし、ログランク検定では患者の背景因子などは調整されていない。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;cox比例ハザード&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Cox比例ハザード&lt;/h4&gt;
&lt;p&gt;先に描いた生存曲線から比例ハザード性は保たれていると考えられる。&lt;/p&gt;
&lt;p&gt;今回は性別くらいしか調整する変数はないが、それを加えて解析を行う。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;model.cox &amp;lt;- coxph(Surv(futime, death) ~ trt + sex, data = myeloid)
summary(model.cox)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Call:
## coxph(formula = Surv(futime, death) ~ trt + sex, data = myeloid)
## 
##   n= 646, number of events= 320 
## 
##         coef exp(coef) se(coef)      z Pr(&amp;gt;|z|)   
## trtB -0.3582    0.6989   0.1129 -3.174  0.00151 **
## sexm  0.1150    1.1219   0.1128  1.020  0.30782   
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
##      exp(coef) exp(-coef) lower .95 upper .95
## trtB    0.6989     1.4307    0.5602     0.872
## sexm    1.1219     0.8913    0.8994     1.399
## 
## Concordance= 0.549  (se = 0.016 )
## Likelihood ratio test= 10.56  on 2 df,   p=0.005
## Wald test            = 10.53  on 2 df,   p=0.005
## Score (logrank) test = 10.62  on 2 df,   p=0.005&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;性別による生存率に違いはない。&lt;/p&gt;
&lt;p&gt;治療BについてはHR 0.699 (95%CI 0.560 - 0.872)という結果で、治療B群の方が死亡率を有意に低下させる。&lt;/p&gt;
&lt;p&gt;【参考文献】&lt;/p&gt;
&lt;p&gt;ggplotでカプランマイヤー曲線を描く際に、こちらのサイトを参考にさせていただいた。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;http://sinhrks.hatenablog.com/entry/2014/10/04/195825&#34; class=&#34;uri&#34;&gt;http://sinhrks.hatenablog.com/entry/2014/10/04/195825&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>線形回帰モデルの基礎</title>
      <link>/post/linear/</link>
      <pubDate>Tue, 14 Jul 2020 22:57:37 +0900</pubDate>
      <guid>/post/linear/</guid>
      <description>


&lt;div id=&#34;一般事項&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;一般事項&lt;/h3&gt;
&lt;p&gt;ある変数と別の変数の関係を数式で表したものを回帰モデルと呼ぶ。&lt;/p&gt;
&lt;p&gt;両者の関係が線形で与えられると仮定したものが線形回帰モデルである。&lt;/p&gt;
&lt;p&gt;式で表すと、&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[y = \beta_0 + \beta_1x\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;である。&lt;/p&gt;
&lt;p&gt;実際のデータでこのモデルを考える際には、観測値と仮定したモデルとの間には誤差が生じるため&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(y_i = \beta_0 + \beta_1x_i + \epsilon_i\)&lt;/span&gt;となる。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(i = 1,2,3...n\)&lt;/span&gt;である。&lt;/p&gt;
&lt;p&gt;このモデルがデータに良くあてはまるためには誤差&lt;span class=&#34;math inline&#34;&gt;\(\epsilon_i\)&lt;/span&gt;の総和が小さくなるようなパラメータを求めればよい。&lt;/p&gt;
&lt;p&gt;ただし、線形回帰モデルと観測値の差は負の値になることもあるため、そのまま総和をとるわけでなく、2乗して&lt;/p&gt;
&lt;p&gt;総和をとる。これが&lt;strong&gt;最小二乗法&lt;/strong&gt;である。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;架空データの作成&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;架空データの作成&lt;/h3&gt;
&lt;p&gt;ここでは収縮期血圧と年齢の関係をみる単純なモデルを考える。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 乱数発生で毎回同じ値になるようにseedを設定する
set.seed(123)
# ある程度線形モデルにフィットするようにするため相関を指定
rho &amp;lt;- 0.65
# 正規分布に従う乱数の設定(サンプルサイズ、平均、標準偏差は自由に設定可能)
y &amp;lt;- rnorm(n = 50, mean = 140, sd = 10)
x &amp;lt;- rnorm(n = 50, mean = 65,  sd = 10)
z &amp;lt;- rnorm(n = 50, mean = 0,   sd = 10)
# 相関をもった現実味のある値にするため、それぞれbpとageに格納
# sqrtは平方根という意味
bp  &amp;lt;- sqrt(rho)*z + sqrt(1 - rho)*y + 30
age &amp;lt;- sqrt(rho)*z + sqrt(1 - rho)*x + 30
# データフレームという形式でbpとageをdataというオブジェクトに格納
data &amp;lt;- data.frame(age,bp)
# 列に名前を付ける
name &amp;lt;- c(&amp;quot;age&amp;quot;,&amp;quot;SBP&amp;quot;)
colnames(data) &amp;lt;- name
# これで収縮期血圧と年齢の関係を示すデータが完成&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データの確認を行う&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;データの確認を行う&lt;/h3&gt;
&lt;p&gt;次は実際にどんなデータであるか確認を行う。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 外れ値や欠損値など
# summaryはデータの平均などを示す関数、headは先頭から指定の行を表示
summary(data)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##       age             SBP        
##  Min.   :47.15   Min.   : 91.89  
##  1st Qu.:62.03   1st Qu.:103.05  
##  Median :66.83   Median :111.74  
##  Mean   :67.27   Mean   :110.98  
##  3rd Qu.:72.59   3rd Qu.:118.22  
##  Max.   :83.99   Max.   :134.37&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;head(data, n = 3)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##        age      SBP
## 1 64.22569 103.7818
## 2 70.35670 113.5344
## 3 66.21200 120.0577&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# strは各変数の形式を示す、実際の解析ではどの形式なのか数値型なのか因子型なのかといった形の確認が重要
str(data)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    50 obs. of  2 variables:
##  $ age: num  64.2 70.4 66.2 73.7 59.4 ...
##  $ SBP: num  104 114 120 110 106 ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;図示&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;図示&lt;/h3&gt;
&lt;p&gt;データの分布を散布図を描いて確認を行う。&lt;/p&gt;
&lt;p&gt;plot関数でも描くことができるが今回はggplot2を用いる。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(ggplot2)
ggplot(data = data,
       aes(x = age, y = SBP)) +
  geom_point() +
  theme_bw()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/linear_files/figure-html/unnamed-chunk-3-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;散布図をみる限り、年齢と収縮期血圧には線形の関係がありそうに見える。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;モデルを作成する&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデルを作成する&lt;/h3&gt;
&lt;p&gt;ここでは２変量の単純なモデルを作成する。&lt;/p&gt;
&lt;p&gt;lm関数は線形回帰モデルを作成する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;model &amp;lt;- lm(data = data, bp ~ age)
summary(model)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## lm(formula = bp ~ age, data = data)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -14.833  -4.858   0.504   6.091  13.138 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&amp;gt;|t|)    
## (Intercept)  62.2829     8.1559   7.637 7.83e-10 ***
## age           0.7239     0.1202   6.022 2.32e-07 ***
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
## Residual standard error: 7.478 on 48 degrees of freedom
## Multiple R-squared:  0.4304, Adjusted R-squared:  0.4185 
## F-statistic: 36.26 on 1 and 48 DF,  p-value: 2.322e-07&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Residualsは残差のことで誤差の予測値とみなすことができる。&lt;/p&gt;
&lt;p&gt;Coefficientsは係数の結果である。切片と係数に該当する。&lt;/p&gt;
&lt;p&gt;今回のモデルは、&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\(y_i = 62.283 + 0.724x_i\)&lt;/span&gt;と表すことができる。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;モデルの評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデルの評価&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(ggfortify)
autoplot(model, smooth.colour = NA)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: `arrange_()` is deprecated as of dplyr 0.7.0.
## Please use `arrange()` instead.
## See vignette(&amp;#39;programming&amp;#39;) for more help
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_warnings()` to see where this warning was generated.&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: Removed 50 row(s) containing missing values (geom_path).

## Warning: Removed 50 row(s) containing missing values (geom_path).

## Warning: Removed 50 row(s) containing missing values (geom_path).&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/linear_files/figure-html/unnamed-chunk-5-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;右上のQQplotはおおむね問題なさそうであり、残差は正規分布していそうである。&lt;/p&gt;
&lt;p&gt;また左下の図をみても分散に明らかな偏りはなさそうであり、等分散性が保たれていると思われる。
(ばらつきは比較的ありそうである)&lt;/p&gt;
&lt;p&gt;また先のsummaryの結果をみるとR-squaredという項目があるが、これが&lt;em&gt;決定係数&lt;/em&gt;である。&lt;/p&gt;
&lt;p&gt;予測値を&lt;span class=&#34;math inline&#34;&gt;\(\hat{y_i}\)&lt;/span&gt;、平均値を&lt;span class=&#34;math inline&#34;&gt;\(\bar{y}\)&lt;/span&gt;と表すと、&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[R^2 =1 - \frac{\sum_{i=1}^n(y_i - \hat{y_i})^2}{\sum_{i=1}^n(y_i - \bar{y})^2}\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;となる。決定係数は1に近いほど当てはまりがよいのであるから、この分数の部分が0に近ければよい。&lt;/p&gt;
&lt;p&gt;分子が小さくなる、つまり予測値と観測値が近いほど0に近づく、決定係数が1に近づくということになる。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;最後に散布図に線形回帰直線をひいてみる&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;最後に散布図に線形回帰直線をひいてみる&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(data = data,
       aes(x = age, y = SBP)) +
  geom_point() +
  stat_smooth(method = &amp;quot;lm&amp;quot;, se = TRUE, size = 1) +
  theme_bw()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## `geom_smooth()` using formula &amp;#39;y ~ x&amp;#39;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/linear_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;結果&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;結果&lt;/h3&gt;
&lt;p&gt;今回の年齢と収縮期血圧の関係では、年齢が高くなるほど線形に収縮期血圧が高くなると予想し、モデルを作成した。&lt;/p&gt;
&lt;p&gt;モデルの前提は満たされているようであり、係数も有意な結果であった。&lt;/p&gt;
&lt;p&gt;しかし決定係数は修正&lt;span class=&#34;math inline&#34;&gt;\(R^2\)&lt;/span&gt;および&lt;span class=&#34;math inline&#34;&gt;\(R^2\)&lt;/span&gt;ともに良いとは言えず、収縮期血圧について年齢だけのモデルでは、
十分に説明できていないことになる。&lt;/p&gt;
&lt;p&gt;実際の臨床でも血圧を予測するうえで他に、家族歴など様々な要因が重要であることは当然であり、年齢だけで
十分に説明できないということは妥当であるといえる。&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Logistic回帰の実装</title>
      <link>/post/logi/</link>
      <pubDate>Tue, 14 Jul 2020 22:46:04 +0900</pubDate>
      <guid>/post/logi/</guid>
      <description>


&lt;div id=&#34;パッケージの読み込み&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;パッケージの読み込み&lt;/h3&gt;
&lt;p&gt;今回はパッケージに付属のデータを用いる。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# 必要なパッケージの読み込み
library(ggplot2)
library(dplyr)
library(ggfortify)
library(DAAG)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データの確認&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;データの確認&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# データの確認
data(&amp;quot;head.injury&amp;quot;)
summary(head.injury)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##      age.65      amnesia.before   basal.skull.fracture  GCS.decrease    
##  Min.   :0.000   Min.   :0.0000   Min.   :0.00000      Min.   :0.00000  
##  1st Qu.:0.000   1st Qu.:0.0000   1st Qu.:0.00000      1st Qu.:0.00000  
##  Median :0.000   Median :0.0000   Median :0.00000      Median :0.00000  
##  Mean   :0.116   Mean   :0.2047   Mean   :0.06985      Mean   :0.02275  
##  3rd Qu.:0.000   3rd Qu.:0.0000   3rd Qu.:0.00000      3rd Qu.:0.00000  
##  Max.   :1.000   Max.   :1.0000   Max.   :1.00000      Max.   :1.00000  
##      GCS.13        GCS.15.2hours      high.risk      loss.of.consciousness
##  Min.   :0.00000   Min.   :0.0000   Min.   :0.0000   Min.   :0.0000       
##  1st Qu.:0.00000   1st Qu.:0.0000   1st Qu.:0.0000   1st Qu.:0.0000       
##  Median :0.00000   Median :0.0000   Median :0.0000   Median :0.0000       
##  Mean   :0.03749   Mean   :0.1266   Mean   :0.2429   Mean   :0.1118       
##  3rd Qu.:0.00000   3rd Qu.:0.0000   3rd Qu.:0.0000   3rd Qu.:0.0000       
##  Max.   :1.00000   Max.   :1.0000   Max.   :1.0000   Max.   :1.0000       
##  open.skull.fracture    vomiting       clinically.important.brain.injury
##  Min.   :0.00000     Min.   :0.00000   Min.   :0.0000                   
##  1st Qu.:0.00000     1st Qu.:0.00000   1st Qu.:0.0000                   
##  Median :0.00000     Median :0.00000   Median :0.0000                   
##  Mean   :0.03685     Mean   :0.09869   Mean   :0.0801                   
##  3rd Qu.:0.00000     3rd Qu.:0.00000   3rd Qu.:0.0000                   
##  Max.   :1.00000     Max.   :1.00000   Max.   :1.0000&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;str(head.injury)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## &amp;#39;data.frame&amp;#39;:    3121 obs. of  11 variables:
##  $ age.65                           : num  0 0 0 0 0 0 0 0 1 0 ...
##  $ amnesia.before                   : num  1 0 0 0 0 1 0 0 0 1 ...
##  $ basal.skull.fracture             : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ GCS.decrease                     : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ GCS.13                           : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ GCS.15.2hours                    : num  0 0 0 1 1 0 0 0 0 0 ...
##  $ high.risk                        : num  0 0 0 0 0 0 0 0 1 0 ...
##  $ loss.of.consciousness            : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ open.skull.fracture              : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ vomiting                         : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ clinically.important.brain.injury: num  0 0 0 0 0 0 0 0 0 0 ...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;## 分布や欠損、各変数の型を確認しておく&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;DAAGパッケージに付属のデータセット&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;軽度の頭部外傷のデータセット&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;3121名、11列をもつ。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以下、変数名&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;age.65：0 = under 65, 1 = over 65&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;amnesia.before : 受傷前についての健忘(記憶があるか)
amnesia before impact (less than 30 minutes = 0, more than 30 minutes =1).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;basal.skull.fracture : 頭蓋亭骨折(0 = no fracture, 1 = fracture).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;GCS.decrease : 意識レベル低下
Glasgow Coma Scale decrease (0 = no deterioration, 1 = deterioration).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;GCS.13 : 最初の意識レベル initial Glasgow Coma Scale (0 = not ‘13’, 1 = ‘13’).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;GCS.15.2hours : けがをして2時間後の意識レベル
Glasgow Coma Scale after 2 hours (0 = not ‘15’, 1 = ‘15’).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;high.risk : 神経学的な介入が必要かどうか医師による判断
assessed by clinician as high risk for neurological intervention (0 = not high risk, 1 = high risk).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;loss.of.consciousness : 意識消失の有無(0 = conscious, 1 = loss of consciousness).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;open.skull.fracture : 開放性頭蓋骨骨折(0 = no fracture, 1 = fracture)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;vomiting : 嘔吐の有無(0 = no vomiting, 1 = vomiting)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;clinically.important.brain.injury : CTで臨床的に重要な急性期の脳所見があるかどうか
any acute brain finding revealed on CT (0 = not present, 1 = present).&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;References&gt;&lt;/p&gt;
&lt;p&gt;Stiell, I.G., Wells, G.A., Vandemheen, K., Clement, C., Lesiuk, H., Laupacis, A., McKnight, R.D., Verbee, R., Brison, R., Cass, D., Eisenhauer, M., Greenberg, G.H., and Worthington, J. (2001) The Canadian CT Head Rule for Patients with Minor Head Injury, The Lancet. 357: 1391-1396.&lt;/p&gt;
&lt;p&gt;＜今回のモデル＞&lt;/p&gt;
&lt;p&gt;目的変数：CT所見に何か異常があるか&lt;/p&gt;
&lt;p&gt;興味のある説明変数：健忘の有無&lt;/p&gt;
&lt;p&gt;として多変量ロジスティック回帰モデルを作成する。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;モデルの作成&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデルの作成&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# モデルの作成
# glm関数は一般化線形モデルに用いる関数で、familyで自分が使いたい分布を指定する。
#今回は二値変数がアウトカムなので二項分布に従い、リンク関数はlogitなので以下のようになる

model &amp;lt;- glm(clinically.important.brain.injury ~ amnesia.before  + age.65 + GCS.decrease + GCS.15.2hours + GCS.13 + high.risk + loss.of.consciousness + vomiting,family = binomial(link = &amp;quot;logit&amp;quot;),data = head.injury)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;結果の確認&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;結果の確認&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# モデルの結果確認
summary(model)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## glm(formula = clinically.important.brain.injury ~ amnesia.before + 
##     age.65 + GCS.decrease + GCS.15.2hours + GCS.13 + high.risk + 
##     loss.of.consciousness + vomiting, family = binomial(link = &amp;quot;logit&amp;quot;), 
##     data = head.injury)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.6149  -0.3355  -0.2339  -0.1734   2.9001  
## 
## Coefficients:
##                       Estimate Std. Error z value Pr(&amp;gt;|z|)    
## (Intercept)            -4.1904     0.1485 -28.211  &amp;lt; 2e-16 ***
## amnesia.before          0.6055     0.1656   3.656 0.000256 ***
## age.65                  1.3412     0.1761   7.617 2.60e-14 ***
## GCS.decrease            0.3901     0.3573   1.092 0.274954    
## GCS.15.2hours           1.9435     0.1598  12.164  &amp;lt; 2e-16 ***
## GCS.13                  1.2985     0.2663   4.876 1.09e-06 ***
## high.risk               1.1237     0.1527   7.360 1.84e-13 ***
## loss.of.consciousness   0.8733     0.1926   4.534 5.78e-06 ***
## vomiting                1.2541     0.1865   6.724 1.77e-11 ***
## ---
## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1741.6  on 3120  degrees of freedom
## Residual deviance: 1287.0  on 3112  degrees of freedom
## AIC: 1305
## 
## Number of Fisher Scoring iterations: 6&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;各変数の係数を確認する。&lt;/p&gt;
&lt;p&gt;値をオッズ比へ変換する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# オッズ比と95%信頼区間の確認
result_odds &amp;lt;- as.data.frame(cbind(exp(summary(model)$coefficient[,1]),exp(confint(model))
                                    ,summary(model)$coefficient[,4]))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Waiting for profiling to be done...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# result_oddsというデータフレームの列名を名付ける
names(result_odds) &amp;lt;- c(&amp;quot;Odds ratio&amp;quot;,&amp;quot;lower 95%CI&amp;quot;,&amp;quot;upper 95%CI&amp;quot;,&amp;quot;P value&amp;quot;)
# 小数点２桁で結果を表示
round(result_odds,2)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##                       Odds ratio lower 95%CI upper 95%CI P value
## (Intercept)                 0.02        0.01        0.02    0.00
## amnesia.before              1.83        1.32        2.53    0.00
## age.65                      3.82        2.70        5.39    0.00
## GCS.decrease                1.48        0.71        2.91    0.27
## GCS.15.2hours               6.98        5.10        9.56    0.00
## GCS.13                      3.66        2.15        6.12    0.00
## high.risk                   3.08        2.28        4.15    0.00
## loss.of.consciousness       2.39        1.63        3.47    0.00
## vomiting                    3.50        2.42        5.03    0.00&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;モデルの評価&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;モデルの評価&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(pROC)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Type &amp;#39;citation(&amp;quot;pROC&amp;quot;)&amp;#39; for a citation.&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
##  次のパッケージを付け加えます: &amp;#39;pROC&amp;#39;&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  以下のオブジェクトは &amp;#39;package:stats&amp;#39; からマスクされています: 
## 
##      cov, smooth, var&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ROC &amp;lt;- roc(response=head.injury$clinically.important.brain.injury, predictor=model$fitted.values)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Setting levels: control = 0, case = 1&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Setting direction: controls &amp;lt; cases&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ROC&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## Call:
## roc.default(response = head.injury$clinically.important.brain.injury,     predictor = model$fitted.values)
## 
## Data: model$fitted.values in 2871 controls (head.injury$clinically.important.brain.injury 0) &amp;lt; 250 cases (head.injury$clinically.important.brain.injury 1).
## Area under the curve: 0.8387&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;plot(ROC)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/logi_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;ROC(C統計量)は0.837くらいで今回のモデルの当てはまりはよさそうである。&lt;/p&gt;
&lt;p&gt;「怪我の前の記憶喪失(健忘)」と「CT所見に何かしら異常が見つかるか」の関係をみることが今回の目的であり、&lt;br&gt;
最終結果はオッズ比 1.83, 95%CI 1.32 - 2.53となり、受傷時の健忘はCTの異常所見の発見に影響があると言える。&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Rによるグラフ基礎</title>
      <link>/post/2015-07-23-r-rmarkdown/</link>
      <pubDate>Mon, 13 Jul 2020 21:13:14 -0500</pubDate>
      <guid>/post/2015-07-23-r-rmarkdown/</guid>
      <description>


&lt;div id=&#34;一般事項&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;一般事項&lt;/h3&gt;
&lt;p&gt;Rにはグラフを書く上でおもに２つの方法がある。&lt;/p&gt;
&lt;p&gt;デフォルトのgraphicsで扱うplot関数などとggplot2パッケージによる方法である。&lt;/p&gt;
&lt;p&gt;ここでは医学系でよく扱うグラフをggplot2を実装する。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;データの準備&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;データの準備&lt;/h3&gt;
&lt;p&gt;あるA市とB市で収縮期血圧を調査した設定で架空データを作成する。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;set.seed(125) # 乱数の固定のシード
a &amp;lt;- rnorm(n = 100, mean = 140, sd = 10)
b &amp;lt;- rnorm(n = 100, mean = 60, sd = 5 )
c &amp;lt;- rep(c(&amp;quot;A_city&amp;quot;,&amp;quot;B_city&amp;quot;),50)
d &amp;lt;- rbinom(n = 100, size = 1, prob = 0.6)  # ここでは男性の割合を0.6として二項分布によるランダム値の作成
study &amp;lt;- data.frame(a,b,c,d)
name  &amp;lt;- c(&amp;quot;SBP&amp;quot;, &amp;quot;Age&amp;quot;, &amp;quot;City&amp;quot;, &amp;quot;Sex&amp;quot;) 
colnames(study) &amp;lt;- name
# 性別は二値なのでデータ型を変換する
study$Sex &amp;lt;- as.factor(study$Sex)
study$Sex &amp;lt;- factor(study$Sex,levels = c(1,0),
                  labels = c(&amp;quot;Male&amp;quot;,&amp;quot;Female&amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;データの確認&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;データの確認&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(study)
##       SBP             Age            City        Sex    
##  Min.   :103.9   Min.   :46.80   A_city:50   Male  :63  
##  1st Qu.:134.6   1st Qu.:56.90   B_city:50   Female:37  
##  Median :141.7   Median :59.93                          
##  Mean   :141.0   Mean   :60.09                          
##  3rd Qu.:147.9   3rd Qu.:63.14                          
##  Max.   :164.0   Max.   :72.41&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;散布図&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;散布図&lt;/h3&gt;
&lt;p&gt;ggplotでは要素を追記していく形が基本となる。&lt;/p&gt;
&lt;p&gt;散布図で連続変数同士の関係をみる。&lt;/p&gt;
&lt;p&gt;例えば年齢と収縮期血圧の関係を見たい場合&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(ggplot2)
ggplot(data = study, aes(x = Age, y = SBP, colour = City)) +   
# ここがベースで、使用するデータ、軸、およびcolourを指定することでカテゴリーごとに色分けできる
  geom_point(size = 4) +   # 散布図にするという指定
  xlab(&amp;quot;Age&amp;quot;) +    # x軸ラベルの命名
  ylab(&amp;quot;SBP&amp;quot;) +    # y軸ラベルの命名
  ggtitle(&amp;quot;SBP調査&amp;quot;) +  # グラフタイトルの命名
  theme_bw()  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/2015-07-23-r-rmarkdown_files/figure-html/unnamed-chunk-3-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;A市もB市も同じくらいばらついていそうである。&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;箱ひげ図&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;箱ひげ図&lt;/h3&gt;
&lt;p&gt;離散型の変数と連続型の変数の関係をみるために使う。&lt;/p&gt;
&lt;p&gt;箱ひげ図により統計量(平均値、標準偏差)も一緒に図示できる。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(data = study, aes(x = City, y = SBP, colour = City)) +
  geom_boxplot() +   # ここがboxplotに変わっただけ
  geom_jitter() +    # 各点のばらつきを追加する
#  geom_point(size = 3, alpha = 0.5) +
  xlab(&amp;quot;Age&amp;quot;) + 
  ylab(&amp;quot;SBP&amp;quot;) + 
  ggtitle(&amp;quot;SBP調査&amp;quot;) + 
  theme_bw()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/2015-07-23-r-rmarkdown_files/figure-html/unnamed-chunk-4-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;バイオリンプロット&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;バイオリンプロット&lt;/h3&gt;
&lt;p&gt;バイオリンプロットによりデータの分布の密度も可視化することができる。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# バイオリンプロットも描くことができる
ggplot(data = study, aes(x = City, y = SBP, colour = City)) +
  geom_violin() +
  xlab(&amp;quot;Age&amp;quot;) + 
  ylab(&amp;quot;SBP&amp;quot;) + 
  ggtitle(&amp;quot;SBP調査&amp;quot;) + 
  theme_bw()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/2015-07-23-r-rmarkdown_files/figure-html/unnamed-chunk-5-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;ヒストグラム&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;ヒストグラム&lt;/h3&gt;
&lt;p&gt;連続変数などの分布をみる。&lt;/p&gt;
&lt;p&gt;ここでは両方の都市での年齢の分布を示している。&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# ヒストグラム
ggplot(data = study, aes(x = Age)) +
  geom_histogram(binwidth = 2) + # ヒストグラム描きます、階級値は2にしますという宣言
  facet_wrap(~City)  # 群別の図を書くことができる&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/2015-07-23-r-rmarkdown_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;棒グラフ&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;棒グラフ&lt;/h3&gt;
&lt;p&gt;今回のデータでは必要性が乏しいが&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(data = study, aes(x = City, y = SBP, fill = Sex)) +
  geom_bar(stat = &amp;quot;identity&amp;quot;, position = &amp;quot;dodge&amp;quot;) +
  xlab(&amp;quot;Sex&amp;quot;) +
  ylab(&amp;quot;SBP&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/2015-07-23-r-rmarkdown_files/figure-html/unnamed-chunk-7-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>
